const firebaseConfig={apiKey:"AIzaSyD9Lwkgd9NqJ5I0termPqVZxNxFk5Y-J4s",authDomain:"calendario-tareas-app.firebaseapp.com",projectId:"calendario-tareas-app",storageBucket:"calendario-tareas-app.firebasestorage.app",messagingSenderId:"646091363424",appId:"1:646091363424:web:d923bbcc0224bd1bed5f05"};let tasks={},currentDate=new Date,notificationsEnabled=!1,draggedTask=null,draggedFromDate=null,lastDeletedTask=null,lastDeletedDate=null,isOnline=navigator.onLine,currentUser=null,db=null,auth=null,notificationInterval=null,sentNotifications=new Set,notificationStatus={morning:!1,midday:!1,evening:!1,taskReminders:new Set},syncQueue=new Map,syncTimeout=null,isSyncing=!1,lastSyncTime=0;const SYNC_DEBOUNCE_TIME=2e3;let dailyTaskLogs=JSON.parse(localStorage.getItem("dailyTaskLogs")||"{}");const PERMISSIONS_KEY="app_permissions",USER_PREFERENCES_KEY="user_preferences",TASK_STATES={pending:{label:"Pendiente",class:"bg-gray-200 text-gray-800",icon:"fa-clock"},inProgress:{label:"En Proceso",class:"bg-blue-200 text-blue-800",icon:"fa-play"},paused:{label:"Pausada",class:"bg-orange-200 text-orange-800",icon:"fa-pause"},completed:{label:"Completada",class:"bg-green-200 text-green-800",icon:"fa-check"}},PRIORITY_LEVELS={1:{label:"Muy Importante",class:"bg-red-500 text-white",color:"#EF4444"},2:{label:"Importante",class:"bg-orange-400 text-white",color:"#F97316"},3:{label:"Moderado",class:"bg-blue-400 text-white",color:"#3B82F6"},4:{label:"No Prioritario",class:"bg-gray-400 text-white",color:"#6B7280"}};let deferredPrompt,installButtonShown=!1;function handleInstallClick(){if(!deferredPrompt)return;const e=document.getElementById("install-button");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Instalando...'),deferredPrompt.prompt(),deferredPrompt.userChoice.then((t=>{"accepted"===t.outcome?e&&(e.style.display="none",e.classList.add("hidden")):e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-download mr-2"></i>Instalar App'),deferredPrompt=null}))}"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/sw.js").then((e=>{})).catch((e=>{}))})),window.addEventListener("beforeinstallprompt",(e=>{if(isPWAInstalled())return;e.preventDefault(),deferredPrompt=e;const t=document.getElementById("install-button");t&&!installButtonShown&&(t.style.display="block",t.classList.remove("hidden"),installButtonShown=!0,t.addEventListener("click",handleInstallClick))}));let selectedDateForPanel=getTodayString();function showDesktopNotificationPWA(e,t,n,a=!1,s="default"){if(!notificationsEnabled||"granted"!==Notification.permission)return showInAppNotification(e,t,"info"),!1;if(n&&sentNotifications.has(n))return!1;const i={body:t,icon:"/images/IconLogo.png",badge:"/images/favicon-192.png",tag:n||`notification-${Date.now()}`,renotify:!0,requireInteraction:a,silent:!1,vibrate:getVibrationPattern(s),data:{timestamp:Date.now(),tag:n,requiresAction:a,type:s}};try{if((window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone)&&"serviceWorker"in navigator&&navigator.serviceWorker.controller)navigator.serviceWorker.controller.postMessage({type:"SHOW_NOTIFICATION",title:e,body:t,tag:n,requiresAction:a,notificationType:s});else{const t=new Notification(e,i);t.onclick=()=>{if(window.focus(),t.close(),n&&n.includes("-now")){showDailyTaskPanel(getTodayString(),(new Date).getDate())}},a||setTimeout((()=>t.close()),8e3)}return n&&sentNotifications.add(n),"vibrate"in navigator&&navigator.vibrate(getVibrationPattern(s)),!0}catch(n){return showInAppNotification(e,t,"info"),!1}}function getVibrationPattern(e){const t={default:[200,100,200],"task-reminder":[300,100,300],"task-start":[200,50,200,50,400],"task-late":[100,100,100,100,100],success:[200,100,200],morning:[300,200,300],midday:[200,100,200],evening:[400,200,400]};return t[e]||t.default}function showInAppNotification(e,t,n="info"){const a=document.createElement("div");a.className=`fixed top-20 right-4 ${{task:"bg-blue-500",success:"bg-green-500",warning:"bg-orange-500",info:"bg-gray-600"}[n]} text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full max-w-sm`,a.innerHTML=`\n    <div class="flex items-start space-x-3">\n      <i class="fas ${{task:"fa-tasks",success:"fa-check-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"}[n]} mt-1 flex-shrink-0"></i>\n      <div class="flex-1">\n        <div class="font-semibold text-sm">${e}</div>\n        <div class="text-xs opacity-90 mt-1">${t}</div>\n      </div>\n      <button onclick="this.parentElement.parentElement.remove()" \n              class="text-white hover:text-gray-200 ml-2 flex-shrink-0">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `,document.body.appendChild(a),setTimeout((()=>a.classList.remove("translate-x-full")),100),setTimeout((()=>{a.classList.add("translate-x-full"),setTimeout((()=>a.remove()),300)}),5e3)}function isPWAInstalled(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||document.referrer.includes("android-app://")}function addToChangeLog(e,t,n,a=null,s=null,i=null){const o=new Date,r={id:Date.now().toString(),action:e,taskTitle:t,taskId:i,oldState:a,newState:s,timestamp:o.toISOString(),time:o.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),date:n,readableDate:new Date(n+"T12:00:00").toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"})};dailyTaskLogs[n]||(dailyTaskLogs[n]=[]),dailyTaskLogs[n].unshift(r),dailyTaskLogs[n].length>50&&(dailyTaskLogs[n]=dailyTaskLogs[n].slice(0,50)),"stateChanged"===e&&"completed"===s&&i&&calculateTaskDuration(n,i,t),localStorage.setItem("dailyTaskLogs",JSON.stringify(dailyTaskLogs))}function calculateTaskDuration(e,t,n){const a=dailyTaskLogs[e]||[],s=a.find((e=>e.taskId===t&&"stateChanged"===e.action&&"completed"===e.newState)),i=a.slice().reverse().find((e=>e.taskId===t&&"stateChanged"===e.action&&"inProgress"===e.newState));if(s&&i&&!s.duration){const e=new Date(i.timestamp),t=new Date(s.timestamp)-e;if(t>0){const e=Math.floor(t/36e5),n=Math.floor(t%36e5/6e4);let a="";a=e>0?`${e}h ${n}min`:`${n}min`,s.duration=a,s.durationMs=t,localStorage.setItem("dailyTaskLogs",JSON.stringify(dailyTaskLogs))}}}function showDayChangeLog(e){const t=dailyTaskLogs[e]||[],n=new Date(e+"T12:00:00"),a=document.createElement("div");a.id="dayChangeLogModal",a.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",a.innerHTML=`\n        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">\n            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">\n                <h3 class="text-lg font-semibold text-gray-800">\n                    <i class="fas fa-history text-blue-500 mr-2"></i>\n                    Registro de actividad del ${n.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}\n                </h3>\n                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <div class="p-6 overflow-y-auto max-h-96">\n                ${0===t.length?'\n                    <div class="text-center py-8 text-gray-500">\n                        <i class="fas fa-clipboard-list text-4xl mb-3 opacity-50"></i>\n                        <p>No hay registros para este día</p>\n                    </div>\n                ':`\n                    <div class="space-y-3">\n                        ${t.map((e=>`\n                            <div class="bg-gray-50 rounded-lg p-4 border-l-4 ${getDayLogColor(e.action)}">\n                                <div class="flex justify-between items-start">\n                                    <div class="flex-1">\n                                        <div class="font-medium text-sm text-gray-800">\n                                            ${getDayLogIcon(e.action)} ${getDayLogMessage(e)}\n                                        </div>\n                                        <div class="text-xs text-gray-500 mt-1 flex items-center space-x-3">\n                                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-mono">\n                                                ${e.time}\n                                            </span>\n                                            ${e.taskId?`<span class="text-gray-400">ID: ${e.taskId.substring(0,8)}...</span>`:""}\n                                        </div>\n                                        ${getStateChangeInfo(e)}\n                                        ${e.duration?`\n                                            <div class="mt-2 bg-green-100 text-green-800 px-2 py-1 rounded text-xs inline-block">\n                                                <i class="fas fa-stopwatch mr-1"></i>\n                                                Tiempo total: ${e.duration}\n                                            </div>\n                                        `:""}\n                                    </div>\n                                </div>\n                            </div>\n                        `)).join("")}\n                    </div>\n                `}\n                <div class="mt-6 flex justify-end space-x-3">\n                    ${t.length>0?`\n                        <button onclick="clearDayChangeLog('${e}')" \n                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">\n                            <i class="fas fa-trash mr-2"></i>Limpiar Registro\n                        </button>\n                    `:""}\n                    <button onclick="closeAllModals()" \n                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">\n                        Cerrar\n                    </button>\n                </div>\n            </div>\n        </div>\n    `,document.body.appendChild(a)}function getDayLogColor(e){return{created:"border-green-500",stateChanged:"border-blue-500",paused:"border-orange-500",resumed:"border-blue-500",edited:"border-yellow-500",deleted:"border-red-500",moved:"border-purple-500"}[e]||"border-gray-500"}function getDayLogIcon(e){return{created:'<i class="fas fa-plus text-green-600"></i>',stateChanged:'<i class="fas fa-sync-alt text-blue-600"></i>',paused:'<i class="fas fa-pause text-orange-600"></i>',resumed:'<i class="fas fa-play text-blue-600"></i>',edited:'<i class="fas fa-edit text-yellow-600"></i>',deleted:'<i class="fas fa-trash text-red-600"></i>',moved:'<i class="fas fa-arrows-alt text-purple-600"></i>'}[e]||'<i class="fas fa-info text-gray-600"></i>'}function getDayLogMessage(e){return{created:`Tarea creada: "${e.taskTitle}"`,stateChanged:`"${e.taskTitle}": cambio de estado`,paused:`"${e.taskTitle}": pausada temporalmente`,resumed:`"${e.taskTitle}": reanudada`,edited:`Tarea editada: "${e.taskTitle}"`,deleted:`Tarea eliminada: "${e.taskTitle}"`,moved:`Tarea movida: "${e.taskTitle}"`}[e.action]||`Cambio en: "${e.taskTitle}"`}function getStateChangeInfo(e){if(("stateChanged"===e.action||"paused"===e.action||"resumed"===e.action)&&e.oldState&&e.newState){const t={pending:"Pendiente",inProgress:"En Proceso",paused:"Pausada",completed:"Completada"};return`\n            <div class="text-xs text-blue-600 mt-1 bg-blue-50 px-2 py-1 rounded">\n                ${t[e.oldState]||e.oldState} → ${t[e.newState]||e.newState}\n            </div>\n        `}return""}function clearDayChangeLog(e){if(dailyTaskLogs[e]&&0!==dailyTaskLogs[e].length){if(confirm("¿Eliminar todos los registros de cambios de este día?")){if(delete dailyTaskLogs[e],saveTaskLogs(),selectedDateForPanel===e){const t=new Date(e+"T12:00:00"),n=tasks[e]||[];updatePanelDateHeader(e,t.getDate(),n)}showNotification("Registros de cambios eliminados","success"),closeAllModals()}}else showNotification("No hay registros para eliminar","info")}function enqueueSync(e,t,n){if(!n||!n.id)return;if(!currentUser||!isOnline)return;const a=`${e}-${t}-${n.id}`,s=Date.now(),i=syncQueue.get(a);if(i&&s-i.timestamp<2e3)return;for(const[e,t]of syncQueue)s-t.timestamp>6e5&&syncQueue.delete(e);syncQueue.set(a,{operation:e,dateStr:t,task:{...n},timestamp:s,attempts:0}),updateSyncIndicator("pending");const o=isPWAInstalled()?window.PWA_SYNC_DEBOUNCE_TIME||1e3:2e3;syncTimeout&&clearTimeout(syncTimeout),syncTimeout=setTimeout((()=>{syncQueue.size>0&&!isSyncing&&currentUser&&isOnline&&processSyncQueue()}),o)}async function processSyncQueue(){if(currentUser)if(isOnline)if(db){if(!isSyncing)if(0!==syncQueue.size){isSyncing=!0,updateSyncIndicator("syncing");try{const e=Array.from(syncQueue.values()),t=db.collection("users").doc(currentUser.uid).collection("tasks"),n=150;let a=0;for(let s=0;s<e.length;s+=n){const i=db.batch(),o=e.slice(s,s+n);for(const e of o){const n=`${e.dateStr}_${e.task?.id}`,s=t.doc(n);switch(e.operation){case"upsert":e.task&&(i.set(s,{...e.task,date:e.dateStr,lastModified:new Date},{merge:!0}),a++);break;case"delete":i.delete(s),a++;break}}a>0&&await i.commit()}syncQueue.clear(),lastSyncTime=Date.now(),updateSyncIndicator("success"),a>=3&&showNotification(`${a} cambios sincronizados`,"success")}catch(e){"permission-denied"===e.code?(showNotification("Error de permisos en Firebase","error"),updateSyncIndicator("error")):"unavailable"===e.code?(showNotification("Firebase temporalmente no disponible","error"),updateSyncIndicator("pending"),setTimeout((()=>{syncQueue.size>0&&processSyncQueue()}),1e4)):(updateSyncIndicator("error"),showNotification("Error de sincronización: "+e.message,"error"))}finally{isSyncing=!1}}else updateSyncIndicator("success")}else updateSyncIndicator("error");else updateSyncIndicator("offline");else updateSyncIndicator("offline")}async function syncToFirebase(){if(!currentUser||!isOnline)return void showNotification("No hay conexión disponible","error");if(isSyncing)return void showNotification("Sincronización en progreso...","info");const e=document.getElementById("syncBtn"),t=e?e.innerHTML:"";try{e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando...'),syncQueue.size>0&&await processSyncQueue(),isSyncing=!0,updateSyncIndicator("syncing");const n=db.collection("users").doc(currentUser.uid).collection("tasks"),a=[];if(Object.entries(tasks).forEach((([e,t])=>{t.forEach((t=>{a.push({...t,date:e,lastModified:new Date})}))})),a.length>0){const e=db.batch();a.forEach((t=>{const a=n.doc(`${t.date}_${t.id}`);e.set(a,t,{merge:!0})})),await e.commit()}const s=await n.get();let i=0;if(!s.empty){const e={};s.forEach((t=>{const n=t.data(),a=n.date;e[a]||(e[a]=[]),e[a].push({id:n.id,title:n.title,description:n.description||"",time:n.time||"",completed:n.completed||!1})})),Object.keys(e).forEach((t=>{tasks[t]||(tasks[t]=[]),e[t].forEach((e=>{tasks[t].some((t=>t.id===e.id||t.title===e.title&&t.time===e.time))||(tasks[t].push(e),i++)}))})),i>0&&(saveTasks(),renderCalendar(),updateProgress())}updateSyncIndicator("success");showNotification(a.length+i>0?`Sincronización completa: ${a.length} subidas, ${i} descargadas`:"Todo está sincronizado","success"),notificationsEnabled&&"granted"===Notification.permission&&(stopNotificationService(),setTimeout((()=>startNotificationService()),1e3))}catch(e){updateSyncIndicator("error"),showNotification("Error en sincronización: "+e.message,"error")}finally{isSyncing=!1,e&&(e.disabled=!1,e.innerHTML=t||'<i class="fas fa-sync-alt mr-2"></i>Sincronizar')}}function exportToExcelOffline(){if("undefined"==typeof XLSX)return void showNotification("Funcionalidad de exportación no disponible sin conexión","error");const e=XLSX.utils.book_new(),t=[["Fecha","Título","Descripción","Hora","Estado","Prioridad"]];Object.entries(tasks).forEach((([e,n])=>{n.forEach((n=>{const a=PRIORITY_LEVELS[n.priority]||PRIORITY_LEVELS[3],s=TASK_STATES[n.state]||TASK_STATES.pending;t.push([e,n.title,n.description||"",n.time||"",s.label,a.label])}))}));const n=XLSX.utils.aoa_to_sheet(t);XLSX.utils.book_append_sheet(e,n,"Tareas");const a=`tareas_offline_${getTodayString()}.xlsx`;XLSX.writeFile(e,a),showNotification(`Excel exportado: ${a}`,"success")}function getTodayString(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}function isDatePast(e){const t=new Date,n=new Date(e+"T00:00:00");return t.setHours(0,0,0,0),n.setHours(0,0,0,0),n<t}function setupDateInput(){const e=document.getElementById("taskDate"),t=document.getElementById("taskTime");if(e){const t=getTodayString();e.setAttribute("min",t),e.value=t}if(t){const e=new Date,n=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0");t.value=`${n}:${a}`}}function initFirebase(){try{if(!navigator.onLine)return void initOfflineMode();firebase.apps.length||firebase.initializeApp(firebaseConfig),db=firebase.firestore(),auth=firebase.auth(),setupFirebasePersistence().then((()=>{const e="true"===localStorage.getItem("firebase_auth_active");auth.onAuthStateChanged((t=>{currentUser=t,updateUI(),t&&navigator.onLine?("serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"SET_USER_ID",data:{userId:t.uid,email:t.email}}),setTimeout((()=>{navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"CHECK_NOTIFICATIONS_NOW"})}),2e3),updateSyncIndicator("success"),setTimeout((()=>{isOnline&&!isSyncing&&syncFromFirebase()}),1e3)):t||(e?setTimeout((()=>{auth.currentUser||localStorage.removeItem("firebase_auth_active")}),2e3):(localStorage.removeItem("firebase_auth_active"),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"LOGOUT"}),updateSyncIndicator("offline"),cleanupUIOnLogout()))}))})),hideLoadingScreen()}catch(e){showNotification("Error conectando con el servidor","error"),initOfflineMode()}}async function registerPeriodicSync(){if("serviceWorker"in navigator&&"periodicSync"in navigator.serviceWorker)try{const e=await navigator.serviceWorker.ready;await e.periodicSync.register("check-tasks",{minInterval:18e5})}catch(e){}}async function setupFirebasePersistence(){try{await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL),await db.enablePersistence({synchronizeTabs:!0,experimentalTabSynchronization:!0}),localStorage.setItem("firebase_auth_active","true")}catch(e){"failed-precondition"===e.code||e.code}}function configurePWAFirebase(){db&&db.settings({cacheSizeBytes:firebase.firestore.CACHE_SIZE_UNLIMITED,experimentalForceLongPolling:!1}),setupPWAReconnection(),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((e=>{"sync"in window.ServiceWorkerRegistration.prototype&&e.sync.register("firebase-sync").then((()=>{})).catch((e=>{}))}))}function setupPWAReconnection(){let e=0;const t=()=>{e>=5||navigator.onLine&&currentUser&&(e++,db.collection("test").limit(1).get().then((()=>{e=0,updateSyncIndicator("success"),syncQueue.size>0&&setTimeout((()=>processSyncQueue()),500)})).catch((n=>{e<5&&setTimeout(t,2e3*e)})))};window.addEventListener("online",(()=>{e=0,setTimeout(t,1e3)})),window.addEventListener("firebase-connection-lost",t)}function initOfflineMode(){isOnline=!1,currentUser=getOfflineUser();const e=document.getElementById("firebaseStatus");e&&e.classList.add("force-hidden"),updateUI(),hideLoadingScreen(),showOfflineModeMessage(),setupOfflineFeatures()}function showOfflineModeMessage(){const e=document.createElement("div");e.id="offlineModeMessage",e.className="fixed bottom-4 right-4 bg-gray-800 text-white text-sm px-4 py-2 rounded-lg shadow-lg z-30 transition-all duration-300",e.innerHTML='\n    <div class="flex items-center space-x-2">\n      <i class="fas fa-hard-drive text-yellow-400"></i>\n      <span>Modo local activo</span>\n      <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-300 hover:text-white">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  ',document.body.appendChild(e),setTimeout((()=>{document.getElementById("offlineModeMessage")&&e.remove()}),5e3)}function getOfflineUser(){let e=localStorage.getItem("offlineUser");return e?e=JSON.parse(e):(e={uid:"offline-"+Date.now(),displayName:"Usuario Offline",email:"usuario@offline.local",photoURL:null,isOffline:!0},localStorage.setItem("offlineUser",JSON.stringify(e))),e}function setupOfflineFeatures(){notificationInterval&&clearInterval(notificationInterval),updateOfflineUI()}function shouldShowSyncIndicators(){return currentUser&&!currentUser.isOffline&&isOnline}function updateOfflineUI(){[{id:"loginBtn",text:"Sin conexión para login"},{id:"logoutBtn",text:"Logout offline"}].forEach((({id:e,text:t})=>{const n=document.getElementById(e);n&&(n.title=t,isOnline?n.classList.remove("opacity-50"):n.classList.add("opacity-50"))}))}function showOfflineMessage(){const e=document.createElement("div");e.id="offlineMessage",e.className="fixed top-16 left-4 right-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 rounded-lg shadow-lg z-40",e.innerHTML='\n    <div class="flex items-start">\n      <div class="flex-shrink-0">\n        <i class="fas fa-wifi-slash text-orange-500"></i>\n      </div>\n      <div class="ml-3 flex-1">\n        <p class="text-sm font-medium">\n          Modo Sin Conexión Activo\n        </p>\n        <p class="text-xs mt-1">\n          • Tus tareas se guardan localmente<br>\n          • Se sincronizarán cuando vuelva la conexión<br>\n          • Funcionalidad limitada disponible\n        </p>\n        <div class="mt-2 flex items-center space-x-2 text-xs">\n          <span class="flex items-center">\n            <i class="fas fa-check text-green-600 mr-1"></i>\n            Crear/editar tareas\n          </span>\n          <span class="flex items-center">\n            <i class="fas fa-times text-red-600 mr-1"></i>\n            Sync en tiempo real\n          </span>\n        </div>\n      </div>\n      <button onclick="hideOfflineMessage()" class="flex-shrink-0 ml-4 text-orange-400 hover:text-orange-600">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  ';const t=document.getElementById("offlineMessage");t&&t.remove(),document.body.appendChild(e),setTimeout((()=>{document.getElementById("offlineMessage")&&hideOfflineMessage()}),1e4)}function hideOfflineMessage(){const e=document.getElementById("offlineMessage");e&&e.remove()}function savePermissions(){const e={notifications:{permission:Notification.permission,enabled:notificationsEnabled,timestamp:Date.now()}};try{localStorage.setItem(PERMISSIONS_KEY,JSON.stringify(e))}catch(e){}}function loadPermissions(){try{const e=localStorage.getItem(PERMISSIONS_KEY);if(e){const t=JSON.parse(e);if("granted"===Notification.permission&&"granted"===t.notifications?.permission)return notificationsEnabled=!1!==t.notifications.enabled,!0}"granted"===Notification.permission&&(notificationsEnabled=!0,savePermissions())}catch(e){notificationsEnabled="granted"===Notification.permission}return!1}function initNotifications(){if("Notification"in window){if("granted"===Notification.permission)void 0===notificationsEnabled&&(notificationsEnabled=!0),updateNotificationButton(),notificationsEnabled&&startNotificationService();else if("default"===Notification.permission){(window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone)&&setTimeout((()=>{requestNotificationPermissionWithVibration()}),2e3)}updateNotificationButton()}}function setupNetworkListeners(){window.addEventListener("online",handleOnline),window.addEventListener("offline",handleOffline),document.addEventListener("visibilitychange",(()=>{!document.hidden&&notificationsEnabled&&"granted"===Notification.permission&&(checkDailyTasksImproved(!0),sendTasksToServiceWorker())})),setInterval((()=>{const e=navigator.onLine;e!==isOnline&&(e?handleOnline():handleOffline())}),3e4)}function handleOnline(){if(isOnline=!0,hideOfflineMessage(),currentUser&&currentUser.isOffline)initFirebase();else if(currentUser){updateSyncIndicator("success"),updateOfflineUI();const e=isPWAInstalled()?500:1e3;setTimeout((()=>{syncQueue.size>0?processSyncQueue().then((()=>{setTimeout(syncFromFirebase,1e3)})):syncFromFirebase()}),e),isPWAInstalled()?showDesktopNotificationPWA("Conexión restaurada","Sincronizando tareas...","connection-restored"):showNotification("Conexión restaurada. Sincronizando...","success")}}function handleOffline(){isOnline=!1,updateOfflineUI(),currentUser&&!currentUser.isOffline&&(updateSyncIndicator("offline"),showOfflineMessage(),showNotification("Trabajando sin conexión. Los cambios se sincronizarán cuando vuelva internet.","info"))}function handleServiceWorkerMessages(){"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",(e=>{const{type:t,data:n}=e.data;switch(t){case"NOTIFICATION_CLICKED":if(window.focus(),n.taskId){showDailyTaskPanel(getTodayString(),(new Date).getDate())}break;case"SYNC_REQUIRED":currentUser&&isOnline&&processSyncQueue();break}}))}function cleanupUIOnLogout(){const e=document.getElementById("firebaseStatus");e&&e.classList.add("hidden","force-hidden");document.querySelectorAll(".notification").forEach((e=>{const t=e.textContent.toLowerCase();(t.includes("sincroniz")||t.includes("firebase")||t.includes("conexión"))&&e.remove()})),syncTimeout&&(clearTimeout(syncTimeout),syncTimeout=null)}function updateSyncIndicator(e){const t=document.getElementById("firebaseStatus"),n=document.getElementById("statusIcon"),a=document.getElementById("statusText");if(!currentUser||currentUser.isOffline||!t||!n||!a)return void(t&&t.classList.add("hidden"));if(t.classList.contains("force-hidden"))return;const s=syncQueue.size,i={success:{class:"bg-green-500 text-white",icon:"fa-check-circle",text:s>0?`${s} pendientes`:"Sincronizado",autoHide:0===s},error:{class:"bg-red-500 text-white",icon:"fa-exclamation-triangle",text:"Error de sincronización",autoHide:!1},syncing:{class:"bg-blue-500 text-white",icon:"fa-sync-alt fa-spin",text:"Sincronizando...",autoHide:!1},pending:{class:"bg-orange-500 text-white",icon:"fa-clock",text:`${s} cambios pendientes`,autoHide:!1}},o=i[e]||i.success;t.className=`fixed top-4 left-4 px-3 py-2 rounded-lg text-sm font-medium z-40 transition-all duration-300 ${o.class}`,n.className=`fas ${o.icon} mr-2`,a.textContent=o.text,t.classList.remove("hidden"),o.autoHide&&setTimeout((()=>{0===syncQueue.size&&a.textContent===o.text&&t.classList.add("hidden")}),3e3)}function hideLoadingScreen(){const e=document.getElementById("loadingScreen");e.style.opacity="0",setTimeout((()=>{e.style.display="none"}),300)}function updateUI(){const e=document.getElementById("loginBtn"),t=document.getElementById("userInfo"),n=document.getElementById("syncBtn"),a=document.getElementById("firebaseStatus"),s=document.getElementById("install-button");if(currentUser&&!currentUser.isOffline){if(e&&(e.classList.add("hidden"),e.className=e.className.replace(/bg-\w+-\d+/g,""),e.className+=" bg-blue-600 hover:bg-blue-700"),t){t.classList.remove("hidden");const e=document.getElementById("userName"),n=document.getElementById("userEmail"),a=document.getElementById("userPhoto");e&&(e.textContent=currentUser.displayName||"Usuario"),n&&(n.textContent=currentUser.email||""),a&&(a.src=currentUser.photoURL||"https://via.placeholder.com/32",a.onerror=()=>a.src="https://via.placeholder.com/32")}n&&(n.classList.remove("hidden"),n.disabled=!1),a&&a.classList.remove("force-hidden")}else e&&(e.classList.remove("hidden"),e.className=e.className.replace(/bg-\w+-\d+/g,"").replace(/text-\w+-\d+/g,""),e.className+=" bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200"),t&&t.classList.add("hidden"),n&&n.classList.add("hidden"),a&&a.classList.add("force-hidden");s&&(isPWAInstalled()?(s.style.display="none",s.classList.add("hidden")):deferredPrompt&&!installButtonShown&&(s.style.display="block",s.classList.remove("hidden")))}async function signInWithGoogle(){try{const e=document.getElementById("loginBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Conectando...');const t=new firebase.auth.GoogleAuthProvider;t.addScope("profile"),t.addScope("email"),t.setCustomParameters({prompt:"select_account"});(await auth.signInWithPopup(t)).user&&(showNotification("Sesión iniciada correctamente","success"),closeLoginModal())}catch(e){let t="Error al iniciar sesión";switch(e.code){case"auth/popup-closed-by-user":t="Ventana de login cerrada";break;case"auth/network-request-failed":t="Error de conexión";break;case"auth/too-many-requests":t="Demasiados intentos. Intenta más tarde";break;default:t=`Error: ${e.message}`}showNotification(t,"error")}finally{const e=document.getElementById("loginBtn");e&&(e.disabled=!1,e.innerHTML='<i class="fab fa-google mr-2"></i>Iniciar Sesión')}}function signOut(){confirm("¿Estás seguro de que quieres cerrar sesión?")&&(localStorage.removeItem("firebase_auth_active"),cleanupUIOnLogout(),auth.signOut().then((()=>{showNotification("Sesión cerrada","info")})).catch((e=>{})))}async function syncFromFirebase(){if(currentUser&&isOnline&&!isSyncing){isSyncing=!0,updateSyncIndicator("syncing");try{const e=db.collection("users").doc(currentUser.uid).collection("tasks"),t=await e.get();if(t.empty)return void updateSyncIndicator("success");const n={},a=new Set;t.forEach((e=>{const t=e.data(),s=t.date;n[s]||(n[s]=[]);const i={id:t.id,title:t.title,description:t.description||"",time:t.time||"",completed:t.completed||!1,state:t.state||"pending",priority:t.priority||3};n[s].push(i),a.add(t.id)}));let s=0,i=0;if(Object.keys(n).forEach((e=>{tasks[e]||(tasks[e]=[]),n[e].forEach((t=>{const n=tasks[e].findIndex((e=>e.id===t.id));if(-1===n){tasks[e].find((e=>e.title===t.title&&e.time===t.time&&Math.abs(new Date(e.id.split("-")[0])-new Date(t.id.split("-")[0]))<5e3))||(tasks[e].push(t),s++)}else{const a=tasks[e][n];JSON.stringify(a)!==JSON.stringify(t)&&(tasks[e][n]={...a,...t},i++)}}))})),s>0||i>0){saveTasks(),renderCalendar(),updateProgress();const e=[];s>0&&e.push(`${s} nuevas`),i>0&&e.push(`${i} actualizadas`),showNotification(`Tareas sincronizadas: ${e.join(", ")}`,"success")}updateSyncIndicator("success"),notificationsEnabled&&"granted"===Notification.permission&&(stopNotificationService(),setTimeout(startNotificationService,1e3))}catch(e){updateSyncIndicator("error"),showNotification("Error al sincronizar","error")}finally{isSyncing=!1}}}function forceSyncNow(){syncTimeout&&(clearTimeout(syncTimeout),syncTimeout=null),processSyncQueue()}function setupEventListeners(){if("loading"===document.readyState)return void document.addEventListener("DOMContentLoaded",setupEventListeners);const e={taskForm:addTask,prevMonth:()=>changeMonth(-1),nextMonth:()=>changeMonth(1),taskRepeat:toggleCustomDays,clearWeekBtn:clearWeek,clearMonthBtn:clearMonth,exportExcelBtn:exportToExcel,notificationsBtn:toggleNotifications,syncBtn:syncToFirebase,loginBtn:showLoginModal,logoutBtn:signOut,googleSignInBtn:signInWithGoogle,closeLoginModal:closeLoginModal,resetFormBtn:resetForm,clearAllBtn:clearAll};Object.entries(e).forEach((([e,t])=>{const n=document.getElementById(e);n&&n.addEventListener("FORM"===n.tagName?"submit":"click",t)}));const t=document.getElementById("closePanelBtn"),n=document.getElementById("addQuickTaskBtn");t&&t.addEventListener("click",closeDailyTaskPanel),n&&n.addEventListener("click",addQuickTaskToSelectedDay);const a=document.getElementById("repeatDuration"),s=document.querySelectorAll('#customDays input[type="checkbox"]'),i=document.getElementById("taskDate");a&&a.addEventListener("change",updateRepeatPreview),i&&i.addEventListener("change",updateRepeatPreview),s.forEach((e=>{e.addEventListener("change",updateRepeatPreview)}))}function configurePWAFeatures(){document.addEventListener("gesturestart",(e=>e.preventDefault())),document.addEventListener("gesturechange",(e=>e.preventDefault())),document.addEventListener("gestureend",(e=>e.preventDefault())),document.body.style.overscrollBehavior="contain";const e=document.querySelector('meta[name="viewport"]');e&&isPWAInstalled()&&(e.content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"),syncTimeout&&clearTimeout(syncTimeout);window.PWA_SYNC_DEBOUNCE_TIME=1e3}function initializeTodayPanel(){const e=getTodayString(),t=new Date;selectedDateForPanel=e;const n=tasks[e]||[],a=window.innerWidth>=768,s=window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone||window.location.search.includes("pwa=true");(a&&!s||n.some((e=>"completed"!==e.state)))&&showDailyTaskPanel(e,t.getDate())}function resetForm(){const e=document.getElementById("taskForm"),t=document.getElementById("advancedRepeatConfig"),n=document.getElementById("customDays"),a=document.getElementById("repeatDuration");e.reset(),t?.classList.add("hidden"),n?.classList.add("hidden"),a&&(a.value="2");document.querySelectorAll('#customDays input[type="checkbox"]').forEach((e=>{e.checked=!1})),setupDateInput(),showNotification("Formulario reiniciado","info");const s=document.getElementById("taskTime");s&&(s.addEventListener("change",(()=>{setTimeout((()=>{s.blur()}),100)})),s.addEventListener("keydown",(e=>{"Enter"===e.key&&s.blur()}))),document.addEventListener("change",(e=>{"time"===e.target.type&&setTimeout((()=>{e.target.blur()}),100)})),document.addEventListener("keydown",(e=>{"time"===e.target.type&&"Enter"===e.key&&e.target.blur()}))}function showLoginModal(){const e=document.getElementById("loginModal");if(e)e.classList.remove("hidden");else{document.querySelector(".fixed.inset-0.bg-black");showNotification("Error: Modal de login no disponible","error")}}function closeLoginModal(){document.getElementById("loginModal").classList.add("hidden")}function loadTasks(){try{const e=localStorage.getItem("tasks");tasks=e?JSON.parse(e):{},loadTaskLogs()}catch(e){tasks={},dailyTaskLogs={}}}function toggleCustomDays(){const e=document.getElementById("taskRepeat"),t=document.getElementById("advancedRepeatConfig"),n=document.getElementById("customDays");"none"===e.value?t?.classList.add("hidden"):(t?.classList.remove("hidden"),n?.classList.toggle("hidden","custom"!==e.value),updateRepeatPreview())}function updateRepeatPreview(){const e=document.getElementById("taskRepeat").value,t=document.getElementById("repeatDuration").value,n=document.getElementById("previewText"),a=document.getElementById("taskDate").value;if(!n||"none"===e)return;const s={1:"lo que resta del mes actual",2:"lo que resta del mes actual y todo el mes siguiente",3:"los próximos 3 meses",6:"los próximos 6 meses",12:"el próximo año"};let i=`Se creará ${{daily:"todos los días",weekdays:"días de semana (Lun-Vie)",weekends:"fines de semana (Sáb-Dom)",weekly:"cada semana (mismo día)",custom:"días personalizados"}[e]} durante ${s[t]}`;if("custom"===e){const e=Array.from(document.querySelectorAll("#customDays input:checked"));if(e.length>0){const n=["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"];i=`Se creará los ${e.map((e=>n[parseInt(e.value)])).join(", ")} durante ${s[t]}`}else i="Selecciona al menos un día"}const o=calculateExactTaskCount(e,parseInt(t),a);o>0&&(i+=` (~${o} tareas)`),n.textContent=i}function calculateExactTaskCount(e,t,n){const a=n?new Date(n+"T00:00:00"):new Date;let s;1===t?s=new Date(a.getFullYear(),a.getMonth()+1,0):(s=new Date(a),s.setMonth(s.getMonth()+t),s=new Date(s.getFullYear(),s.getMonth(),0));let i=0,o=new Date(a),r=[];if("custom"===e&&(r=Array.from(document.querySelectorAll("#customDays input:checked")).map((e=>parseInt(e.value))),0===r.length))return 0;for(;o<=s;){const t=o.getDay();let n=!1;switch(e){case"daily":n=!0;break;case"weekdays":n=t>=1&&t<=5;break;case"weekends":n=0===t||6===t;break;case"weekly":n=t===a.getDay();break;case"custom":n=r.includes(t);break}const s=o.toISOString().split("T")[0];n&&!isDatePast(s)&&i++,o.setDate(o.getDate()+1)}return i}function addTask(e){e.preventDefault();const t={title:document.getElementById("taskTitle").value.trim(),description:document.getElementById("taskDescription").value.trim(),date:document.getElementById("taskDate").value,time:document.getElementById("taskTime").value,repeat:document.getElementById("taskRepeat").value,priority:parseInt(document.getElementById("taskPriority").value)||3,initialState:"pending"};if(!t.title)return;if(t.date&&isDatePast(t.date))return void showNotification("No puedes agregar tareas a fechas anteriores. Por favor selecciona hoy o una fecha futura.","error");const n={id:Date.now().toString(),title:t.title,description:t.description,time:t.time,priority:t.priority,state:"pending",completed:!1};if(t.date&&"none"===t.repeat)addTaskToDate(t.date,n),enqueueSync("upsert",t.date,n),addToChangeLog("created",n.title,t.date);else if("none"!==t.repeat){const e=t.date?new Date(t.date+"T00:00:00"):new Date;addRecurringTasks(n,t.repeat,e)}saveTasks(),renderCalendar(),updateProgress(),document.getElementById("taskForm").reset(),setupDateInput(),showNotification("Tarea agregada exitosamente");const a=document.getElementById("advancedRepeatConfig"),s=document.getElementById("customDays"),i=document.getElementById("repeatDuration");a?.classList.add("hidden"),s?.classList.add("hidden"),i&&(i.value="2");const o=document.getElementById("taskPriority");o&&(o.value="3")}function addTaskToDate(e,t){tasks[e]||(tasks[e]=[]);const n={...t,id:`${e}-${Date.now()}`,state:"pending",completed:!1};if(tasks[e].push(n),selectedDateForPanel===e){showDailyTaskPanel(e,new Date(e+"T12:00:00").getDate())}return n}function addRecurringTasks(e,t,n){const a=document.getElementById("repeatDuration"),s=a?parseInt(a.value):2;let i,o=new Date(n),r=0;1===s?i=new Date(n.getFullYear(),n.getMonth()+1,0):(i=new Date(n),i.setMonth(i.getMonth()+s),i=new Date(i.getFullYear(),i.getMonth(),0));let l=[];"custom"===t&&(l=Array.from(document.querySelectorAll("#customDays input:checked")).map((e=>parseInt(e.value))));const c=[];for(;o<=i;){const a=o.toISOString().split("T")[0],s=o.getDay();let i=!1;switch(t){case"daily":i=!0;break;case"weekdays":i=s>=1&&s<=5;break;case"weekends":i=0===s||6===s;break;case"weekly":i=s===n.getDay();break;case"custom":i=l.includes(s)&&l.length>0;break}if(i&&!isDatePast(a)){const t=addTaskToDate(a,{...e,state:"pending",completed:!1});c.push({dateStr:a,task:t}),r++}o.setDate(o.getDate()+1)}c.forEach((({dateStr:e,task:t})=>{enqueueSync("upsert",e,t)}));showNotification(`${r} tareas agregadas para ${{1:"lo que resta del mes actual",2:"lo que resta del mes actual y todo el mes siguiente",3:"los próximos 3 meses",6:"los próximos 6 meses",12:"el próximo año"}[s.toString()]||`${s} meses`}`,"success")}function renderCalendar(){const e=document.getElementById("calendar"),t=document.getElementById("currentMonth");if(!e||!t)return;e.innerHTML="",t.textContent=currentDate.toLocaleDateString("es-ES",{month:"long",year:"numeric"}).replace(/^\w/,(e=>e.toUpperCase()));["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"].forEach((t=>{const n=document.createElement("div");n.className="text-center font-semibold text-gray-600 py-2",n.textContent=t,e.appendChild(n)}));const n=new Date(currentDate.getFullYear(),currentDate.getMonth(),1),a=new Date(currentDate.getFullYear(),currentDate.getMonth()+1,0).getDate(),s=n.getDay();for(let t=0;t<s;t++){const t=document.createElement("div");t.className="h-32 border border-gray-200",e.appendChild(t)}for(let t=1;t<=a;t++){const n=new Date(currentDate.getFullYear(),currentDate.getMonth(),t).toISOString().split("T")[0],a=tasks[n]||[];e.appendChild(createDayElement(t,n,a))}}function createDayElement(e,t,n){const a=document.createElement("div"),s=getTodayString(),i=t===s,o=isDatePast(t);return a.className=`h-32 border border-gray-200 p-1 cursor-pointer hover:bg-blue-50 transition relative calendar-day group ${i?"bg-blue-100 border-blue-300 ring-2 ring-blue-200":""} ${o?"opacity-75":""}`,a.dataset.date=t,a.innerHTML=`\n        <div class="font-semibold text-sm mb-1 ${i?"text-blue-700":""}">${e}</div>\n        <div class="space-y-1">\n            ${n.slice(0,2).map((e=>createTaskElement(e,t))).join("")}\n            ${n.length>2?`\n                <div class="text-xs text-gray-500 cursor-pointer hover:text-blue-600 transition-colors" \n                     onclick="showDailyTaskPanel('${t}', ${e})">\n                    +${n.length-2} más\n                </div>\n            `:""}\n        </div>\n        ${o?"":`\n            <button onclick="event.stopPropagation(); showQuickAddTask('${t}')"\n                    class="absolute bottom-1 right-1 w-6 h-6 bg-green-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-green-600 flex items-center justify-center"\n                    title="Agregar tarea rápida">\n                <i class="fas fa-plus"></i>\n            </button>\n        `}\n    `,a.addEventListener("click",(n=>{n.target.closest(".task-item")||n.target.closest("button")||(showDailyTaskPanel(t,e),scrollToPanelSmoothly())})),a}function updatePanelDateHeader(e,t,n){const a=document.getElementById("panelDate"),s=document.getElementById("panelActionButtons"),i=new Date(e+"T12:00:00"),o=dailyTaskLogs[e]||[];a.innerHTML=`\n        <i class="fas fa-tasks text-indigo-600 mr-2"></i>\n        Tareas del ${i.toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}\n    `;s.querySelectorAll("button:not(#closePanelBtn)").forEach((e=>e.remove()));const r=document.createElement("div");if(r.className="flex items-center space-x-2",n.length>0){const t=document.createElement("button");t.onclick=()=>clearDayTasks(e),t.className="flex items-center space-x-1 text-red-600 hover:text-red-700 text-sm px-2 py-1 rounded hover:bg-red-50 transition",t.title="Eliminar todas las tareas del día",t.innerHTML='\n            <i class="fas fa-trash-alt"></i>\n            <span class="hidden sm:inline">Limpiar Día</span>\n        ',r.appendChild(t)}const l=document.createElement("button");l.onclick=()=>showDayChangeLog(e),l.className="flex items-center space-x-1 text-purple-600 hover:text-purple-700 text-sm px-2 py-1 rounded hover:bg-purple-50 transition",l.title="Ver registro de cambios del día",l.innerHTML=`\n        <i class="fas fa-history"></i>\n        <span class="hidden sm:inline">Registro</span>\n        ${o.length>0?`<span class="bg-purple-100 text-purple-700 text-xs px-1.5 py-0.5 rounded-full ml-1">${o.length}</span>`:""}\n    `,r.appendChild(l);const c=document.getElementById("closePanelBtn");s.insertBefore(r,c)}function showDailyTaskPanel(e,t){const n=document.getElementById("dailyTaskPanel"),a=document.getElementById("panelDate"),s=document.getElementById("panelTaskList");if(!n||!a||!s)return;selectedDateForPanel=e;const i=tasks[e]||[],o=(new Date(e+"T12:00:00"),isDatePast(e)),r=e===getTodayString();if(updatePanelDateHeader(e,t,i),0===i.length)s.innerHTML=`\n      <div class="text-center py-8 text-gray-500">\n        <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n        <p>No hay tareas para este día</p>\n        ${o?"":`<p class="text-sm mt-2">${r?"¡Agrega tu primera tarea de hoy!":"¡Agrega tu primera tarea!"}</p>`}\n      </div>\n    `;else{const t=sortTasksByPriority(i);s.innerHTML=t.map((t=>createPanelTaskElement(t,e))).join("")}updatePanelProgress(i);const l=document.getElementById("addQuickTaskBtn");l&&(l.style.display=o?"none":"flex"),n.classList.remove("hidden")}function scrollToPanelSmoothly(){const e=document.getElementById("dailyTaskPanel");e&&setTimeout((()=>{const t=e.getBoundingClientRect(),n=window.innerHeight;if(t.top<0||t.bottom>n){const t=window.innerWidth<768?80:100;e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),setTimeout((()=>{window.scrollBy({top:-t,behavior:"smooth"})}),300)}}),100)}function sortTasksByPriority(e){return e.sort(((e,t)=>e.priority!==t.priority?e.priority-t.priority:e.time&&t.time?e.time.localeCompare(t.time):e.time&&!t.time?-1:!e.time&&t.time?1:e.title.localeCompare(t.title)))}function createPanelTaskElement(e,t){const n=isDatePast(t),a=PRIORITY_LEVELS[e.priority]||PRIORITY_LEVELS[3],s=TASK_STATES[e.state]||TASK_STATES.pending,i="inProgress"===e.state,o="paused"===e.state,r=(checkIfTaskIsLate(t,e.time),n&&"completed"!==e.state);return`\n    <div class="panel-task-item bg-white rounded-lg shadow-md p-4 mb-4 border-l-4 transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5 ${r?"bg-orange-50":""}" \n         style="border-left-color: ${a.color}" \n         data-priority="${e.priority}">\n        \n        \x3c!--Advertencia de retraso --\x3e\n        ${r?'\n            <div class="bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-2 mb-3 rounded text-xs">\n                <i class="fas fa-exclamation-triangle mr-1"></i>\n                <strong>Completada con retraso</strong> - Se registrará el retraso\n            </div>\n        ':""}\n\n        <div class="flex sm:items-center sm:justify-between">\n            <div class="flex-1 sm:flex sm:items-start sm:space-x-3">\n                \x3c!-- Select de estado - AHORA SIEMPRE EDITABLE --\x3e\n                <div class="flex flex-col space-y-2 mb-3 sm:mb-0 w-28">\n                    <select onchange="changeTaskStateWithLateTracking('${t}', '${e.id}', this.value)" \n                            class="text-xs px-1 py-2 rounded-lg border ${s.class} font-medium pr-6 cursor-pointer transition-colors duration-200"\n                            title="Cambiar estado de la tarea${n?" (se registrará como retraso)":""}">\n                        <option value="pending" ${"pending"===e.state?"selected":""}>⏸ Pendiente</option>\n                        <option value="inProgress" ${"inProgress"===e.state?"selected":""}>▶ En Proceso</option>\n                        <option value="completed" ${"completed"===e.state?"selected":""}>✓ Completada</option>\n                    </select>\n\n                    <div class="flex items-center space-x-2">\n                        <span class="task-priority-dot inline-block w-3 h-3 rounded-full shadow-sm" \n                              style="background-color: ${a.color}" \n                              title="Prioridad: ${a.label}"></span>\n                        <span class="text-xs text-gray-600 font-medium">${a.label}</span>\n                    </div>\n                </div>\n                \n                \x3c!-- Información de la tarea --\x3e\n                <div class="flex-1">\n                    <div class="task-title font-semibold text-base ${"completed"===e.state?"line-through text-gray-500":"text-gray-800"}">${e.title}</div>\n                    ${e.description?`<div class="task-description text-sm text-gray-600 mt-1">${e.description}</div>`:'<div class="task-description text-sm text-gray-400 mt-1 italic">Sin descripción</div>'}\n                    <div class="task-meta flex flex-wrap items-center gap-3 mt-2 text-xs">\n                        ${e.time?`<div class="text-indigo-600"><i class="far fa-clock mr-1"></i>${e.time}</div>`:""}\n                        <div class="text-gray-500">${s.label}</div>\n                        ${e.completedLate?'<div class="text-orange-600"><i class="fas fa-clock mr-1"></i>Completada con retraso</div>':""}\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- Botones de acción - SIEMPRE DISPONIBLES --\x3e\n            <div class="task-actions flex flex-col space-y-1 ml-4 sm:flex-row sm:items-center sm:space-y-0 sm:space-x-1 sm:ml-0">\n                ${i?`\n                    <button onclick="pauseTask('${t}', '${e.id}')"\n                            class="flex items-center space-x-1 bg-orange-100 text-orange-700 px-3 py-2 rounded-lg hover:bg-orange-200 transition-colors duration-200 text-xs font-medium shadow-sm"\n                            title="Pausar tarea activa">\n                        <i class="fas fa-pause"></i>\n                        <span>Pausar</span>\n                    </button>\n                `:""}\n                ${o?`\n                    <button onclick="resumeTask('${t}', '${e.id}')"\n                            class="flex items-center space-x-1 bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors duration-200 text-xs font-medium shadow-sm"\n                            title="Reanudar tarea pausada">\n                        <i class="fas fa-play"></i>\n                        <span>Reanudar</span>\n                    </button>\n                `:""}\n                <button onclick="showAdvancedEditModal('${t}', '${e.id}')"\n                        class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 transition-colors duration-200"\n                        title="Editar título, descripción, hora y prioridad">\n                    <i class="fas fa-edit text-sm"></i>\n                </button>\n                <button onclick="showDayChangeLog('${t}')"\n                        class="text-purple-500 hover:text-purple-700 p-2 rounded-lg hover:bg-purple-50 transition-colors duration-200"\n                        title="Ver registro de cambios del día">\n                    <i class="fas fa-history text-sm"></i>\n                </button>\n                <button onclick="deleteTaskFromPanel('${t}', '${e.id}')"\n                        class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors duration-200"\n                        title="Eliminar tarea permanentemente">\n                    <i class="fas fa-trash text-sm"></i>\n                </button>\n            </div>\n        </div>\n    </div>\n  `}function changeTaskStateWithLateTracking(e,t,n){const a=tasks[e]?.find((e=>e.id===t));if(!a)return;const s=a.state||"pending";if(s===n)return;const i=isDatePast(e),o=checkIfTaskIsLate(e,a.time);if(i&&"completed"===n&&"completed"!==s){if(!confirm("⚠️ Esta tarea está retrasada.\n\n¿Marcar como completada con retraso?\n(Se registrará en el historial)")){const e=document.querySelector(`select[onchange*="${t}"]`);return void(e&&(e.value=s))}a.completedLate=!0,a.completedAt=(new Date).toISOString()}if("completed"===s&&"completed"!==n){if(!confirm("¿Estás seguro de que quieres cambiar una tarea completada?")){const e=document.querySelector(`select[onchange*="${t}"]`);return void(e&&(e.value=s))}delete a.completedLate,delete a.completedAt}a.state=n,a.completed="completed"===a.state;let r="stateChanged",l=a.title;if(a.completedLate&&"completed"===n?l=`⚠️ COMPLETADA CON RETRASO - ${a.title}`:o&&"pending"!==n&&"pending"===s&&(l=`⚠️ RETRASADA - ${a.title}`),"inProgress"===s&&"paused"===n?r="paused":"paused"===s&&"inProgress"===n&&(r="resumed"),addToChangeLog(r,l,e,s,n,t),"completed"===a.state&&clearTaskNotifications(t),saveTasks(),renderCalendar(),updateProgress(),enqueueSync("upsert",e,a),selectedDateForPanel===e){showDailyTaskPanel(e,new Date(e+"T12:00:00").getDate())}const c=TASK_STATES[a.state],d=a.completedLate?"warning":"success";showNotification(a.completedLate?`⚠️ Completada con retraso - ${c.label}`:`Tarea: ${c.label}`,d)}function pauseTask(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n||"inProgress"!==n.state)return void showNotification("Solo se pueden pausar tareas en proceso","error");const a=n.state;if(n.state="paused",n.completed=!1,addToChangeLog("paused",n.title,e,a,"paused",t),saveTasks(),renderCalendar(),updateProgress(),enqueueSync("upsert",e,n),selectedDateForPanel===e){showDailyTaskPanel(e,new Date(e+"T12:00:00").getDate())}showNotification("Tarea pausada","info")}function resumeTask(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n||"paused"!==n.state)return void showNotification("Solo se pueden reanudar tareas pausadas","error");const a=n.state;if(n.state="inProgress",n.completed=!1,addToChangeLog("resumed",n.title,e,a,"inProgress",t),saveTasks(),renderCalendar(),updateProgress(),enqueueSync("upsert",e,n),selectedDateForPanel===e){showDailyTaskPanel(e,new Date(e+"T12:00:00").getDate())}showNotification("Tarea reanudada","success")}function showDeletedTasksModal(){closeAllModals();const e=JSON.parse(localStorage.getItem("deletedTasks")||"[]"),t=document.createElement("div");t.id="deletedTasksModal",t.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",t.innerHTML=`\n        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">\n            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">\n                <h3 class="text-lg font-semibold text-gray-800">\n                    <i class="fas fa-trash text-red-500 mr-2"></i>Tareas Eliminadas\n                </h3>\n                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <div class="p-6 overflow-y-auto max-h-96">\n                ${0===e.length?'\n                    <div class="text-center py-8 text-gray-500">\n                        <i class="fas fa-check-circle text-4xl mb-3 opacity-50"></i>\n                        <p>No hay tareas eliminadas</p>\n                    </div>\n                ':`\n                    <div class="space-y-3">\n                        ${e.map(((e,t)=>`\n                            <div class="bg-red-50 rounded-lg p-3 border-l-4 border-red-500">\n                                <div class="flex justify-between items-start">\n                                    <div class="flex-1">\n                                        <div class="font-medium text-sm text-gray-800">\n                                            <i class="fas fa-trash text-red-600 mr-1"></i>\n                                            "${e.title}"\n                                        </div>\n                                        <div class="text-xs text-gray-500 mt-1">\n                                            Fecha: ${e.date} • Eliminada: ${e.formattedDeleteTime}\n                                        </div>\n                                        <div class="text-xs text-red-600 mt-1">\n                                            ID: ${e.id}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        `)).join("")}\n                    </div>\n                `}\n                <div class="mt-6 flex justify-end space-x-3">\n                    ${e.length>0?'\n                        <button onclick="clearDeletedTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">\n                            <i class="fas fa-eraser mr-2"></i>Limpiar Lista\n                        </button>\n                    ':""}\n                    <button onclick="closeAllModals()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">\n                        Cerrar\n                    </button>\n                </div>\n            </div>\n        </div>\n    `,document.body.appendChild(t)}function clearDeletedTasks(){confirm("¿Estás seguro de que quieres limpiar la lista de tareas eliminadas?")&&(localStorage.removeItem("deletedTasks"),showNotification("Lista de tareas eliminadas limpiada","success"),closeAllModals())}function clearDayTasks(e){const t=tasks[e]||[];if(0===t.length)return void showNotification("No hay tareas para eliminar en este día","info");const n=new Date(e+"T12:00:00"),a=n.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"});if(!confirm(`¿Seguro que quieres eliminar todas las ${t.length} tareas del ${a}?`))return;currentUser&&isOnline&&(t.forEach((t=>{enqueueSync("delete",e,{id:t.id}),clearTaskNotifications(t.id)})),setTimeout((()=>{syncQueue.size>0&&processSyncQueue()}),100)),delete tasks[e],delete dailyTaskLogs[e],saveTasks(),saveTaskLogs(),renderCalendar(),updateProgress(),updatePanelDateHeader(e,n.getDate(),[]),updatePanelProgress([]);const s=document.getElementById("panelTaskList");s&&(s.innerHTML='\n      <div class="text-center py-8 text-gray-500">\n        <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n        <p>No hay tareas para este día</p>\n        <p class="text-sm mt-2">¡Todas las tareas del día fueron eliminadas!</p>\n      </div>\n    '),closeDailyTaskPanel(),showNotification(`${t.length} tareas eliminadas del ${a}`,"success")}function createTaskElement(e,t){const n=PRIORITY_LEVELS[e.priority]||PRIORITY_LEVELS[3],a=TASK_STATES[e.state]||TASK_STATES.pending;return`\n        <div class="task-item-wrapper relative group/task">\n            <div class="text-xs p-1 rounded ${a.class} truncate task-item cursor-move pr-8 border-l-4" \n                 data-task-id="${e.id}"\n                 data-date="${t}"\n                 draggable="true"\n                 style="border-left-color: ${n.color}"\n                 title="${e.title}${e.time?" - "+e.time:""} | ${a.label} | ${n.label}">\n                <i class="fas ${a.icon} mr-1 opacity-75"></i>\n                ${e.title}\n                ${e.time?`<span class="text-xs opacity-75 ml-1">${e.time}</span>`:""}\n            </div>\n            <div class="absolute right-0 top-0 h-full flex items-center opacity-0 group-hover/task:opacity-100 transition-opacity duration-200 bg-gradient-to-l from-white via-white to-transparent pl-2">\n                <button onclick="event.stopPropagation(); quickEditTaskAdvanced('${t}', '${e.id}')"\n                        class="text-blue-500 hover:text-blue-700 text-xs p-1 rounded hover:bg-blue-100"\n                        title="Editar tarea completa">\n                    <i class="fas fa-edit"></i>\n                </button>\n                <button onclick="event.stopPropagation(); quickDeleteTask('${t}', '${e.id}')"\n                        class="text-red-500 hover:text-red-700 text-xs p-1 rounded hover:bg-red-100 ml-1"\n                        title="Eliminar tarea permanentemente">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </div>\n        </div>\n    `}function updatePanelProgress(e){const t=document.getElementById("panelProgressBar"),n=document.getElementById("panelProgressText");if(!t||!n)return;const a=e.filter((e=>"completed"===e.state)).length,s=e.filter((e=>"inProgress"===e.state)).length,i=e.filter((e=>"paused"===e.state)).length,o=e.filter((e=>"pending"===e.state)).length,r=0===e.length?0:Math.round(a/e.length*100);t.style.width=`${r}%`,n.innerHTML=`\n        ${r}% | \n        <span class="text-green-600">${a} ✓</span> \n        <span class="text-blue-600">${s} ▶</span> \n        <span class="text-orange-600">${i} ⏸</span>\n        <span class="text-gray-600">${o} ⏸</span>\n    `}function deleteTaskFromPanel(e,t){deleteTaskWithOptions(e,t)}function deleteTaskWithOptions(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n)return void showNotification("Tarea no encontrada","error");const a=findSimilarTasksForDelete(n.title,n.time);a.count>1?showBulkDeleteModal(e,t,n,a):confirmSingleDelete(e,t,n)}function findSimilarTasksForDelete(e,t){let n=0;const a=[];return Object.entries(tasks).forEach((([s,i])=>{i.forEach((i=>{i.title===e&&i.time===t&&(n++,a.push(s))}))})),{count:n,dates:a}}function confirmSingleDelete(e,t,n){confirm(`¿Eliminar la tarea "${n.title}"?\n\nEsta acción no se puede deshacer.`)&&executeSingleDelete(e,t,n)}function executeSingleDelete(e,t,n){if(currentUser&&isOnline&&(enqueueSync("delete",e,{id:t}),setTimeout((()=>{syncQueue.size>0&&processSyncQueue()}),100)),addToChangeLog("deleted",n.title,e,null,null,t),clearTaskNotifications(t),tasks[e]=tasks[e].filter((e=>e.id!==t)),0===tasks[e].length&&delete tasks[e],saveTasks(),renderCalendar(),updateProgress(),selectedDateForPanel===e){showDailyTaskPanel(e,new Date(e+"T12:00:00").getDate())}showNotification("Tarea eliminada exitosamente","success")}function showBulkDeleteModal(e,t,n,a){closeAllModals();const s=document.createElement("div");s.id="bulkDeleteModal",s.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",s.innerHTML=`\n    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">\n      <div class="flex justify-between items-center mb-4">\n        <h3 class="text-lg font-semibold text-gray-800">\n          <i class="fas fa-trash-alt text-red-500 mr-2"></i>Eliminar Tarea Recurrente\n        </h3>\n        <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n\n      \x3c!-- Información de la tarea --\x3e\n      <div class="bg-red-50 border-l-4 border-red-400 p-4 rounded-lg mb-4">\n        <div class="flex items-start">\n          <i class="fas fa-exclamation-triangle text-red-600 mt-1 mr-3 flex-shrink-0"></i>\n          <div class="flex-1">\n            <p class="text-sm font-medium text-red-800">\n              <strong>Tarea:</strong> ${n.title}\n            </p>\n            ${n.time?`<p class="text-xs text-red-600 mt-1">Hora: ${n.time}</p>`:""}\n            <p class="text-xs text-red-600 mt-2">\n              Esta tarea se repite en <strong>${a.count} días</strong>.\n              Selecciona cómo deseas eliminarla:\n            </p>\n          </div>\n        </div>\n      </div>\n\n      \x3c!-- Opciones de eliminación --\x3e\n      <div class="space-y-3 mb-6">\n        \x3c!-- Opción 1: Solo esta tarea --\x3e\n        <button onclick="deleteSingleTaskFromBulk('${e}', '${t}')" \n                class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 p-4 rounded-lg transition text-left group">\n          <div class="flex items-center">\n            <div class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center mr-3 flex-shrink-0 group-hover:scale-110 transition-transform">\n              <i class="fas fa-calendar-day text-lg"></i>\n            </div>\n            <div class="flex-1">\n              <div class="font-semibold">Eliminar solo esta tarea</div>\n              <div class="text-xs opacity-75 mt-1">\n                Solo en ${new Date(e+"T12:00:00").toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"})}\n              </div>\n            </div>\n            <i class="fas fa-chevron-right text-blue-400 ml-2"></i>\n          </div>\n        </button>\n\n        \x3c!-- Opción 2: Todas las ocurrencias --\x3e\n        <button onclick="showBulkDeleteConfirmation('${e}', '${t}', 'all')" \n                class="w-full bg-red-100 hover:bg-red-200 text-red-800 p-4 rounded-lg transition text-left group">\n          <div class="flex items-center">\n            <div class="w-10 h-10 bg-red-500 text-white rounded-full flex items-center justify-center mr-3 flex-shrink-0 group-hover:scale-110 transition-transform">\n              <i class="fas fa-calendar-alt text-lg"></i>\n            </div>\n            <div class="flex-1">\n              <div class="font-semibold">Eliminar en todos los días</div>\n              <div class="text-xs opacity-75 mt-1">\n                Buscar y eliminar todas las ${a.count} ocurrencias\n              </div>\n            </div>\n            <i class="fas fa-chevron-right text-red-400 ml-2"></i>\n          </div>\n        </button>\n\n        \x3c!-- Opción 3: Días personalizados --\x3e\n        <button onclick="showCustomDatesDeleteSelector('${e}', '${t}')" \n                class="w-full bg-orange-100 hover:bg-orange-200 text-orange-800 p-4 rounded-lg transition text-left group">\n          <div class="flex items-center">\n            <div class="w-10 h-10 bg-orange-500 text-white rounded-full flex items-center justify-center mr-3 flex-shrink-0 group-hover:scale-110 transition-transform">\n              <i class="fas fa-calendar-check text-lg"></i>\n            </div>\n            <div class="flex-1">\n              <div class="font-semibold">Eliminar en días personalizados</div>\n              <div class="text-xs opacity-75 mt-1">\n                Selecciona fechas específicas para eliminar\n              </div>\n            </div>\n            <i class="fas fa-chevron-right text-orange-400 ml-2"></i>\n          </div>\n        </button>\n      </div>\n\n      \x3c!-- Botón cancelar --\x3e\n      <button onclick="closeAllModals()" \n              class="w-full bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-medium">\n        <i class="fas fa-times mr-2"></i>Cancelar\n      </button>\n    </div>\n  `,document.body.appendChild(s)}function deleteSingleTaskFromBulk(e,t){const n=tasks[e]?.find((e=>e.id===t));n&&(closeAllModals(),confirm(`¿Confirmas eliminar esta tarea solo del día seleccionado?\n\n"${n.title}"\n\nEsta acción no se puede deshacer.`)&&executeSingleDelete(e,t,n))}function showBulkDeleteConfirmation(e,t,n){const a=tasks[e]?.find((e=>e.id===t));if(!a)return;closeAllModals();const s=findSimilarTasksForDelete(a.title,a.time),i=document.createElement("div");i.id="bulkDeleteConfirmModal",i.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",i.innerHTML=`\n    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">\n      <div class="text-center mb-6">\n        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">\n          <i class="fas fa-exclamation-triangle text-red-600 text-3xl"></i>\n        </div>\n        <h3 class="text-xl font-bold text-gray-800 mb-2">\n          Confirmar Eliminación Masiva\n        </h3>\n        <p class="text-gray-600 text-sm">\n          Estás a punto de eliminar <strong>${s.count} tareas</strong> en ${s.count} días diferentes.\n        </p>\n      </div>\n\n      <div class="bg-gray-50 rounded-lg p-4 mb-6">\n        <div class="text-sm text-gray-700">\n          <p class="font-semibold mb-2">Tarea a eliminar:</p>\n          <p class="text-gray-800 font-medium">"${a.title}"</p>\n          ${a.time?`<p class="text-gray-600 text-xs mt-1">Hora: ${a.time}</p>`:""}\n        </div>\n        \n        <div class="mt-4 text-xs text-gray-500">\n          <p class="font-semibold mb-1">Primeras fechas afectadas:</p>\n          <ul class="list-disc list-inside space-y-1">\n            ${s.dates.slice(0,5).map((e=>`<li>${new Date(e+"T12:00:00").toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})}</li>`)).join("")}\n            ${s.count>5?`<li class="font-semibold">... y ${s.count-5} más</li>`:""}\n          </ul>\n        </div>\n      </div>\n\n      <div class="bg-red-50 border-l-4 border-red-400 p-3 mb-6 text-sm text-red-700">\n        <i class="fas fa-exclamation-circle mr-2"></i>\n        <strong>Esta acción no se puede deshacer.</strong> Todas las tareas idénticas serán eliminadas permanentemente.\n      </div>\n\n      <div class="flex space-x-3">\n        <button onclick="executeBulkDelete('${e}', '${t}', 'all')" \n                class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-medium">\n          <i class="fas fa-trash-alt mr-2"></i>Sí, Eliminar Todo\n        </button>\n        <button onclick="closeAllModals()" \n                class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-medium">\n          Cancelar\n        </button>\n      </div>\n    </div>\n  `,document.body.appendChild(i)}function showCustomDatesDeleteSelector(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n)return;closeAllModals();const a=[];Object.entries(tasks).forEach((([e,t])=>{t.some((e=>e.title===n.title&&e.time===n.time))&&a.push(e)}));const s=document.createElement("div");s.id="customDatesDeleteModal",s.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",s.innerHTML=`\n    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">\n      <div class="flex justify-between items-center mb-4">\n        <h3 class="text-lg font-semibold text-gray-800">\n          <i class="fas fa-calendar-check text-orange-500 mr-2"></i>Seleccionar Fechas para Eliminar\n        </h3>\n        <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n\n      <div class="bg-orange-50 border-l-4 border-orange-400 p-3 mb-4 text-sm text-orange-800">\n        <p class="font-medium">Tarea: <strong>"${n.title}"</strong></p>\n        <p class="text-xs mt-1">Selecciona los días donde deseas eliminar esta tarea</p>\n      </div>\n\n      <div class="mb-4">\n        <label class="flex items-center space-x-2 bg-blue-50 p-3 rounded cursor-pointer hover:bg-blue-100 transition">\n          <input type="checkbox" id="selectAllDeleteDates" onchange="toggleAllDeleteDates(this)" class="rounded">\n          <span class="text-sm font-medium">\n            <i class="fas fa-check-double mr-2 text-blue-600"></i>\n            Seleccionar todas (${a.length} fechas)\n          </span>\n        </label>\n      </div>\n\n      <div id="deleteDatesGrid" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-80 overflow-y-auto mb-4 border border-gray-200 rounded-lg p-3 bg-gray-50">\n        ${a.map((e=>{const t=new Date(e+"T12:00:00").toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"}),n=e===getTodayString();return`\n            <label class="flex items-center space-x-2 bg-white p-3 rounded-lg hover:bg-gray-100 cursor-pointer border border-gray-200 transition ${n?"ring-2 ring-blue-400":""}">\n              <input type="checkbox" value="${e}" class="custom-delete-date-checkbox rounded" checked>\n              <span class="text-sm flex-1">\n                ${t}\n                ${n?'<span class="text-xs text-blue-600 font-semibold ml-1">(Hoy)</span>':""}\n              </span>\n            </label>\n          `})).join("")}\n      </div>\n\n      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4 text-sm text-yellow-800">\n        <i class="fas fa-info-circle mr-2"></i>\n        <span id="selectedDeleteCount">${a.length} fechas seleccionadas</span>\n      </div>\n\n      <div class="flex space-x-3">\n        <button onclick="proceedWithCustomDelete('${e}', '${t}')" \n                class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition font-medium">\n          <i class="fas fa-trash-alt mr-2"></i>Eliminar Seleccionadas\n        </button>\n        <button onclick="closeAllModals()" \n                class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-medium">\n          Cancelar\n        </button>\n      </div>\n    </div>\n  `,document.body.appendChild(s),document.querySelectorAll(".custom-delete-date-checkbox").forEach((e=>{e.addEventListener("change",updateDeleteCounter)}))}function toggleAllDeleteDates(e){document.querySelectorAll(".custom-delete-date-checkbox").forEach((t=>t.checked=e.checked)),updateDeleteCounter()}function updateDeleteCounter(){const e=document.querySelectorAll(".custom-delete-date-checkbox:checked").length,t=document.getElementById("selectedDeleteCount");t&&(t.textContent=`${e} fecha${1!==e?"s":""} seleccionada${1!==e?"s":""}`)}function proceedWithCustomDelete(e,t){const n=Array.from(document.querySelectorAll(".custom-delete-date-checkbox:checked")).map((e=>e.value));if(0===n.length)return void showNotification("Selecciona al menos una fecha","error");const a=tasks[e]?.find((e=>e.id===t));if(!a)return;closeAllModals();const s=`¿Eliminar "${a.title}" en ${n.length} día${n.length>1?"s":""}?\n\nEsta acción no se puede deshacer.`;confirm(s)&&(window.selectedCustomDeleteDates=n,executeBulkDelete(e,t,"custom"))}function executeBulkDelete(e,t,n){const a=tasks[e]?.find((e=>e.id===t));if(!a)return void showNotification("Tarea no encontrada","error");let s=[];const i=a.title,o=a.time;if("custom"===n&&window.selectedCustomDeleteDates?s=window.selectedCustomDeleteDates:Object.entries(tasks).forEach((([e,t])=>{t.some((e=>e.title===i&&e.time===o))&&s.push(e)})),0===s.length)return void showNotification("No se encontraron tareas para eliminar","error");let r=0;if(s.forEach((e=>{if(!tasks[e])return;const t=[];tasks[e].forEach(((e,n)=>{e.title===i&&e.time===o&&t.push({task:e,index:n})})),t.reverse().forEach((({task:t,index:n})=>{currentUser&&isOnline&&enqueueSync("delete",e,{id:t.id}),addToChangeLog("deleted",t.title,e,null,null,t.id),clearTaskNotifications(t.id),tasks[e].splice(n,1),r++})),0===tasks[e].length&&delete tasks[e]})),delete window.selectedCustomDeleteDates,currentUser&&isOnline&&setTimeout((()=>{syncQueue.size>0&&processSyncQueue()}),100),saveTasks(),renderCalendar(),updateProgress(),closeAllModals(),showNotification(`✅ ${r} tarea${r>1?"s":""} eliminada${r>1?"s":""} en ${s.length} día${s.length>1?"s":""}`,"success"),selectedDateForPanel&&s.includes(selectedDateForPanel)){const e=new Date(selectedDateForPanel+"T12:00:00").getDate();showDailyTaskPanel(selectedDateForPanel,e)}}function showAdvancedEditModal(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n)return void showNotification("Tarea no encontrada","error");closeAllModals();const a=findSimilarTasks(n.title,n.time),s=a.count>1,i=document.createElement("div");i.id="advancedEditModal",i.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",i.innerHTML=`\n    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">\n      <div class="flex justify-between items-center mb-4">\n        <h3 class="text-lg font-semibold text-gray-800">\n          <i class="fas fa-edit text-blue-500 mr-2"></i>Editar Tarea\n        </h3>\n        <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n\n      \x3c!-- ✅ NUEVO: Botón de edición masiva (solo si hay tareas recurrentes) --\x3e\n      ${s?`\n        <div class="mb-4 p-3 bg-purple-50 border border-purple-200 rounded-lg">\n          <div class="flex items-center text-sm text-purple-700 mb-2">\n            <i class="fas fa-info-circle mr-2"></i>\n            <span>Esta tarea se repite en <strong>${a.count} días</strong></span>\n          </div>\n          <button onclick="showBulkEditModal('${e}', '${t}')" \n                  class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200 flex items-center justify-center">\n            <i class="fas fa-layer-group mr-2"></i>\n            Editar en Múltiples Días\n          </button>\n        </div>\n      `:""}\n\n      \x3c!-- Formulario de edición individual --\x3e\n      <form id="advancedEditTaskForm" class="space-y-4">\n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-2">\n            Título <span class="text-red-500">*</span>\n          </label>\n          <input type="text" id="advancedEditTaskTitle" value="${n.title||""}" required \n                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n        </div>\n\n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>\n          <textarea id="advancedEditTaskDescription" rows="3" \n                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${n.description||""}</textarea>\n        </div>\n\n        <div class="grid grid-cols-2 gap-4">\n          <div>\n            <label class="block text-sm font-medium text-gray-700 mb-2">\n              Hora <span class="text-red-500">*</span>\n            </label>\n            <input type="time" id="advancedEditTaskTime" value="${n.time||""}" required\n                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n          </div>\n          <div>\n            <label class="block text-sm font-medium text-gray-700 mb-2">\n              Prioridad <span class="text-red-500">*</span>\n            </label>\n            <select id="advancedEditTaskPriority" required \n                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n              <option value="" disabled>Selecciona una prioridad</option>\n              <option value="1" ${1===n.priority?"selected":""}>🔴 Muy Importante</option>\n              <option value="2" ${2===n.priority?"selected":""}>🟠 Importante</option>\n              <option value="3" ${3===n.priority?"selected":""}>🔵 Moderado</option>\n              <option value="4" ${4===n.priority?"selected":""}>⚫ No Prioritario</option>\n            </select>\n          </div>\n        </div>\n\n        <div class="bg-blue-50 p-3 rounded-lg">\n          <p class="text-sm text-blue-700">\n            <i class="fas fa-info-circle mr-1"></i>\n            Estado actual: <strong>${TASK_STATES[n.state].label}</strong>\n            <br>\n            <span class="text-xs">Usa los controles en el panel principal para cambiar el estado.</span>\n          </p>\n        </div>\n\n        <div class="flex space-x-3 pt-4 border-t">\n          <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">\n            <i class="fas fa-save mr-2"></i>Guardar Solo Esta Tarea\n          </button>\n          <button type="button" onclick="closeAllModals()" \n                  class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">\n            Cancelar\n          </button>\n        </div>\n      </form>\n    </div>\n  `,document.body.appendChild(i),document.getElementById("advancedEditTaskForm").addEventListener("submit",(n=>{n.preventDefault(),updateAdvancedTaskFromPanelImproved(e,t)}))}function canMoveTask(e){return e.priority>2}function checkIfTaskIsLate(e,t){if(!t)return!1;const n=new Date,a=getTodayString();if(isDatePast(e))return!0;if(e===a){const[e,a]=t.split(":").map(Number),s=60*e+a;return 60*n.getHours()+n.getMinutes()>s}return!1}function clearTaskNotifications(e){[`${e}-15min`,`${e}-start`,`${e}-late`].forEach((e=>{notificationStatus.taskReminders.delete(e),sentNotifications.delete(e)})),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({type:"CLEAR_TASK_NOTIFICATION",taskId:e})}function updateAdvancedTaskFromPanelImproved(e,t){const n=document.getElementById("advancedEditTaskTitle").value.trim(),a=document.getElementById("advancedEditTaskDescription").value.trim(),s=document.getElementById("advancedEditTaskTime").value,i=parseInt(document.getElementById("advancedEditTaskPriority").value);if(!n||!s||!i)return void showNotification("Por favor completa todos los campos obligatorios","error");if(!tasks[e])return void showNotification("Error: No se encontró la fecha de la tarea","error");const o=tasks[e].findIndex((e=>e.id===t));if(-1===o)return void showNotification("Error: No se encontró la tarea","error");tasks[e][o];const r={...tasks[e][o],title:n,description:a,time:s,priority:i};if(tasks[e][o]=r,addToChangeLog("edited",n,e,null,null,t),saveTasks(),renderCalendar(),updateProgress(),enqueueSync("upsert",e,r),closeAllModals(),showNotification("Tarea actualizada exitosamente","success"),selectedDateForPanel===e){showDailyTaskPanel(e,new Date(e+"T12:00:00").getDate())}}function quickEditTaskAdvanced(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n)return void showNotification("Tarea no encontrada","error");closeAllModals();const a=document.createElement("div");a.id="quickEditModal",a.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",a.innerHTML=`\n        <div class="bg-white rounded-lg p-4 max-w-sm w-full">\n            <h4 class="font-medium mb-3"><i class="fas fa-edit text-blue-500 mr-2"></i>Edición Rápida</h4>\n            <form id="quickEditForm" class="space-y-3">\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Título <span class="text-red-500">*</span></label>\n                    <input type="text" id="quickEditTitle" value="${n.title}" required\n                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>\n                    <textarea id="quickEditDescription" rows="3" \n                              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${n.description||""}</textarea>\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Hora <span class="text-red-500">*</span></label>\n                    <input type="time" id="quickEditTime" value="${n.time||""}" required\n                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridad <span class="text-red-500">*</span></label>\n                    <select id="quickEditPriority" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                        <option value="" disabled>Selecciona una prioridad</option>\n                        <option value="1" ${1===n.priority?"selected":""}>🔴 Muy Importante</option>\n                        <option value="2" ${2===n.priority?"selected":""}>🟠 Importante</option>\n                        <option value="3" ${3===n.priority?"selected":""}>🔵 Moderado</option>\n                        <option value="4" ${4===n.priority?"selected":""}>⚫ No Prioritario</option>\n                    </select>\n                </div>\n                <div class="flex space-x-2">\n                    <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-700 transition">\n                        <i class="fas fa-save mr-2"></i>Guardar\n                    </button>\n                    <button type="button" onclick="closeAllModals()" \n                            class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">\n                        Cancelar\n                    </button>\n                </div>\n            </form>\n        </div>\n    `,document.body.appendChild(a),document.getElementById("quickEditForm").addEventListener("submit",(n=>{n.preventDefault(),saveQuickEditImproved(e,t)}))}function saveQuickEditImproved(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n)return void showNotification("Error: No se encontró la tarea","error");const a=document.getElementById("quickEditTitle").value.trim(),s=document.getElementById("quickEditDescription").value.trim(),i=document.getElementById("quickEditTime").value,o=parseInt(document.getElementById("quickEditPriority").value);if(a&&i&&o){if(n.title=a,n.description=s,n.time=i,n.priority=o,saveTasks(),renderCalendar(),updateProgress(),enqueueSync("upsert",e,n),closeAllModals(),showNotification("Tarea actualizada exitosamente","success"),selectedDateForPanel===e){showDailyTaskPanel(e,new Date(e+"T12:00:00").getDate())}}else showNotification("Por favor completa todos los campos obligatorios","error")}function addQuickTaskToSelectedDay(){selectedDateForPanel&&(isDatePast(selectedDateForPanel)?showNotification("No puedes agregar tareas a fechas anteriores","error"):showQuickAddTask(selectedDateForPanel))}function closeDailyTaskPanel(){const e=document.getElementById("dailyTaskPanel");e&&(e.classList.add("hidden"),selectedDateForPanel=null)}function quickDeleteTask(e,t){deleteTaskWithOptions(e,t)}function showQuickAddTask(e){if(isDatePast(e))return void showNotification("No puedes agregar tareas a fechas anteriores","error");closeAllModals();const t=document.createElement("div");t.id="quickAddTaskModal",t.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",t.innerHTML='\n        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">\n            <div class="flex justify-between items-center mb-4">\n                <h3 class="text-lg font-semibold text-gray-800">\n                    <i class="fas fa-plus text-blue-500 mr-2"></i>Agregar Nueva Tarea\n                </h3>\n                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <form id="quickAddTaskForm" class="space-y-4">\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Título <span class="text-red-500">*</span></label>\n                    <input type="text" id="quickAddTaskTitle" required \n                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>\n                    <textarea id="quickAddTaskDescription" rows="3" \n                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>\n                </div>\n                <div class="grid grid-cols-2 gap-4">\n                    <div>\n                        <label class="block text-sm font-medium text-gray-700 mb-2">Hora <span class="text-red-500">*</span></label>\n                        <input type="time" id="quickAddTaskTime" required\n                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                    </div>\n                    <div>\n                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridad <span class="text-red-500">*</span></label>\n                        <select id="quickAddTaskPriority" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                            <option value="" disabled selected>Selecciona una prioridad</option>\n                            <option value="1">🔴 Muy Importante</option>\n                            <option value="2">🟠 Importante</option>\n                            <option value="3">🔵 Moderado</option>\n                            <option value="4">⚫ No Prioritario</option>\n                        </select>\n                    </div>\n                </div>\n                <div class="flex space-x-3 pt-4 border-t">\n                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">\n                        <i class="fas fa-save mr-2"></i>Agregar Tarea\n                    </button>\n                    <button type="button" onclick="closeAllModals()" \n                            class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">\n                        Cancelar\n                    </button>\n                </div>\n            </form>\n        </div>\n    ',document.body.appendChild(t);const n=new Date;document.getElementById("quickAddTaskTime").value=n.toTimeString().slice(0,5),document.getElementById("quickAddTaskForm").addEventListener("submit",(t=>{t.preventDefault();const n=document.getElementById("quickAddTaskTitle").value.trim(),a=document.getElementById("quickAddTaskDescription").value.trim(),s=document.getElementById("quickAddTaskTime").value,i=parseInt(document.getElementById("quickAddTaskPriority").value);if(!n||!s||!i)return void showNotification("Por favor completa todos los campos obligatorios","error");const o={id:`${e}-${Date.now()}`,title:n,description:a,time:s,priority:i,state:"pending",completed:!1};if(addTaskToDate(e,o),saveTasks(),renderCalendar(),updateProgress(),enqueueSync("upsert",e,o),closeAllModals(),showNotification("Tarea agregada exitosamente","success"),selectedDateForPanel===e){const t=new Date(e+"T12:00:00").getDate();showDailyTaskPanel(e,t)}}))}function closeAllModals(){["advancedEditModal","quickEditModal","quickAddTaskModal","editTaskModal","taskModal"].forEach((e=>{const t=document.getElementById(e);t&&t.remove()})),document.querySelectorAll(".fixed.inset-0.bg-black.bg-opacity-50").forEach((e=>{e.remove()}))}function setupTaskTooltips(){let e=createTaskTooltip();document.addEventListener("mouseover",(function(t){if(t.target.classList.contains("task-item")){const n=t.target.dataset.taskId,a=t.target.dataset.date,s=tasks[a]?.find((e=>e.id===n));s&&showTooltip(e,t.target,s)}})),document.addEventListener("mouseout",(function(t){t.target.classList.contains("task-item")&&e.classList.add("opacity-0")}))}function createTaskTooltip(){const e=document.createElement("div");return e.id="task-tooltip",e.className="fixed bg-gray-800 text-white text-xs rounded px-2 py-1 z-50 pointer-events-none opacity-0 transition-opacity duration-200 max-w-xs",document.body.appendChild(e),e}function showTooltip(e,t,n){const a=t.getBoundingClientRect();e.innerHTML=`\n        <div class="font-semibold">${n.title}</div>\n        ${n.description?`<div class="text-gray-300">${n.description}</div>`:""}\n        ${n.time?`<div class="text-blue-300"><i class="far fa-clock mr-1"></i>${n.time}</div>`:""}\n        <div class="text-gray-400 text-xs mt-1">\n            ${n.completed?"✓ Completada":"Pendiente"} • Arrastra para mover\n        </div>\n    `,e.style.left=Math.min(a.left,window.innerWidth-e.offsetWidth-10)+"px",e.style.top=a.top-e.offsetHeight-5+"px",e.classList.remove("opacity-0")}function setupDragAndDrop(){const e=document.getElementById("calendar");e&&(e.addEventListener("dragstart",handleDragStart),e.addEventListener("dragend",handleDragEnd),e.addEventListener("dragover",handleDragOver),e.addEventListener("dragleave",handleDragLeave),e.addEventListener("drop",handleDrop))}function handleDragStart(e){e.target.classList.contains("task-item")&&(e.stopPropagation(),draggedTask=e.target.dataset.taskId,draggedFromDate=e.target.dataset.date,e.target.style.opacity="0.5")}function handleDragEnd(e){e.target.classList.contains("task-item")&&(e.target.style.opacity="1",draggedTask=null,draggedFromDate=null)}function handleDragOver(e){e.preventDefault();const t=e.target.closest(".calendar-day");t&&t.classList.add("bg-yellow-100")}function handleDragLeave(e){const t=e.target.closest(".calendar-day");t&&t.classList.remove("bg-yellow-100")}function handleDrop(e){e.preventDefault();const t=e.target.closest(".calendar-day");if(t&&draggedTask&&draggedFromDate){const e=t.dataset.date;if(isDatePast(e))return showNotification("No puedes mover tareas a fechas anteriores","error"),void document.querySelectorAll(".bg-yellow-100").forEach((e=>{e.classList.remove("bg-yellow-100")}));const n=tasks[draggedFromDate]?.find((e=>e.id===draggedTask));if(n&&!canMoveTask(n)){return showNotification(`Las tareas "${(PRIORITY_LEVELS[n.priority]||PRIORITY_LEVELS[3]).label}" no se pueden mover. Solo se pueden editar o eliminar.`,"error"),void document.querySelectorAll(".bg-yellow-100").forEach((e=>{e.classList.remove("bg-yellow-100")}))}e!==draggedFromDate&&(moveTask(draggedFromDate,e,draggedTask),showNotification("Tarea movida exitosamente","success"))}document.querySelectorAll(".bg-yellow-100").forEach((e=>{e.classList.remove("bg-yellow-100")}))}function handleDragStart(e){if(e.target.classList.contains("task-item")){e.stopPropagation(),draggedTask=e.target.dataset.taskId,draggedFromDate=e.target.dataset.date;const t=tasks[draggedFromDate]?.find((e=>e.id===draggedTask));if(t&&!canMoveTask(t)){e.target.style.opacity="0.3",e.target.style.cursor="not-allowed";const t=document.createElement("div");t.className="fixed bg-red-600 text-white text-xs px-2 py-1 rounded z-50 pointer-events-none",t.textContent="Esta tarea no se puede mover";const n=e.target.getBoundingClientRect();t.style.left=n.left+"px",t.style.top=n.top-30+"px",document.body.appendChild(t),setTimeout((()=>t.remove()),2e3)}else e.target.style.opacity="0.5"}}function moveTask(e,t,n){const a=tasks[e],s=a?.findIndex((e=>e.id===n));if(-1!==s){const i=a.splice(s,1)[0],o=i.title;0===a.length&&delete tasks[e],tasks[t]||(tasks[t]=[]),i.id=`${t}-${Date.now()}`,tasks[t].push(i),addToChangeLog("moved",o,t,e,t),saveTasks(),renderCalendar(),updateProgress(),enqueueSync("delete",e,{id:n}),enqueueSync("upsert",t,i)}}function deleteTaskWithUndoImproved(e,t){const n=tasks[e],a=n?.findIndex((e=>e.id===t));if(-1!==a){const s=n[a];lastDeletedTask={...s},lastDeletedDate=e,currentUser&&isOnline&&(enqueueSync("delete",e,{id:t}),setTimeout((()=>{syncQueue.size>0&&processSyncQueue()}),100)),addToChangeLog("deleted",s.title,e,null,null,t),clearTaskNotifications(t),tasks[e]=tasks[e].filter((e=>e.id!==t)),0===tasks[e].length&&delete tasks[e],saveTasks(),saveTaskLogs(),renderCalendar(),updateProgress(),showUndoNotification()}}function saveTaskLogs(){try{localStorage.setItem("dailyTaskLogs",JSON.stringify(dailyTaskLogs))}catch(e){}}function loadTaskLogs(){try{const e=localStorage.getItem("dailyTaskLogs");dailyTaskLogs=e?JSON.parse(e):{}}catch(e){dailyTaskLogs={}}}function showUndoNotification(){const e=document.createElement("div");e.className="fixed bottom-4 left-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3",e.innerHTML='\n        <span>Tarea eliminada</span>\n        <button onclick="undoDelete()" class="bg-blue-500 px-3 py-1 rounded text-sm hover:bg-blue-600 transition">\n            Deshacer\n        </button>\n        <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-white">\n            <i class="fas fa-times"></i>\n        </button>\n    ',document.body.appendChild(e),setTimeout((()=>e.remove()),5e3)}function undoDelete(){lastDeletedTask&&lastDeletedDate&&(tasks[lastDeletedDate]||(tasks[lastDeletedDate]=[]),tasks[lastDeletedDate].push(lastDeletedTask),enqueueSync("upsert",lastDeletedDate,lastDeletedTask),saveTasks(),renderCalendar(),updateProgress(),lastDeletedTask=null,lastDeletedDate=null,showNotification("Tarea restaurada exitosamente","success"),document.querySelector(".fixed.bottom-4.left-4")?.remove())}function changeMonth(e){currentDate.setMonth(currentDate.getMonth()+e),renderCalendar(),updateProgress()}function clearWeek(){if(!confirm("¿Estás seguro de que quieres limpiar todas las tareas de esta semana?"))return;const e=new Date,t=new Date(e);t.setDate(e.getDate()-e.getDay());const n=new Date(t);n.setDate(t.getDate()+6);const a=[];for(let e=0;e<7;e++){const n=new Date(t);n.setDate(t.getDate()+e);const s=n.toISOString().split("T")[0];tasks[s]&&(tasks[s].forEach((e=>{a.push({dateStr:s,taskId:e.id}),clearTaskNotifications(e.id)})),delete tasks[s])}if(a.forEach((({dateStr:e,taskId:t})=>{enqueueSync("delete",e,{id:t})})),saveTasks(),renderCalendar(),updateProgress(),showNotification("Semana limpiada exitosamente"),selectedDateForPanel){const e=new Date(selectedDateForPanel+"T00:00:00");if(e>=t&&e<=n){const e=document.getElementById("panelTaskList");e&&(e.innerHTML='\n          <div class="text-center py-8 text-gray-500">\n            <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n            <p>No hay tareas para este día</p>\n            <p class="text-sm mt-2">¡Todas las tareas de la semana fueron eliminadas!</p>\n          </div>\n        '),updatePanelProgress([]),closeDailyTaskPanel()}}}function clearMonth(){if(!confirm("¿Estás seguro de que quieres limpiar todas las tareas de este mes?"))return;const e=currentDate.getFullYear(),t=currentDate.getMonth(),n=[];if(Object.keys(tasks).forEach((a=>{const s=new Date(a+"T12:00:00");s.getFullYear()===e&&s.getMonth()===t&&(tasks[a].forEach((e=>{n.push({dateStr:a,taskId:e.id}),clearTaskNotifications(e.id)})),delete tasks[a])})),n.forEach((({dateStr:e,taskId:t})=>{enqueueSync("delete",e,{id:t})})),saveTasks(),renderCalendar(),updateProgress(),showNotification("Mes limpiado exitosamente"),selectedDateForPanel){const n=new Date(selectedDateForPanel+"T12:00:00");if(n.getFullYear()===e&&n.getMonth()===t){const e=document.getElementById("panelTaskList");e&&(e.innerHTML='\n          <div class="text-center py-8 text-gray-500">\n            <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n            <p>No hay tareas para este día</p>\n            <p class="text-sm mt-2">¡Todas las tareas del mes fueron eliminadas!</p>\n          </div>\n        '),updatePanelProgress([]),closeDailyTaskPanel()}}}function updateProgress(){const e=getTodayString(),t=tasks[e]||[],n=t.filter((e=>"completed"===e.state)).length,a=t.filter((e=>"inProgress"===e.state)).length,s=t.filter((e=>"paused"===e.state)).length,i=t.filter((e=>"pending"===e.state)).length,o=0===t.length?0:Math.round(n/t.length*100),r=document.getElementById("progressBar"),l=document.getElementById("progressText");r&&(r.style.width=`${o}%`),l&&(l.innerHTML=`\n            ${o}% | \n            <span class="text-green-600">${n} ✓</span> \n            <span class="text-blue-600">${a} ▶</span> \n            <span class="text-orange-600">${s} ⏸</span>\n            <span class="text-gray-600">${i} ⏸</span>\n        `)}function exportToExcel(){if("undefined"==typeof XLSX)return void showNotification("Error: XLSX library not loaded","error");if(!Object.keys(tasks).some((e=>tasks[e]&&tasks[e].length>0)))return void showNotification("No hay tareas para exportar","info");const e=XLSX.utils.book_new(),t=[["Fecha","Título","Descripción","Hora","Estado","Prioridad"]];Object.entries(tasks).forEach((([e,n])=>{n.forEach((n=>{const a=PRIORITY_LEVELS[n.priority]||PRIORITY_LEVELS[3],s=TASK_STATES[n.state]||TASK_STATES.pending;t.push([e,n.title,n.description||"",n.time||"",s.label,a.label])}))}));const n=XLSX.utils.aoa_to_sheet(t);XLSX.utils.book_append_sheet(e,n,"Tareas"),XLSX.writeFile(e,`tareas_${getTodayString()}.xlsx`),showNotification("Excel exportado exitosamente","success")}function toggleNotifications(){"Notification"in window?"granted"===Notification.permission?(notificationsEnabled=!notificationsEnabled,savePermissions(),updateNotificationButton(),notificationsEnabled?("vibrate"in navigator&&navigator.vibrate(getVibrationPattern("success")),startNotificationService(),showNotification("Notificaciones activadas","success")):(stopNotificationService(),showNotification("Notificaciones desactivadas","info"))):"default"===Notification.permission?requestNotificationPermissionWithVibration():showNotification("Los permisos fueron denegados. Actívalos en configuración del navegador.","error"):showNotification("Este navegador no soporta notificaciones","error")}function requestNotificationPermissionWithVibration(){return"Notification"in window?("vibrate"in navigator&&navigator.vibrate([100,50,100]),Notification.requestPermission().then((e=>(notificationsEnabled="granted"===e,savePermissions(),updateNotificationButton(),"granted"===e?(startNotificationService(),"vibrate"in navigator&&navigator.vibrate(getVibrationPattern("success")),showNotification("Notificaciones activadas correctamente","success"),setTimeout((()=>{showDesktopNotificationPWA("¡Notificaciones activadas!","Recibirás recordatorios de tus tareas","welcome",!1,"success")}),1e3)):showNotification("Permisos de notificación denegados","error"),e)))):(showNotification("Este navegador no soporta notificaciones","error"),Promise.resolve("denied"))}function startNotificationService(){notificationInterval&&(clearInterval(notificationInterval),notificationInterval=null),notificationsEnabled&&"granted"===Notification.permission&&(setTimeout((()=>{checkDailyTasksImproved(),sendTasksToServiceWorker()}),1e3),notificationInterval=setInterval((()=>{notificationsEnabled&&"granted"===Notification.permission?(checkDailyTasksImproved(),sendTasksToServiceWorker()):stopNotificationService()}),3e4))}function onPageVisibilityChange(){!document.hidden&&notificationsEnabled&&"granted"===Notification.permission&&checkDailyTasksImproved(!0)}function stopNotificationService(){notificationInterval&&(clearInterval(notificationInterval),notificationInterval=null)}function updateNotificationButton(){const e=document.getElementById("notificationsBtn");if(!e)return;const t="granted"===Notification.permission,n="text-white px-3 py-2 rounded-lg transition duration-300 text-xs md:text-sm font-normal md:font-bold";notificationsEnabled&&t?(e.className=`bg-green-500 hover:bg-green-600 ${n}`,e.innerHTML='<i class="fas fa-bell mr-2"></i>Notificaciones ON',e.title="Notificaciones activadas - Click para desactivar"):t?(e.className=`bg-gray-500 hover:bg-gray-600 ${n}`,e.innerHTML='<i class="fas fa-bell-slash mr-2"></i>Notificaciones OFF',e.title="Notificaciones desactivadas - Click para activar"):(e.className=`bg-yellow-500 hover:bg-yellow-600 ${n}`,e.innerHTML='<i class="fas fa-bell mr-2"></i>Permitir Notificaciones',e.title="Click para solicitar permisos de notificación")}function checkDailyTasksImproved(e=!1){if(!notificationsEnabled||"granted"!==Notification.permission)return;const t=new Date,n=getTodayString(),a=t.getHours(),s=t.getMinutes(),i=`${n}-reset`;!sentNotifications.has(i)&&0===a&&s<=1&&(notificationStatus.morning=!1,notificationStatus.midday=!1,notificationStatus.evening=!1,notificationStatus.taskReminders.clear(),sentNotifications.clear(),sentNotifications.add(i));const o=tasks[n]||[];o.forEach((e=>{if(!e.time||"completed"===e.state)return;const[t,n]=e.time.split(":").map(Number),i=60*t+n,o=60*a+s,r=`${e.id}-15min`;if(!notificationStatus.taskReminders.has(r)&&o>=i-15&&o<=i-13&&"pending"===e.state){const t=PRIORITY_LEVELS[e.priority]||PRIORITY_LEVELS[3];showDesktopNotificationPWA(`⏰ Recordatorio: ${e.title}`,`${t.label} - Inicia en 15 minutos (${e.time})`,r,!1,"task-reminder"),notificationStatus.taskReminders.add(r)}const l=`${e.id}-start`;if(!notificationStatus.taskReminders.has(l)&&o>=i&&o<=i+2&&"pending"===e.state){const t=PRIORITY_LEVELS[e.priority]||PRIORITY_LEVELS[3];showDesktopNotificationPWA(`🔔 Es hora de: ${e.title}`,`${t.label} programada para ${e.time}`,l,!0,"task-start"),showInAppNotification("⏰ Recordatorio de Tarea",`${e.title} - ${e.time}`,"task"),notificationStatus.taskReminders.add(l)}const c=`${e.id}-late`;!notificationStatus.taskReminders.has(c)&&o>=i+30&&"completed"!==e.state&&(showDesktopNotificationPWA(`⚠️ Tarea Retrasada: ${e.title}`,"inProgress"===e.state?"Aún en proceso":"No iniciada - 30min de retraso",c,!1,"task-late"),notificationStatus.taskReminders.add(c))}));const r=o.filter((e=>"pending"===e.state)),l=o.filter((e=>"inProgress"===e.state)),c=r.length+l.length;if(!notificationStatus.morning&&9===a&&s<=30&&c>0){let e="";r.length>0&&(e+=`${r.length} pendiente${r.length>1?"s":""}`),l.length>0&&(e&&(e+=" y "),e+=`${l.length} en proceso`),showDesktopNotificationPWA("🌅 Buenos días",`Tienes ${e} para hoy`,"morning",!1,"morning"),notificationStatus.morning=!0}!notificationStatus.midday&&12===a&&s<=30&&r.length>0&&(showDesktopNotificationPWA("🌞 Mediodía",`${r.length} tarea${r.length>1?"s":""} pendiente${r.length>1?"s":""}`,"midday",!1,"midday"),notificationStatus.midday=!0),!notificationStatus.evening&&18===a&&s<=30&&c>0&&(showDesktopNotificationPWA("🌆 Final del día",`${c} tarea${c>1?"s":""} sin completar`,"evening",!1,"evening"),notificationStatus.evening=!0)}function clearTaskNotifications(e){[`${e}-15min`,`${e}-start`,`${e}-late`].forEach((e=>{notificationStatus.taskReminders.delete(e),sentNotifications.delete(e)}))}function showNotification(e,t="success"){const n=document.createElement("div"),a={success:"bg-green-500 text-white fa-check-circle",error:"bg-red-500 text-white fa-exclamation-circle",info:"bg-blue-500 text-white fa-info-circle"},{className:s,icon:i}=t in a?{className:a[t].split(" ").slice(0,-1).join(" "),icon:a[t].split(" ").pop()}:{className:"bg-blue-500 text-white",icon:"fa-info-circle"};n.className=`fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${s}`,n.innerHTML=`\n        <div class="flex items-center space-x-2">\n            <i class="fas ${i}"></i>\n            <span>${e}</span>\n        </div>\n    `,document.body.appendChild(n),setTimeout((()=>n.classList.remove("translate-x-full")),100),setTimeout((()=>{n.classList.add("translate-x-full"),setTimeout((()=>n.remove()),300)}),3e3)}function showBulkEditModal(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n)return void showNotification("Tarea no encontrada","error");closeAllModals();const a=document.createElement("div");a.id="bulkEditModal",a.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",a.innerHTML=`\n    <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 max-h-[90vh] overflow-y-auto">\n      <div class="flex justify-between items-center mb-4">\n        <h3 class="text-lg font-semibold text-gray-800">\n          <i class="fas fa-layer-group text-blue-500 mr-2"></i>Editar Tarea Recurrente\n        </h3>\n        <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n\n      \x3c!-- Información de la tarea --\x3e\n      <div class="bg-blue-50 p-3 rounded-lg mb-4">\n        <p class="text-sm text-blue-800">\n          <i class="fas fa-info-circle mr-1"></i>\n          <strong>Tarea:</strong> ${n.title}\n        </p>\n        <p class="text-xs text-blue-600 mt-1">\n          Esta tarea se repite en múltiples días. Selecciona cómo deseas editarla:\n        </p>\n      </div>\n\n      \x3c!-- Opciones de edición --\x3e\n      <div class="space-y-3 mb-6">\n        <button onclick="editSingleTask('${e}', '${t}')" \n                class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 p-4 rounded-lg transition text-left">\n          <div class="flex items-center">\n            <i class="fas fa-calendar-day text-2xl mr-3"></i>\n            <div>\n              <div class="font-semibold">Editar solo esta tarea</div>\n              <div class="text-xs opacity-75">Cambios solo en ${new Date(e+"T12:00:00").toLocaleDateString("es-ES")}</div>\n            </div>\n          </div>\n        </button>\n\n        <button onclick="showBulkEditForm('${e}', '${t}', 'all')" \n                class="w-full bg-green-100 hover:bg-green-200 text-green-800 p-4 rounded-lg transition text-left">\n          <div class="flex items-center">\n            <i class="fas fa-calendar-alt text-2xl mr-3"></i>\n            <div>\n              <div class="font-semibold">Editar en todos los días</div>\n              <div class="text-xs opacity-75">Buscar y actualizar todas las ocurrencias</div>\n            </div>\n          </div>\n        </button>\n\n        <button onclick="showCustomDatesSelector('${e}', '${t}')" \n                class="w-full bg-purple-100 hover:bg-purple-200 text-purple-800 p-4 rounded-lg transition text-left">\n          <div class="flex items-center">\n            <i class="fas fa-calendar-check text-2xl mr-3"></i>\n            <div>\n              <div class="font-semibold">Editar en días personalizados</div>\n              <div class="text-xs opacity-75">Selecciona fechas específicas</div>\n            </div>\n          </div>\n        </button>\n      </div>\n\n      <button onclick="closeAllModals()" \n              class="w-full bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">\n        Cancelar\n      </button>\n    </div>\n  `,document.body.appendChild(a)}function editSingleTask(e,t){closeAllModals(),showAdvancedEditModal(e,t)}function showBulkEditForm(e,t,n="all"){const a=tasks[e]?.find((e=>e.id===t));if(!a)return;closeAllModals();const s=document.createElement("div");s.id="bulkEditFormModal",s.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",s.innerHTML=`\n    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">\n      <div class="flex justify-between items-center mb-4">\n        <h3 class="text-lg font-semibold text-gray-800">\n          <i class="fas fa-edit text-green-500 mr-2"></i>Edición Masiva\n        </h3>\n        <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n\n      <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4">\n        <p class="text-sm text-yellow-800">\n          <i class="fas fa-exclamation-triangle mr-1"></i>\n          Los cambios se aplicarán a <strong>todas las ocurrencias</strong> de esta tarea\n        </p>\n      </div>\n\n      <form id="bulkEditForm" class="space-y-4">\n        <input type="hidden" id="bulkMode" value="${n}">\n        <input type="hidden" id="originalTitle" value="${a.title}">\n        <input type="hidden" id="originalTime" value="${a.time||""}">\n\n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-2">\n            Nuevo Título <span class="text-red-500">*</span>\n          </label>\n          <input type="text" id="bulkEditTitle" value="${a.title}" required \n                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">\n        </div>\n\n        <div>\n          <label class="block text-sm font-medium text-gray-700 mb-2">\n            Nueva Descripción\n          </label>\n          <textarea id="bulkEditDescription" rows="3" \n                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">${a.description||""}</textarea>\n        </div>\n\n        <div class="grid grid-cols-2 gap-4">\n          <div>\n            <label class="block text-sm font-medium text-gray-700 mb-2">\n              Nueva Hora <span class="text-red-500">*</span>\n            </label>\n            <input type="time" id="bulkEditTime" value="${a.time||""}" required\n                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">\n          </div>\n          <div>\n            <label class="block text-sm font-medium text-gray-700 mb-2">\n              Nueva Prioridad <span class="text-red-500">*</span>\n            </label>\n            <select id="bulkEditPriority" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">\n              <option value="1" ${1===a.priority?"selected":""}>🔴 Muy Importante</option>\n              <option value="2" ${2===a.priority?"selected":""}>🟠 Importante</option>\n              <option value="3" ${3===a.priority?"selected":""}>🔵 Moderado</option>\n              <option value="4" ${4===a.priority?"selected":""}>⚫ No Prioritario</option>\n            </select>\n          </div>\n        </div>\n\n        <div id="bulkEditPreview" class="bg-gray-50 p-3 rounded text-sm text-gray-700">\n          <i class="fas fa-search mr-1"></i>\n          Buscando tareas similares...\n        </div>\n\n        <div class="flex space-x-3 pt-4 border-t">\n          <button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">\n            <i class="fas fa-save mr-2"></i>Aplicar Cambios\n          </button>\n          <button type="button" onclick="closeAllModals()" \n                  class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">\n            Cancelar\n          </button>\n        </div>\n      </form>\n    </div>\n  `,document.body.appendChild(s),setTimeout((()=>findSimilarTasks(a.title,a.time)),100),document.getElementById("bulkEditForm").addEventListener("submit",(n=>{n.preventDefault(),applyBulkEdit(e,t)}))}function findSimilarTasks(e,t){let n=0;const a=[];Object.entries(tasks).forEach((([s,i])=>{i.forEach((i=>{i.title===e&&i.time===t&&(n++,a.push(s))}))}));const s=document.getElementById("bulkEditPreview");return s&&(s.innerHTML=n>1?`\n        <i class="fas fa-check-circle text-green-600 mr-1"></i>\n        Se encontraron <strong>${n} tareas idénticas</strong> en el calendario\n        <div class="text-xs mt-2 text-gray-500">\n          Fechas: ${a.slice(0,5).map((e=>new Date(e+"T12:00:00").toLocaleDateString("es-ES",{day:"numeric",month:"short"}))).join(", ")}\n          ${n>5?` y ${n-5} más`:""}\n        </div>\n      `:'\n        <i class="fas fa-info-circle text-blue-600 mr-1"></i>\n        Solo se encontró esta tarea (no hay repeticiones)\n      '),{count:n,dates:a}}function applyBulkEdit(e,t){const n=document.getElementById("originalTitle").value,a=document.getElementById("originalTime").value,s=document.getElementById("bulkEditTitle").value.trim(),i=document.getElementById("bulkEditDescription").value.trim(),o=document.getElementById("bulkEditTime").value,r=parseInt(document.getElementById("bulkEditPriority").value),l=document.getElementById("bulkMode").value;if(!s||!o)return void showNotification("Completa todos los campos obligatorios","error");let c=0,d=[];if("custom"===l&&window.selectedCustomDates?d=window.selectedCustomDates:Object.entries(tasks).forEach((([e,t])=>{t.some((e=>e.title===n&&e.time===a))&&d.push(e)})),0===d.length)return void showNotification("No se encontraron tareas para actualizar","error");const u=`¿Actualizar ${d.length} tarea${d.length>1?"s":""} en ${d.length} día${d.length>1?"s":""}?`;if(confirm(u)&&(d.forEach((e=>{tasks[e]&&tasks[e].forEach(((t,l)=>{t.title===n&&t.time===a&&(tasks[e][l]={...t,title:s,description:i,time:o,priority:r},enqueueSync("upsert",e,tasks[e][l]),c++,addToChangeLog("edited",s,e,null,null,t.id))}))})),delete window.selectedCustomDates,saveTasks(),renderCalendar(),updateProgress(),closeAllModals(),showNotification(`✅ ${c} tarea${c>1?"s":""} actualizada${c>1?"s":""} en ${d.length} día${d.length>1?"s":""}`,"success"),selectedDateForPanel)){const e=new Date(selectedDateForPanel+"T12:00:00").getDate();showDailyTaskPanel(selectedDateForPanel,e)}}function showCustomDatesSelector(e,t){const n=tasks[e]?.find((e=>e.id===t));if(!n)return;closeAllModals();const a=[];Object.entries(tasks).forEach((([e,t])=>{t.some((e=>e.title===n.title&&e.time===n.time))&&a.push(e)}));const s=document.createElement("div");s.id="customDatesModal",s.className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",s.innerHTML=`\n    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">\n      <div class="flex justify-between items-center mb-4">\n        <h3 class="text-lg font-semibold text-gray-800">\n          <i class="fas fa-calendar-check text-purple-500 mr-2"></i>Seleccionar Fechas\n        </h3>\n        <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700">\n          <i class="fas fa-times"></i>\n        </button>\n      </div>\n\n      <p class="text-sm text-gray-600 mb-4">\n        Selecciona las fechas donde deseas aplicar los cambios:\n      </p>\n\n      <div class="mb-4">\n        <label class="flex items-center space-x-2 bg-blue-50 p-2 rounded cursor-pointer">\n          <input type="checkbox" id="selectAllDates" onchange="toggleAllDates(this)" class="rounded">\n          <span class="text-sm font-medium">Seleccionar todas (${a.length} fechas)</span>\n        </label>\n      </div>\n\n      <div id="datesGrid" class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-60 overflow-y-auto mb-4">\n        ${a.map((e=>`\n            <label class="flex items-center space-x-2 bg-gray-50 p-2 rounded hover:bg-gray-100 cursor-pointer">\n              <input type="checkbox" value="${e}" class="custom-date-checkbox rounded" checked>\n              <span class="text-sm">${new Date(e+"T12:00:00").toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})}</span>\n            </label>\n          `)).join("")}\n      </div>\n\n      <div class="flex space-x-3">\n        <button onclick="proceedWithCustomDates('${e}', '${t}')" \n                class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">\n          <i class="fas fa-arrow-right mr-2"></i>Continuar con Selección\n        </button>\n        <button onclick="closeAllModals()" \n                class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400">\n          Cancelar\n        </button>\n      </div>\n    </div>\n  `,document.body.appendChild(s)}function toggleAllDates(e){document.querySelectorAll(".custom-date-checkbox").forEach((t=>t.checked=e.checked))}function proceedWithCustomDates(e,t){const n=Array.from(document.querySelectorAll(".custom-date-checkbox:checked")).map((e=>e.value));0!==n.length?(window.selectedCustomDates=n,showBulkEditForm(e,t,"custom")):showNotification("Selecciona al menos una fecha","error")}function saveTasks(){try{localStorage.setItem("tasks",JSON.stringify(tasks)),localStorage.setItem("dailyTaskLogs",JSON.stringify(dailyTaskLogs))}catch(e){showNotification("Error al guardar tareas","error")}}function clearAll(){const e=Object.values(tasks).reduce(((e,t)=>e+t.length),0);if(0===e)return void showNotification("No hay tareas para eliminar","info");if(!confirm(`¿Estás seguro de que quieres eliminar TODAS las tareas del calendario? (${e} tareas)`))return;if(!confirm("⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER. ¿Continuar?"))return;const t=[];Object.entries(tasks).forEach((([e,n])=>{n.forEach((n=>{t.push({dateStr:e,taskId:n.id}),clearTaskNotifications(n.id)}))})),tasks={},saveTasks(),renderCalendar(),updateProgress(),closeDailyTaskPanel(),notificationStatus.taskReminders.clear(),notificationStatus.morning=!1,notificationStatus.midday=!1,notificationStatus.evening=!1,sentNotifications.clear(),t.forEach((({dateStr:e,taskId:t})=>{enqueueSync("delete",e,{id:t})})),showNotification(`${e} tareas eliminadas del calendario`,"success")}function sendTasksToServiceWorker(){if(!("serviceWorker"in navigator)||!navigator.serviceWorker.controller)return;const e=[];Object.keys(tasks).forEach((t=>{(tasks[t]||[]).forEach((n=>{e.push({id:n.id,title:n.title,time:n.time,state:n.state,priority:n.priority,date:t})}))})),navigator.serviceWorker.controller.postMessage({type:"CHECK_NOTIFICATIONS",tasks:e,timestamp:Date.now()})}function saveTasks(){try{localStorage.setItem("tasks",JSON.stringify(tasks)),localStorage.setItem("dailyTaskLogs",JSON.stringify(dailyTaskLogs)),sendTasksToServiceWorker()}catch(e){showNotification("Error al guardar tareas","error")}}document.addEventListener("DOMContentLoaded",(function(){setTimeout((()=>{registerPeriodicSync()}),2e3)})),window.addEventListener("appinstalled",(()=>{const e=document.getElementById("install-button");e&&(e.style.display="none",e.classList.add("hidden")),installButtonShown=!1,deferredPrompt=null,showNotification("Aplicación instalada correctamente","success")})),"complete"!==document.readyState&&"interactive"!==document.readyState||setupEventListeners(),document.addEventListener("visibilitychange",onPageVisibilityChange),setInterval((()=>{currentUser&&isOnline&&!isSyncing&&(0===syncQueue.size?syncFromFirebase():processSyncQueue())}),6e5),window.addEventListener("beforeunload",(()=>{syncQueue.size>0&&currentUser&&isOnline&&navigator.sendBeacon&&navigator.sendBeacon("/sync-beacon",JSON.stringify({uid:currentUser.uid,operations:Array.from(syncQueue.values())}))})),document.addEventListener("visibilitychange",(()=>{!document.hidden&&syncQueue.size>0&&currentUser&&isOnline&&setTimeout((()=>processSyncQueue()),1e3)})),document.addEventListener("DOMContentLoaded",(function(){isOnline=navigator.onLine,setupNetworkListeners();localStorage.getItem("firebase_auth_active");loadTasks(),loadPermissions(),renderCalendar(),updateProgress(),setupEventListeners(),setupDragAndDrop(),setupTaskTooltips(),setupDateInput(),initNotifications(),isOnline?initFirebase():(currentUser={isOffline:!0},updateUI(),hideLoadingScreen()),setTimeout((()=>{if(handleServiceWorkerMessages(),initializeTodayPanel(),isPWAInstalled()){configurePWAFeatures();const e=document.getElementById("install-button");e&&(e.style.display="none",e.classList.add("hidden"))}}),100)}));