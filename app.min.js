const firebaseConfig = { apiKey: "AIzaSyD9Lwkgd9NqJ5I0termPqVZxNxFk5Y-J4s", authDomain: "calendario-tareas-app.firebaseapp.com", projectId: "calendario-tareas-app", storageBucket: "calendario-tareas-app.firebasestorage.app", messagingSenderId: "646091363424", appId: "1:646091363424:web:d923bbcc0224bd1bed5f05" }; let tasks = {}, currentDate = new Date, notificationsEnabled = !1, draggedTask = null, draggedFromDate = null, lastDeletedTask = null, lastDeletedDate = null, isOnline = navigator.onLine, currentUser = null, db = null, auth = null, notificationInterval = null, sentNotifications = new Set, notificationStatus = { morning: !1, midday: !1, evening: !1, taskReminders: new Set }, syncQueue = new Map, syncTimeout = null, isSyncing = !1, lastSyncTime = 0; const SYNC_DEBOUNCE_TIME = 2e3; let dailyTaskLogs = JSON.parse( localStorage.getItem( "dailyTaskLogs" ) || "{}" ); const PERMISSIONS_KEY = "app_permissions", USER_PREFERENCES_KEY = "user_preferences", TASK_STATES = { pending: { label: "Pendiente", class: "bg-gray-200 text-gray-800", icon: "fa-clock" }, inProgress: { label: "En Proceso", class: "bg-blue-200 text-blue-800", icon: "fa-play" }, paused: { label: "Pausada", class: "bg-orange-200 text-orange-800", icon: "fa-pause" }, completed: { label: "Completada", class: "bg-green-200 text-green-800", icon: "fa-check" } }, PRIORITY_LEVELS = { 1: { label: "Muy Importante", class: "bg-red-500 text-white", color: "#EF4444" }, 2: { label: "Importante", class: "bg-orange-400 text-white", color: "#F97316" }, 3: { label: "Moderado", class: "bg-blue-400 text-white", color: "#3B82F6" }, 4: { label: "No Prioritario", class: "bg-gray-400 text-white", color: "#6B7280" } }; let deferredPrompt, installButtonShown = !1; function handleInstallClick() { if ( !deferredPrompt ) return; const e = document.getElementById( "install-button" ); e && ( e.disabled = !0, e.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Instalando...' ), deferredPrompt.prompt(), deferredPrompt.userChoice.then( ( t => { "accepted" === t.outcome ? e && ( e.style.display = "none", e.classList.add( "hidden" ) ) : e && ( e.disabled = !1, e.innerHTML = '<i class="fas fa-download mr-2"></i>Instalar App' ), deferredPrompt = null } ) ) } "serviceWorker" in navigator && window.addEventListener( "load", ( () => { navigator.serviceWorker.register( "/sw.js" ).then( ( e => { } ) ).catch( ( e => { } ) ) } ) ), window.addEventListener( "beforeinstallprompt", ( e => { if ( isPWAInstalled() ) return; e.preventDefault(), deferredPrompt = e; const t = document.getElementById( "install-button" ); t && !installButtonShown && ( t.style.display = "block", t.classList.remove( "hidden" ), installButtonShown = !0, t.addEventListener( "click", handleInstallClick ) ) } ) ); let selectedDateForPanel = getTodayString(); function showDesktopNotificationPWA( e, t, a, n = !1, s = "default" ) { if ( !notificationsEnabled || "granted" !== Notification.permission ) return showInAppNotification( e, t, "info" ), !1; if ( a && sentNotifications.has( a ) ) return !1; const i = { body: t, icon: "/images/IconLogo.png", badge: "/images/favicon-192.png", tag: a || `notification-${Date.now()}`, renotify: !0, requireInteraction: n, silent: !1, vibrate: getVibrationPattern( s ), data: { timestamp: Date.now(), tag: a, requiresAction: n, type: s } }; try { if ( ( window.matchMedia( "(display-mode: standalone)" ).matches || !0 === window.navigator.standalone ) && "serviceWorker" in navigator && navigator.serviceWorker.controller ) navigator.serviceWorker.controller.postMessage( { type: "SHOW_NOTIFICATION", title: e, body: t, tag: a, requiresAction: n, notificationType: s } ); else { const t = new Notification( e, i ); t.onclick = () => { if ( window.focus(), t.close(), a && a.includes( "-now" ) ) { showDailyTaskPanel( getTodayString(), ( new Date ).getDate() ) } }, n || setTimeout( ( () => t.close() ), 8e3 ) } return a && sentNotifications.add( a ), "vibrate" in navigator && navigator.vibrate( getVibrationPattern( s ) ), !0 } catch ( a ) { return showInAppNotification( e, t, "info" ), !1 } } function getVibrationPattern( e ) { const t = { default: [ 200, 100, 200 ], "task-reminder": [ 300, 100, 300 ], "task-start": [ 200, 50, 200, 50, 400 ], "task-late": [ 100, 100, 100, 100, 100 ], success: [ 200, 100, 200 ], morning: [ 300, 200, 300 ], midday: [ 200, 100, 200 ], evening: [ 400, 200, 400 ] }; return t[ e ] || t.default } function showInAppNotification( e, t, a = "info" ) { const n = document.createElement( "div" ); n.className = `fixed top-20 right-4 ${{ task: "bg-blue-500", success: "bg-green-500", warning: "bg-orange-500", info: "bg-gray-600" }[ a ]} text-white px-4 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full max-w-sm`, n.innerHTML = `\n    <div class="flex items-start space-x-3">\n      <i class="fas ${{ task: "fa-tasks", success: "fa-check-circle", warning: "fa-exclamation-triangle", info: "fa-info-circle" }[ a ]} mt-1 flex-shrink-0"></i>\n      <div class="flex-1">\n        <div class="font-semibold text-sm">${e}</div>\n        <div class="text-xs opacity-90 mt-1">${t}</div>\n      </div>\n      <button onclick="this.parentElement.parentElement.remove()" \n              class="text-white hover:text-gray-200 ml-2 flex-shrink-0">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  `, document.body.appendChild( n ), setTimeout( ( () => n.classList.remove( "translate-x-full" ) ), 100 ), setTimeout( ( () => { n.classList.add( "translate-x-full" ), setTimeout( ( () => n.remove() ), 300 ) } ), 5e3 ) } function isPWAInstalled() { return window.matchMedia( "(display-mode: standalone)" ).matches || !0 === window.navigator.standalone || document.referrer.includes( "android-app://" ) } function addToChangeLog( e, t, a, n = null, s = null, i = null ) { const o = new Date, r = { id: Date.now().toString(), action: e, taskTitle: t, taskId: i, oldState: n, newState: s, timestamp: o.toISOString(), time: o.toLocaleTimeString( "es-ES", { hour: "2-digit", minute: "2-digit", second: "2-digit" } ), date: a, readableDate: new Date( a + "T12:00:00" ).toLocaleDateString( "es-ES", { weekday: "long", year: "numeric", month: "long", day: "numeric" } ) }; dailyTaskLogs[ a ] || ( dailyTaskLogs[ a ] = [] ), dailyTaskLogs[ a ].unshift( r ), dailyTaskLogs[ a ].length > 50 && ( dailyTaskLogs[ a ] = dailyTaskLogs[ a ].slice( 0, 50 ) ), "stateChanged" === e && "completed" === s && i && calculateTaskDuration( a, i, t ), localStorage.setItem( "dailyTaskLogs", JSON.stringify( dailyTaskLogs ) ) } function calculateTaskDuration( e, t, a ) { const n = dailyTaskLogs[ e ] || [], s = n.find( ( e => e.taskId === t && "stateChanged" === e.action && "completed" === e.newState ) ), i = n.slice().reverse().find( ( e => e.taskId === t && "stateChanged" === e.action && "inProgress" === e.newState ) ); if ( s && i && !s.duration ) { const e = new Date( i.timestamp ), t = new Date( s.timestamp ) - e; if ( t > 0 ) { const e = Math.floor( t / 36e5 ), a = Math.floor( t % 36e5 / 6e4 ); let n = ""; n = e > 0 ? `${e}h ${a}min` : `${a}min`, s.duration = n, s.durationMs = t, localStorage.setItem( "dailyTaskLogs", JSON.stringify( dailyTaskLogs ) ) } } } function showDayChangeLog( e ) { const t = dailyTaskLogs[ e ] || [], a = new Date( e + "T12:00:00" ), n = document.createElement( "div" ); n.id = "dayChangeLogModal", n.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4", n.innerHTML = `\n        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">\n            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">\n                <h3 class="text-lg font-semibold text-gray-800">\n                    <i class="fas fa-history text-blue-500 mr-2"></i>\n                    Registro de actividad del ${a.toLocaleDateString( "es-ES", { weekday: "long", day: "numeric", month: "long" } )}\n                </h3>\n                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <div class="p-6 overflow-y-auto max-h-96">\n                ${0 === t.length ? '\n                    <div class="text-center py-8 text-gray-500">\n                        <i class="fas fa-clipboard-list text-4xl mb-3 opacity-50"></i>\n                        <p>No hay registros para este día</p>\n                    </div>\n                ' : `\n                    <div class="space-y-3">\n                        ${t.map( ( e => `\n                            <div class="bg-gray-50 rounded-lg p-4 border-l-4 ${getDayLogColor( e.action )}">\n                                <div class="flex justify-between items-start">\n                                    <div class="flex-1">\n                                        <div class="font-medium text-sm text-gray-800">\n                                            ${getDayLogIcon( e.action )} ${getDayLogMessage( e )}\n                                        </div>\n                                        <div class="text-xs text-gray-500 mt-1 flex items-center space-x-3">\n                                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-mono">\n                                                ${e.time}\n                                            </span>\n                                            ${e.taskId ? `<span class="text-gray-400">ID: ${e.taskId.substring( 0, 8 )}...</span>` : ""}\n                                        </div>\n                                        ${getStateChangeInfo( e )}\n                                        ${e.duration ? `\n                                            <div class="mt-2 bg-green-100 text-green-800 px-2 py-1 rounded text-xs inline-block">\n                                                <i class="fas fa-stopwatch mr-1"></i>\n                                                Tiempo total: ${e.duration}\n                                            </div>\n                                        ` : ""}\n                                    </div>\n                                </div>\n                            </div>\n                        ` ) ).join( "" )}\n                    </div>\n                `}\n                <div class="mt-6 flex justify-end space-x-3">\n                    ${t.length > 0 ? `\n                        <button onclick="clearDayChangeLog('${e}')" \n                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">\n                            <i class="fas fa-trash mr-2"></i>Limpiar Registro\n                        </button>\n                    ` : ""}\n                    <button onclick="closeAllModals()" \n                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">\n                        Cerrar\n                    </button>\n                </div>\n            </div>\n        </div>\n    `, document.body.appendChild( n ) } function getDayLogColor( e ) { return { created: "border-green-500", stateChanged: "border-blue-500", paused: "border-orange-500", resumed: "border-blue-500", edited: "border-yellow-500", deleted: "border-red-500", moved: "border-purple-500" }[ e ] || "border-gray-500" } function getDayLogIcon( e ) { return { created: '<i class="fas fa-plus text-green-600"></i>', stateChanged: '<i class="fas fa-sync-alt text-blue-600"></i>', paused: '<i class="fas fa-pause text-orange-600"></i>', resumed: '<i class="fas fa-play text-blue-600"></i>', edited: '<i class="fas fa-edit text-yellow-600"></i>', deleted: '<i class="fas fa-trash text-red-600"></i>', moved: '<i class="fas fa-arrows-alt text-purple-600"></i>' }[ e ] || '<i class="fas fa-info text-gray-600"></i>' } function getDayLogMessage( e ) { return { created: `Tarea creada: "${e.taskTitle}"`, stateChanged: `"${e.taskTitle}": cambio de estado`, paused: `"${e.taskTitle}": pausada temporalmente`, resumed: `"${e.taskTitle}": reanudada`, edited: `Tarea editada: "${e.taskTitle}"`, deleted: `Tarea eliminada: "${e.taskTitle}"`, moved: `Tarea movida: "${e.taskTitle}"` }[ e.action ] || `Cambio en: "${e.taskTitle}"` } function getStateChangeInfo( e ) { if ( ( "stateChanged" === e.action || "paused" === e.action || "resumed" === e.action ) && e.oldState && e.newState ) { const t = { pending: "Pendiente", inProgress: "En Proceso", paused: "Pausada", completed: "Completada" }; return `\n            <div class="text-xs text-blue-600 mt-1 bg-blue-50 px-2 py-1 rounded">\n                ${t[ e.oldState ] || e.oldState} → ${t[ e.newState ] || e.newState}\n            </div>\n        ` } return "" } function clearDayChangeLog( e ) { if ( dailyTaskLogs[ e ] && 0 !== dailyTaskLogs[ e ].length ) { if ( confirm( "¿Eliminar todos los registros de cambios de este día?" ) ) { if ( delete dailyTaskLogs[ e ], saveTaskLogs(), selectedDateForPanel === e ) { const t = new Date( e + "T12:00:00" ), a = tasks[ e ] || []; updatePanelDateHeader( e, t.getDate(), a ) } showNotification( "Registros de cambios eliminados", "success" ), closeAllModals() } } else showNotification( "No hay registros para eliminar", "info" ) } function enqueueSync( e, t, a ) { if ( !a || !a.id ) return; if ( !currentUser || !isOnline ) return; const n = `${e}-${t}-${a.id}`, s = Date.now(), i = syncQueue.get( n ); if ( i && s - i.timestamp < 2e3 ) return; for ( const [ e, t ] of syncQueue ) s - t.timestamp > 6e5 && syncQueue.delete( e ); syncQueue.set( n, { operation: e, dateStr: t, task: { ...a }, timestamp: s, attempts: 0 } ), updateSyncIndicator( "pending" ); const o = isPWAInstalled() ? window.PWA_SYNC_DEBOUNCE_TIME || 1e3 : 2e3; syncTimeout && clearTimeout( syncTimeout ), syncTimeout = setTimeout( ( () => { syncQueue.size > 0 && !isSyncing && currentUser && isOnline && processSyncQueue() } ), o ) } async function processSyncQueue() { if ( currentUser ) if ( isOnline ) if ( db ) { if ( !isSyncing ) if ( 0 !== syncQueue.size ) { isSyncing = !0, updateSyncIndicator( "syncing" ); try { const e = Array.from( syncQueue.values() ), t = db.collection( "users" ).doc( currentUser.uid ).collection( "tasks" ), a = 150; let n = 0; for ( let s = 0; s < e.length; s += a ) { const i = db.batch(), o = e.slice( s, s + a ); for ( const e of o ) { const a = `${e.dateStr}_${e.task?.id}`, s = t.doc( a ); switch ( e.operation ) { case "upsert": e.task && ( i.set( s, { ...e.task, date: e.dateStr, lastModified: new Date }, { merge: !0 } ), n++ ); break; case "delete": i.delete( s ), n++; break } } n > 0 && await i.commit() } syncQueue.clear(), lastSyncTime = Date.now(), updateSyncIndicator( "success" ), n >= 3 && showNotification( `${n} cambios sincronizados`, "success" ) } catch ( e ) { "permission-denied" === e.code ? ( showNotification( "Error de permisos en Firebase", "error" ), updateSyncIndicator( "error" ) ) : "unavailable" === e.code ? ( showNotification( "Firebase temporalmente no disponible", "error" ), updateSyncIndicator( "pending" ), setTimeout( ( () => { syncQueue.size > 0 && processSyncQueue() } ), 1e4 ) ) : ( updateSyncIndicator( "error" ), showNotification( "Error de sincronización: " + e.message, "error" ) ) } finally { isSyncing = !1 } } else updateSyncIndicator( "success" ) } else updateSyncIndicator( "error" ); else updateSyncIndicator( "offline" ); else updateSyncIndicator( "offline" ) } async function syncToFirebase() { if ( !currentUser || !isOnline ) return void showNotification( "No hay conexión disponible", "error" ); if ( isSyncing ) return void showNotification( "Sincronización en progreso...", "info" ); const e = document.getElementById( "syncBtn" ), t = e ? e.innerHTML : ""; try { e && ( e.disabled = !0, e.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sincronizando...' ), syncQueue.size > 0 && await processSyncQueue(), isSyncing = !0, updateSyncIndicator( "syncing" ); const a = db.collection( "users" ).doc( currentUser.uid ).collection( "tasks" ), n = []; if ( Object.entries( tasks ).forEach( ( ( [ e, t ] ) => { t.forEach( ( t => { n.push( { ...t, date: e, lastModified: new Date } ) } ) ) } ) ), n.length > 0 ) { const e = db.batch(); n.forEach( ( t => { const n = a.doc( `${t.date}_${t.id}` ); e.set( n, t, { merge: !0 } ) } ) ), await e.commit() } const s = await a.get(); let i = 0; if ( !s.empty ) { const e = {}; s.forEach( ( t => { const a = t.data(), n = a.date; e[ n ] || ( e[ n ] = [] ), e[ n ].push( { id: a.id, title: a.title, description: a.description || "", time: a.time || "", completed: a.completed || !1 } ) } ) ), Object.keys( e ).forEach( ( t => { tasks[ t ] || ( tasks[ t ] = [] ), e[ t ].forEach( ( e => { tasks[ t ].some( ( t => t.id === e.id || t.title === e.title && t.time === e.time ) ) || ( tasks[ t ].push( e ), i++ ) } ) ) } ) ), i > 0 && ( saveTasks(), renderCalendar(), updateProgress() ) } updateSyncIndicator( "success" ); showNotification( n.length + i > 0 ? `Sincronización completa: ${n.length} subidas, ${i} descargadas` : "Todo está sincronizado", "success" ), notificationsEnabled && "granted" === Notification.permission && ( stopNotificationService(), setTimeout( ( () => startNotificationService() ), 1e3 ) ) } catch ( e ) { updateSyncIndicator( "error" ), showNotification( "Error en sincronización: " + e.message, "error" ) } finally { isSyncing = !1, e && ( e.disabled = !1, e.innerHTML = t || '<i class="fas fa-sync-alt mr-2"></i>Sincronizar' ) } } function exportToExcelOffline() { if ( "undefined" == typeof XLSX ) return void showNotification( "Funcionalidad de exportación no disponible sin conexión", "error" ); const e = XLSX.utils.book_new(), t = [ [ "Fecha", "Título", "Descripción", "Hora", "Estado", "Prioridad" ] ]; Object.entries( tasks ).forEach( ( ( [ e, a ] ) => { a.forEach( ( a => { const n = PRIORITY_LEVELS[ a.priority ] || PRIORITY_LEVELS[ 3 ], s = TASK_STATES[ a.state ] || TASK_STATES.pending; t.push( [ e, a.title, a.description || "", a.time || "", s.label, n.label ] ) } ) ) } ) ); const a = XLSX.utils.aoa_to_sheet( t ); XLSX.utils.book_append_sheet( e, a, "Tareas" ); const n = `tareas_offline_${getTodayString()}.xlsx`; XLSX.writeFile( e, n ), showNotification( `Excel exportado: ${n}`, "success" ) } function getTodayString() { const e = new Date; return `${e.getFullYear()}-${String( e.getMonth() + 1 ).padStart( 2, "0" )}-${String( e.getDate() ).padStart( 2, "0" )}` } function isDatePast( e ) { const t = new Date, a = new Date( e + "T00:00:00" ); return t.setHours( 0, 0, 0, 0 ), a.setHours( 0, 0, 0, 0 ), a < t } function setupDateInput() { const e = document.getElementById( "taskDate" ), t = document.getElementById( "taskTime" ); if ( e ) { const t = getTodayString(); e.setAttribute( "min", t ), e.value = t } if ( t ) { const e = new Date, a = String( e.getHours() ).padStart( 2, "0" ), n = String( e.getMinutes() ).padStart( 2, "0" ); t.value = `${a}:${n}` } } function initFirebase() { try { if ( !navigator.onLine ) return void initOfflineMode(); firebase.apps.length || firebase.initializeApp( firebaseConfig ), db = firebase.firestore(), auth = firebase.auth(), setupFirebasePersistence(), auth.onAuthStateChanged( ( e => { currentUser = e, updateUI(), e && navigator.onLine ? ( updateSyncIndicator( "success" ), setTimeout( ( () => { isOnline && !isSyncing && syncFromFirebase() } ), 1e3 ) ) : e || ( updateSyncIndicator( "offline" ), cleanupUIOnLogout() ) } ) ), hideLoadingScreen() } catch ( e ) { showNotification( "Error conectando con el servidor", "error" ), initOfflineMode() } } async function setupFirebasePersistence() { try { await auth.setPersistence( firebase.auth.Auth.Persistence.LOCAL ), await db.enablePersistence( { synchronizeTabs: !0 } ) } catch ( e ) { } } function configurePWAFirebase() { db && db.settings( { cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED, experimentalForceLongPolling: !1 } ), setupPWAReconnection(), "serviceWorker" in navigator && navigator.serviceWorker.ready.then( ( e => { "sync" in window.ServiceWorkerRegistration.prototype && e.sync.register( "firebase-sync" ).then( ( () => { } ) ).catch( ( e => { } ) ) } ) ) } function setupPWAReconnection() { let e = 0; const t = () => { e >= 5 || navigator.onLine && currentUser && ( e++, db.collection( "test" ).limit( 1 ).get().then( ( () => { e = 0, updateSyncIndicator( "success" ), syncQueue.size > 0 && setTimeout( ( () => processSyncQueue() ), 500 ) } ) ).catch( ( a => { e < 5 && setTimeout( t, 2e3 * e ) } ) ) ) }; window.addEventListener( "online", ( () => { e = 0, setTimeout( t, 1e3 ) } ) ), window.addEventListener( "firebase-connection-lost", t ) } function initOfflineMode() { isOnline = !1, currentUser = getOfflineUser(); const e = document.getElementById( "firebaseStatus" ); e && e.classList.add( "force-hidden" ), updateUI(), hideLoadingScreen(), showOfflineModeMessage(), setupOfflineFeatures() } function showOfflineModeMessage() { const e = document.createElement( "div" ); e.id = "offlineModeMessage", e.className = "fixed bottom-4 right-4 bg-gray-800 text-white text-sm px-4 py-2 rounded-lg shadow-lg z-30 transition-all duration-300", e.innerHTML = '\n    <div class="flex items-center space-x-2">\n      <i class="fas fa-hard-drive text-yellow-400"></i>\n      <span>Modo local activo</span>\n      <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-gray-300 hover:text-white">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  ', document.body.appendChild( e ), setTimeout( ( () => { document.getElementById( "offlineModeMessage" ) && e.remove() } ), 5e3 ) } function getOfflineUser() { let e = localStorage.getItem( "offlineUser" ); return e ? e = JSON.parse( e ) : ( e = { uid: "offline-" + Date.now(), displayName: "Usuario Offline", email: "usuario@offline.local", photoURL: null, isOffline: !0 }, localStorage.setItem( "offlineUser", JSON.stringify( e ) ) ), e } function setupOfflineFeatures() { notificationInterval && clearInterval( notificationInterval ), updateOfflineUI() } function shouldShowSyncIndicators() { return currentUser && !currentUser.isOffline && isOnline } function updateOfflineUI() { [ { id: "loginBtn", text: "Sin conexión para login" }, { id: "logoutBtn", text: "Logout offline" } ].forEach( ( ( { id: e, text: t } ) => { const a = document.getElementById( e ); a && ( a.title = t, isOnline ? a.classList.remove( "opacity-50" ) : a.classList.add( "opacity-50" ) ) } ) ) } function showOfflineMessage() { const e = document.createElement( "div" ); e.id = "offlineMessage", e.className = "fixed top-16 left-4 right-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 p-4 rounded-lg shadow-lg z-40", e.innerHTML = '\n    <div class="flex items-start">\n      <div class="flex-shrink-0">\n        <i class="fas fa-wifi-slash text-orange-500"></i>\n      </div>\n      <div class="ml-3 flex-1">\n        <p class="text-sm font-medium">\n          Modo Sin Conexión Activo\n        </p>\n        <p class="text-xs mt-1">\n          • Tus tareas se guardan localmente<br>\n          • Se sincronizarán cuando vuelva la conexión<br>\n          • Funcionalidad limitada disponible\n        </p>\n        <div class="mt-2 flex items-center space-x-2 text-xs">\n          <span class="flex items-center">\n            <i class="fas fa-check text-green-600 mr-1"></i>\n            Crear/editar tareas\n          </span>\n          <span class="flex items-center">\n            <i class="fas fa-times text-red-600 mr-1"></i>\n            Sync en tiempo real\n          </span>\n        </div>\n      </div>\n      <button onclick="hideOfflineMessage()" class="flex-shrink-0 ml-4 text-orange-400 hover:text-orange-600">\n        <i class="fas fa-times"></i>\n      </button>\n    </div>\n  '; const t = document.getElementById( "offlineMessage" ); t && t.remove(), document.body.appendChild( e ), setTimeout( ( () => { document.getElementById( "offlineMessage" ) && hideOfflineMessage() } ), 1e4 ) } function hideOfflineMessage() { const e = document.getElementById( "offlineMessage" ); e && e.remove() } function savePermissions() { const e = { notifications: { permission: Notification.permission, enabled: notificationsEnabled, timestamp: Date.now() } }; try { localStorage.setItem( PERMISSIONS_KEY, JSON.stringify( e ) ) } catch ( e ) { } } function loadPermissions() { try { const e = localStorage.getItem( PERMISSIONS_KEY ); if ( e ) { const t = JSON.parse( e ); if ( "granted" === Notification.permission && "granted" === t.notifications?.permission ) return notificationsEnabled = !1 !== t.notifications.enabled, !0 } "granted" === Notification.permission && ( notificationsEnabled = !0, savePermissions() ) } catch ( e ) { notificationsEnabled = "granted" === Notification.permission } return !1 } function initNotifications() { if ( "Notification" in window ) { if ( "granted" === Notification.permission ) void 0 === notificationsEnabled && ( notificationsEnabled = !0 ), updateNotificationButton(), notificationsEnabled && startNotificationService(); else if ( "default" === Notification.permission ) { ( window.matchMedia( "(display-mode: standalone)" ).matches || !0 === window.navigator.standalone ) && setTimeout( ( () => { requestNotificationPermissionWithVibration() } ), 2e3 ) } updateNotificationButton() } } function setupNetworkListeners() { window.addEventListener( "online", handleOnline ), window.addEventListener( "offline", handleOffline ), setInterval( ( () => { const e = navigator.onLine; e !== isOnline && ( e ? handleOnline() : handleOffline() ) } ), 3e4 ) } function handleOnline() { if ( isOnline = !0, hideOfflineMessage(), currentUser && currentUser.isOffline ) initFirebase(); else if ( currentUser ) { updateSyncIndicator( "success" ), updateOfflineUI(); const e = isPWAInstalled() ? 500 : 1e3; setTimeout( ( () => { syncQueue.size > 0 ? processSyncQueue().then( ( () => { setTimeout( syncFromFirebase, 1e3 ) } ) ) : syncFromFirebase() } ), e ), isPWAInstalled() ? showDesktopNotificationPWA( "Conexión restaurada", "Sincronizando tareas...", "connection-restored" ) : showNotification( "Conexión restaurada. Sincronizando...", "success" ) } } function handleOffline() { isOnline = !1, updateOfflineUI(), currentUser && !currentUser.isOffline && ( updateSyncIndicator( "offline" ), showOfflineMessage(), showNotification( "Trabajando sin conexión. Los cambios se sincronizarán cuando vuelva internet.", "info" ) ) } function handleServiceWorkerMessages() { "serviceWorker" in navigator && navigator.serviceWorker.addEventListener( "message", ( e => { const { type: t, data: a } = e.data; switch ( t ) { case "NOTIFICATION_CLICKED": if ( window.focus(), a.taskId ) { showDailyTaskPanel( getTodayString(), ( new Date ).getDate() ) } break; case "SYNC_REQUIRED": currentUser && isOnline && processSyncQueue(); break } } ) ) } function cleanupUIOnLogout() { const e = document.getElementById( "firebaseStatus" ); e && e.classList.add( "hidden", "force-hidden" ); document.querySelectorAll( ".notification" ).forEach( ( e => { const t = e.textContent.toLowerCase(); ( t.includes( "sincroniz" ) || t.includes( "firebase" ) || t.includes( "conexión" ) ) && e.remove() } ) ), syncTimeout && ( clearTimeout( syncTimeout ), syncTimeout = null ) } function updateSyncIndicator( e ) { const t = document.getElementById( "firebaseStatus" ), a = document.getElementById( "statusIcon" ), n = document.getElementById( "statusText" ); if ( !currentUser || currentUser.isOffline || !t || !a || !n ) return void ( t && t.classList.add( "hidden" ) ); if ( t.classList.contains( "force-hidden" ) ) return; const s = syncQueue.size, i = { success: { class: "bg-green-500 text-white", icon: "fa-check-circle", text: s > 0 ? `${s} pendientes` : "Sincronizado", autoHide: 0 === s }, error: { class: "bg-red-500 text-white", icon: "fa-exclamation-triangle", text: "Error de sincronización", autoHide: !1 }, syncing: { class: "bg-blue-500 text-white", icon: "fa-sync-alt fa-spin", text: "Sincronizando...", autoHide: !1 }, pending: { class: "bg-orange-500 text-white", icon: "fa-clock", text: `${s} cambios pendientes`, autoHide: !1 } }, o = i[ e ] || i.success; t.className = `fixed top-4 left-4 px-3 py-2 rounded-lg text-sm font-medium z-40 transition-all duration-300 ${o.class}`, a.className = `fas ${o.icon} mr-2`, n.textContent = o.text, t.classList.remove( "hidden" ), o.autoHide && setTimeout( ( () => { 0 === syncQueue.size && n.textContent === o.text && t.classList.add( "hidden" ) } ), 3e3 ) } function hideLoadingScreen() { const e = document.getElementById( "loadingScreen" ); e.style.opacity = "0", setTimeout( ( () => { e.style.display = "none" } ), 300 ) } function updateUI() { const e = document.getElementById( "loginBtn" ), t = document.getElementById( "userInfo" ), a = document.getElementById( "syncBtn" ), n = document.getElementById( "firebaseStatus" ), s = document.getElementById( "install-button" ); if ( currentUser && !currentUser.isOffline ) { if ( e && ( e.classList.add( "hidden" ), e.className = e.className.replace( /bg-\w+-\d+/g, "" ), e.className += " bg-blue-600 hover:bg-blue-700" ), t ) { t.classList.remove( "hidden" ); const e = document.getElementById( "userName" ), a = document.getElementById( "userEmail" ), n = document.getElementById( "userPhoto" ); e && ( e.textContent = currentUser.displayName || "Usuario" ), a && ( a.textContent = currentUser.email || "" ), n && ( n.src = currentUser.photoURL || "https://via.placeholder.com/32", n.onerror = () => n.src = "https://via.placeholder.com/32" ) } a && ( a.classList.remove( "hidden" ), a.disabled = !1 ), n && n.classList.remove( "force-hidden" ) } else e && ( e.classList.remove( "hidden" ), e.className = e.className.replace( /bg-\w+-\d+/g, "" ).replace( /text-\w+-\d+/g, "" ), e.className += " bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200" ), t && t.classList.add( "hidden" ), a && a.classList.add( "hidden" ), n && n.classList.add( "force-hidden" ); s && ( isPWAInstalled() ? ( s.style.display = "none", s.classList.add( "hidden" ) ) : deferredPrompt && !installButtonShown && ( s.style.display = "block", s.classList.remove( "hidden" ) ) ) } async function signInWithGoogle() { try { const e = document.getElementById( "loginBtn" ); e && ( e.disabled = !0, e.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Conectando...' ); const t = new firebase.auth.GoogleAuthProvider; t.addScope( "profile" ), t.addScope( "email" ), t.setCustomParameters( { prompt: "select_account" } ); ( await auth.signInWithPopup( t ) ).user && ( showNotification( "Sesión iniciada correctamente", "success" ), closeLoginModal() ) } catch ( e ) { let t = "Error al iniciar sesión"; switch ( e.code ) { case "auth/popup-closed-by-user": t = "Ventana de login cerrada"; break; case "auth/network-request-failed": t = "Error de conexión"; break; case "auth/too-many-requests": t = "Demasiados intentos. Intenta más tarde"; break; default: t = `Error: ${e.message}` }showNotification( t, "error" ) } finally { const e = document.getElementById( "loginBtn" ); e && ( e.disabled = !1, e.innerHTML = '<i class="fab fa-google mr-2"></i>Iniciar Sesión' ) } } function signOut() { confirm( "¿Estás seguro de que quieres cerrar sesión?" ) && ( cleanupUIOnLogout(), auth.signOut().then( ( () => { showNotification( "Sesión cerrada", "info" ) } ) ).catch( ( e => { } ) ) ) } async function syncFromFirebase() { if ( currentUser && isOnline && !isSyncing ) { isSyncing = !0, updateSyncIndicator( "syncing" ); try { const e = db.collection( "users" ).doc( currentUser.uid ).collection( "tasks" ), t = await e.get(); if ( t.empty ) return void updateSyncIndicator( "success" ); const a = {}, n = new Set; t.forEach( ( e => { const t = e.data(), s = t.date; a[ s ] || ( a[ s ] = [] ); const i = { id: t.id, title: t.title, description: t.description || "", time: t.time || "", completed: t.completed || !1, state: t.state || "pending", priority: t.priority || 3 }; a[ s ].push( i ), n.add( t.id ) } ) ); let s = 0, i = 0; if ( Object.keys( a ).forEach( ( e => { tasks[ e ] || ( tasks[ e ] = [] ), a[ e ].forEach( ( t => { const a = tasks[ e ].findIndex( ( e => e.id === t.id ) ); if ( -1 === a ) { tasks[ e ].find( ( e => e.title === t.title && e.time === t.time && Math.abs( new Date( e.id.split( "-" )[ 0 ] ) - new Date( t.id.split( "-" )[ 0 ] ) ) < 5e3 ) ) || ( tasks[ e ].push( t ), s++ ) } else { const n = tasks[ e ][ a ]; JSON.stringify( n ) !== JSON.stringify( t ) && ( tasks[ e ][ a ] = { ...n, ...t }, i++ ) } } ) ) } ) ), s > 0 || i > 0 ) { saveTasks(), renderCalendar(), updateProgress(); const e = []; s > 0 && e.push( `${s} nuevas` ), i > 0 && e.push( `${i} actualizadas` ), showNotification( `Tareas sincronizadas: ${e.join( ", " )}`, "success" ) } updateSyncIndicator( "success" ), notificationsEnabled && "granted" === Notification.permission && ( stopNotificationService(), setTimeout( startNotificationService, 1e3 ) ) } catch ( e ) { updateSyncIndicator( "error" ), showNotification( "Error al sincronizar", "error" ) } finally { isSyncing = !1 } } } function forceSyncNow() { syncTimeout && ( clearTimeout( syncTimeout ), syncTimeout = null ), processSyncQueue() } function setupEventListeners() { if ( "loading" === document.readyState ) return void document.addEventListener( "DOMContentLoaded", setupEventListeners ); const e = { taskForm: addTask, prevMonth: () => changeMonth( -1 ), nextMonth: () => changeMonth( 1 ), taskRepeat: toggleCustomDays, clearWeekBtn: clearWeek, clearMonthBtn: clearMonth, exportExcelBtn: exportToExcel, notificationsBtn: toggleNotifications, syncBtn: syncToFirebase, loginBtn: showLoginModal, logoutBtn: signOut, googleSignInBtn: signInWithGoogle, closeLoginModal: closeLoginModal, resetFormBtn: resetForm, clearAllBtn: clearAll }; Object.entries( e ).forEach( ( ( [ e, t ] ) => { const a = document.getElementById( e ); a && a.addEventListener( "FORM" === a.tagName ? "submit" : "click", t ) } ) ); const t = document.getElementById( "closePanelBtn" ), a = document.getElementById( "addQuickTaskBtn" ); t && t.addEventListener( "click", closeDailyTaskPanel ), a && a.addEventListener( "click", addQuickTaskToSelectedDay ); const n = document.getElementById( "repeatDuration" ), s = document.querySelectorAll( '#customDays input[type="checkbox"]' ), i = document.getElementById( "taskDate" ); n && n.addEventListener( "change", updateRepeatPreview ), i && i.addEventListener( "change", updateRepeatPreview ), s.forEach( ( e => { e.addEventListener( "change", updateRepeatPreview ) } ) ) } function configurePWAFeatures() { document.addEventListener( "gesturestart", ( e => e.preventDefault() ) ), document.addEventListener( "gesturechange", ( e => e.preventDefault() ) ), document.addEventListener( "gestureend", ( e => e.preventDefault() ) ), document.body.style.overscrollBehavior = "contain"; const e = document.querySelector( 'meta[name="viewport"]' ); e && isPWAInstalled() && ( e.content = "width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" ), syncTimeout && clearTimeout( syncTimeout ); window.PWA_SYNC_DEBOUNCE_TIME = 1e3 } function initializeTodayPanel() { const e = getTodayString(), t = new Date; selectedDateForPanel = e; const a = tasks[ e ] || [], n = window.innerWidth >= 768, s = window.matchMedia( "(display-mode: standalone)" ).matches || !0 === window.navigator.standalone || window.location.search.includes( "pwa=true" ); ( n && !s || a.some( ( e => "completed" !== e.state ) ) ) && showDailyTaskPanel( e, t.getDate() ) } function resetForm() { const e = document.getElementById( "taskForm" ), t = document.getElementById( "advancedRepeatConfig" ), a = document.getElementById( "customDays" ), n = document.getElementById( "repeatDuration" ); e.reset(), t?.classList.add( "hidden" ), a?.classList.add( "hidden" ), n && ( n.value = "2" ); document.querySelectorAll( '#customDays input[type="checkbox"]' ).forEach( ( e => { e.checked = !1 } ) ), setupDateInput(), showNotification( "Formulario reiniciado", "info" ); const s = document.getElementById( "taskTime" ); s && ( s.addEventListener( "change", ( () => { setTimeout( ( () => { s.blur() } ), 100 ) } ) ), s.addEventListener( "keydown", ( e => { "Enter" === e.key && s.blur() } ) ) ), document.addEventListener( "change", ( e => { "time" === e.target.type && setTimeout( ( () => { e.target.blur() } ), 100 ) } ) ), document.addEventListener( "keydown", ( e => { "time" === e.target.type && "Enter" === e.key && e.target.blur() } ) ) } function showLoginModal() { const e = document.getElementById( "loginModal" ); if ( e ) e.classList.remove( "hidden" ); else { document.querySelector( ".fixed.inset-0.bg-black" ); showNotification( "Error: Modal de login no disponible", "error" ) } } function closeLoginModal() { document.getElementById( "loginModal" ).classList.add( "hidden" ) } function loadTasks() { try { const e = localStorage.getItem( "tasks" ); tasks = e ? JSON.parse( e ) : {}, loadTaskLogs() } catch ( e ) { tasks = {}, dailyTaskLogs = {} } } function toggleCustomDays() { const e = document.getElementById( "taskRepeat" ), t = document.getElementById( "advancedRepeatConfig" ), a = document.getElementById( "customDays" ); "none" === e.value ? t?.classList.add( "hidden" ) : ( t?.classList.remove( "hidden" ), a?.classList.toggle( "hidden", "custom" !== e.value ), updateRepeatPreview() ) } function updateRepeatPreview() { const e = document.getElementById( "taskRepeat" ).value, t = document.getElementById( "repeatDuration" ).value, a = document.getElementById( "previewText" ), n = document.getElementById( "taskDate" ).value; if ( !a || "none" === e ) return; const s = { 1: "lo que resta del mes actual", 2: "lo que resta del mes actual y todo el mes siguiente", 3: "los próximos 3 meses", 6: "los próximos 6 meses", 12: "el próximo año" }; let i = `Se creará ${{ daily: "todos los días", weekdays: "días de semana (Lun-Vie)", weekends: "fines de semana (Sáb-Dom)", weekly: "cada semana (mismo día)", custom: "días personalizados" }[ e ]} durante ${s[ t ]}`; if ( "custom" === e ) { const e = Array.from( document.querySelectorAll( "#customDays input:checked" ) ); if ( e.length > 0 ) { const a = [ "Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb" ]; i = `Se creará los ${e.map( ( e => a[ parseInt( e.value ) ] ) ).join( ", " )} durante ${s[ t ]}` } else i = "Selecciona al menos un día" } const o = calculateExactTaskCount( e, parseInt( t ), n ); o > 0 && ( i += ` (~${o} tareas)` ), a.textContent = i } function calculateExactTaskCount( e, t, a ) { const n = a ? new Date( a + "T00:00:00" ) : new Date; let s; 1 === t ? s = new Date( n.getFullYear(), n.getMonth() + 1, 0 ) : ( s = new Date( n ), s.setMonth( s.getMonth() + t ), s = new Date( s.getFullYear(), s.getMonth(), 0 ) ); let i = 0, o = new Date( n ), r = []; if ( "custom" === e && ( r = Array.from( document.querySelectorAll( "#customDays input:checked" ) ).map( ( e => parseInt( e.value ) ) ), 0 === r.length ) ) return 0; for ( ; o <= s; ) { const t = o.getDay(); let a = !1; switch ( e ) { case "daily": a = !0; break; case "weekdays": a = t >= 1 && t <= 5; break; case "weekends": a = 0 === t || 6 === t; break; case "weekly": a = t === n.getDay(); break; case "custom": a = r.includes( t ); break }const s = o.toISOString().split( "T" )[ 0 ]; a && !isDatePast( s ) && i++, o.setDate( o.getDate() + 1 ) } return i } function addTask( e ) { e.preventDefault(); const t = { title: document.getElementById( "taskTitle" ).value.trim(), description: document.getElementById( "taskDescription" ).value.trim(), date: document.getElementById( "taskDate" ).value, time: document.getElementById( "taskTime" ).value, repeat: document.getElementById( "taskRepeat" ).value, priority: parseInt( document.getElementById( "taskPriority" ).value ) || 3, initialState: document.getElementById( "taskInitialState" )?.value || "pending" }; if ( !t.title ) return; if ( t.date && isDatePast( t.date ) ) return void showNotification( "No puedes agregar tareas a fechas anteriores. Por favor selecciona hoy o una fecha futura.", "error" ); const a = { id: Date.now().toString(), title: t.title, description: t.description, time: t.time, priority: t.priority, state: t.initialState, completed: "completed" === t.initialState }; if ( t.date && "none" === t.repeat ) addTaskToDate( t.date, a ), enqueueSync( "upsert", t.date, a ), addToChangeLog( "created", a.title, t.date ); else if ( "none" !== t.repeat ) { const e = t.date ? new Date( t.date + "T00:00:00" ) : new Date; addRecurringTasks( a, t.repeat, e ) } saveTasks(), renderCalendar(), updateProgress(), document.getElementById( "taskForm" ).reset(), setupDateInput(), showNotification( "Tarea agregada exitosamente" ); const n = document.getElementById( "advancedRepeatConfig" ), s = document.getElementById( "customDays" ), i = document.getElementById( "repeatDuration" ); n?.classList.add( "hidden" ), s?.classList.add( "hidden" ), i && ( i.value = "2" ); const o = document.getElementById( "taskPriority" ), r = document.getElementById( "taskInitialState" ); o && ( o.value = "3" ), r && ( r.value = "pending" ) } function addTaskToDate( e, t ) { tasks[ e ] || ( tasks[ e ] = [] ); const a = { ...t, id: `${e}-${Date.now()}` }; if ( tasks[ e ].push( a ), selectedDateForPanel === e ) { showDailyTaskPanel( e, new Date( e + "T12:00:00" ).getDate() ) } return a } function addRecurringTasks( e, t, a ) { const n = document.getElementById( "repeatDuration" ), s = n ? parseInt( n.value ) : 2; let i, o = new Date( a ), r = 0; 1 === s ? i = new Date( a.getFullYear(), a.getMonth() + 1, 0 ) : ( i = new Date( a ), i.setMonth( i.getMonth() + s ), i = new Date( i.getFullYear(), i.getMonth(), 0 ) ); let d = []; "custom" === t && ( d = Array.from( document.querySelectorAll( "#customDays input:checked" ) ).map( ( e => parseInt( e.value ) ) ) ); const l = []; for ( ; o <= i; ) { const n = o.toISOString().split( "T" )[ 0 ], s = o.getDay(); let i = !1; switch ( t ) { case "daily": i = !0; break; case "weekdays": i = s >= 1 && s <= 5; break; case "weekends": i = 0 === s || 6 === s; break; case "weekly": i = s === a.getDay(); break; case "custom": i = d.includes( s ) && d.length > 0; break }if ( i && !isDatePast( n ) ) { const t = addTaskToDate( n, e ); l.push( { dateStr: n, task: t } ), r++ } o.setDate( o.getDate() + 1 ) } l.forEach( ( ( { dateStr: e, task: t } ) => { enqueueSync( "upsert", e, t ) } ) ); showNotification( `${r} tareas agregadas para ${{ 1: "lo que resta del mes actual", 2: "lo que resta del mes actual y todo el mes siguiente", 3: "los próximos 3 meses", 6: "los próximos 6 meses", 12: "el próximo año" }[ s.toString() ] || `${s} meses`}`, "success" ) } function renderCalendar() { const e = document.getElementById( "calendar" ), t = document.getElementById( "currentMonth" ); if ( !e || !t ) return; e.innerHTML = "", t.textContent = currentDate.toLocaleDateString( "es-ES", { month: "long", year: "numeric" } ).replace( /^\w/, ( e => e.toUpperCase() ) );[ "Dom", "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb" ].forEach( ( t => { const a = document.createElement( "div" ); a.className = "text-center font-semibold text-gray-600 py-2", a.textContent = t, e.appendChild( a ) } ) ); const a = new Date( currentDate.getFullYear(), currentDate.getMonth(), 1 ), n = new Date( currentDate.getFullYear(), currentDate.getMonth() + 1, 0 ).getDate(), s = a.getDay(); for ( let t = 0; t < s; t++ ) { const t = document.createElement( "div" ); t.className = "h-24 border border-gray-200", e.appendChild( t ) } for ( let t = 1; t <= n; t++ ) { const a = new Date( currentDate.getFullYear(), currentDate.getMonth(), t ).toISOString().split( "T" )[ 0 ], n = tasks[ a ] || []; e.appendChild( createDayElement( t, a, n ) ) } } function createDayElement( e, t, a ) { const n = document.createElement( "div" ), s = getTodayString(), i = t === s, o = isDatePast( t ); return n.className = `h-24 border border-gray-200 p-1 cursor-pointer hover:bg-blue-50 transition relative calendar-day group ${i ? "bg-blue-100 border-blue-300 ring-2 ring-blue-200" : ""} ${o ? "opacity-75" : ""}`, n.dataset.date = t, n.innerHTML = `\n        <div class="font-semibold text-sm mb-1 ${i ? "text-blue-700" : ""}">${e}</div>\n        <div class="space-y-1">\n            ${a.slice( 0, 2 ).map( ( e => createTaskElement( e, t ) ) ).join( "" )}\n            ${a.length > 2 ? `\n                <div class="text-xs text-gray-500 cursor-pointer hover:text-blue-600 transition-colors" \n                     onclick="showDailyTaskPanel('${t}', ${e})">\n                    +${a.length - 2} más\n                </div>\n            ` : ""}\n        </div>\n        ${o ? "" : `\n            <button onclick="event.stopPropagation(); showQuickAddTask('${t}')"\n                    class="absolute bottom-1 right-1 w-6 h-6 bg-green-500 text-white rounded-full text-xs opacity-0 group-hover:opacity-100 transition-opacity duration-200 hover:bg-green-600 flex items-center justify-center"\n                    title="Agregar tarea rápida">\n                <i class="fas fa-plus"></i>\n            </button>\n        `}\n    `, n.addEventListener( "click", ( a => { a.target.closest( ".task-item" ) || a.target.closest( "button" ) || showDailyTaskPanel( t, e ) } ) ), n } function updatePanelDateHeader( e, t, a ) { const n = document.getElementById( "panelDate" ), s = document.getElementById( "panelActionButtons" ), i = new Date( e + "T12:00:00" ), o = dailyTaskLogs[ e ] || []; n.innerHTML = `\n        <i class="fas fa-tasks text-indigo-600 mr-2"></i>\n        Tareas del ${i.toLocaleDateString( "es-ES", { weekday: "long", year: "numeric", month: "long", day: "numeric" } )}\n    `; s.querySelectorAll( "button:not(#closePanelBtn)" ).forEach( ( e => e.remove() ) ); const r = document.createElement( "div" ); if ( r.className = "flex items-center space-x-2", a.length > 0 ) { const t = document.createElement( "button" ); t.onclick = () => clearDayTasks( e ), t.className = "flex items-center space-x-1 text-red-600 hover:text-red-700 text-sm px-2 py-1 rounded hover:bg-red-50 transition", t.title = "Eliminar todas las tareas del día", t.innerHTML = '\n            <i class="fas fa-trash-alt"></i>\n            <span class="hidden sm:inline">Limpiar Día</span>\n        ', r.appendChild( t ) } const d = document.createElement( "button" ); d.onclick = () => showDayChangeLog( e ), d.className = "flex items-center space-x-1 text-purple-600 hover:text-purple-700 text-sm px-2 py-1 rounded hover:bg-purple-50 transition", d.title = "Ver registro de cambios del día", d.innerHTML = `\n        <i class="fas fa-history"></i>\n        <span class="hidden sm:inline">Registro</span>\n        ${o.length > 0 ? `<span class="bg-purple-100 text-purple-700 text-xs px-1.5 py-0.5 rounded-full ml-1">${o.length}</span>` : ""}\n    `, r.appendChild( d ); const l = document.getElementById( "closePanelBtn" ); s.insertBefore( r, l ) } function showDailyTaskPanel( e, t ) { const a = document.getElementById( "dailyTaskPanel" ), n = document.getElementById( "panelDate" ), s = document.getElementById( "panelTaskList" ); if ( !a || !n || !s ) return; selectedDateForPanel = e; const i = tasks[ e ] || [], o = ( new Date( e + "T12:00:00" ), isDatePast( e ) ), r = e === getTodayString(); if ( updatePanelDateHeader( e, t, i ), 0 === i.length ) s.innerHTML = `\n      <div class="text-center py-8 text-gray-500">\n        <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n        <p>No hay tareas para este día</p>\n        ${o ? "" : `<p class="text-sm mt-2">${r ? "¡Agrega tu primera tarea de hoy!" : "¡Agrega tu primera tarea!"}</p>`}\n      </div>\n    `; else { const t = sortTasksByPriority( i ); s.innerHTML = t.map( ( t => createPanelTaskElement( t, e ) ) ).join( "" ) } updatePanelProgress( i ); const d = document.getElementById( "addQuickTaskBtn" ); d && ( d.style.display = o ? "none" : "flex" ), a.classList.remove( "hidden" ), window.innerWidth < 768 && setTimeout( ( () => { a.scrollIntoView( { behavior: "smooth", block: "start" } ) } ), 100 ) } function sortTasksByPriority( e ) { return e.sort( ( ( e, t ) => e.priority !== t.priority ? e.priority - t.priority : e.time && t.time ? e.time.localeCompare( t.time ) : e.time && !t.time ? -1 : !e.time && t.time ? 1 : e.title.localeCompare( t.title ) ) ) } function createPanelTaskElement( e, t ) { const a = isDatePast( t ), n = PRIORITY_LEVELS[ e.priority ] || PRIORITY_LEVELS[ 3 ], s = TASK_STATES[ e.state ] || TASK_STATES.pending, i = "inProgress" === e.state, o = "paused" === e.state; return `\n        <div class="panel-task-item bg-white rounded-lg shadow-md p-4 mb-4 border-l-4 transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5" \n             style="border-left-color: ${n.color}" \n             data-priority="${e.priority}">\n            <div class="flex sm:items-center sm:justify-between">\n                <div class="flex-1 sm:flex sm:items-start sm:space-x-3">\n                    \x3c!-- Select de estado y prioridad --\x3e\n                    <div class="flex flex-col space-y-2 mb-3 sm:mb-0">\n                        ${a ? `\n                            <div class="text-xs p-2 rounded-lg ${s.class} font-medium">\n                                <i class="fas ${s.icon}"></i> ${s.label}\n                            </div>\n                        ` : `\n                            <select onchange="changeTaskStateDirect('${t}', '${e.id}', this.value)" \n                                    class="text-xs p-2 rounded-lg border ${s.class} font-medium cursor-pointer transition-colors duration-200"\n                                    title="Cambiar estado de la tarea">\n                                <option value="pending" ${"pending" === e.state ? "selected" : ""}>⏸ Pendiente</option>\n                                <option value="inProgress" ${"inProgress" === e.state ? "selected" : ""}>▶ En Proceso</option>\n                                <option value="completed" ${"completed" === e.state ? "selected" : ""}>✓ Completada</option>\n                            </select>\n                        `}\n                        <div class="flex items-center space-x-2">\n                            <span class="task-priority-dot inline-block w-3 h-3 rounded-full shadow-sm" \n                                  style="background-color: ${n.color}" \n                                  title="Prioridad: ${n.label}"></span>\n                            <span class="text-xs text-gray-600 font-medium">${n.label}</span>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Información de la tarea --\x3e\n                    <div class="flex-1">\n                        <div class="task-title font-semibold text-base ${"completed" === e.state ? "line-through text-gray-500" : "text-gray-800"}">${e.title}</div>\n                        ${e.description ? `<div class="task-description text-sm text-gray-600 mt-1">${e.description}</div>` : '<div class="task-description text-sm text-gray-400 mt-1 italic">Sin descripción</div>'}\n                        <div class="task-meta flex flex-wrap items-center gap-3 mt-2 text-xs">\n                            ${e.time ? `<div class="text-indigo-600"><i class="far fa-clock mr-1"></i>${e.time}</div>` : ""}\n                            <div class="text-gray-500">${s.label}</div>\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- Botones de acción: Verticales en móvil, horizontales en desktop --\x3e\n                ${a ? "" : `\n                    <div class="task-actions flex flex-col space-y-1 ml-4 sm:flex-row sm:items-center sm:space-y-0 sm:space-x-1 sm:ml-0">\n                        ${i ? `\n                            <button onclick="pauseTask('${t}', '${e.id}')"\n                                    class="flex items-center space-x-1 bg-orange-100 text-orange-700 px-3 py-2 rounded-lg hover:bg-orange-200 transition-colors duration-200 text-xs font-medium shadow-sm"\n                                    title="Pausar tarea activa">\n                                <i class="fas fa-pause"></i>\n                                <span>Pausar</span>\n                            </button>\n                        ` : ""}\n                        ${o ? `\n                            <button onclick="resumeTask('${t}', '${e.id}')"\n                                    class="flex items-center space-x-1 bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors duration-200 text-xs font-medium shadow-sm"\n                                    title="Reanudar tarea pausada">\n                                <i class="fas fa-play"></i>\n                                <span>Reanudar</span>\n                            </button>\n                        ` : ""}\n                        <button onclick="showAdvancedEditModal('${t}', '${e.id}')"\n                                class="text-blue-500 hover:text-blue-700 p-2 rounded-lg hover:bg-blue-50 transition-colors duration-200"\n                                title="Editar título, descripción, hora y prioridad">\n                            <i class="fas fa-edit text-sm"></i>\n                        </button>\n                        <button onclick="showDayChangeLog('${t}')"\n                                class="text-purple-500 hover:text-purple-700 p-2 rounded-lg hover:bg-purple-50 transition-colors duration-200"\n                                title="Ver registro de cambios del día">\n                            <i class="fas fa-history text-sm"></i>\n                        </button>\n                        <button onclick="deleteTaskFromPanel('${t}', '${e.id}')"\n                                class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-colors duration-200"\n                                title="Eliminar tarea permanentemente">\n                            <i class="fas fa-trash text-sm"></i>\n                        </button>\n                    </div>\n                `}\n            </div>\n        </div>\n    ` } function pauseTask( e, t ) { const a = tasks[ e ]?.find( ( e => e.id === t ) ); if ( !a || "inProgress" !== a.state ) return void showNotification( "Solo se pueden pausar tareas en proceso", "error" ); const n = a.state; if ( a.state = "paused", a.completed = !1, addToChangeLog( "paused", a.title, e, n, "paused", t ), saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "upsert", e, a ), selectedDateForPanel === e ) { showDailyTaskPanel( e, new Date( e + "T12:00:00" ).getDate() ) } showNotification( "Tarea pausada", "info" ) } function resumeTask( e, t ) { const a = tasks[ e ]?.find( ( e => e.id === t ) ); if ( !a || "paused" !== a.state ) return void showNotification( "Solo se pueden reanudar tareas pausadas", "error" ); const n = a.state; if ( a.state = "inProgress", a.completed = !1, addToChangeLog( "resumed", a.title, e, n, "inProgress", t ), saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "upsert", e, a ), selectedDateForPanel === e ) { showDailyTaskPanel( e, new Date( e + "T12:00:00" ).getDate() ) } showNotification( "Tarea reanudada", "success" ) } function showDeletedTasksModal() { closeAllModals(); const e = JSON.parse( localStorage.getItem( "deletedTasks" ) || "[]" ), t = document.createElement( "div" ); t.id = "deletedTasksModal", t.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4", t.innerHTML = `\n        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">\n            <div class="sticky top-0 bg-white border-b p-6 flex justify-between items-center">\n                <h3 class="text-lg font-semibold text-gray-800">\n                    <i class="fas fa-trash text-red-500 mr-2"></i>Tareas Eliminadas\n                </h3>\n                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <div class="p-6 overflow-y-auto max-h-96">\n                ${0 === e.length ? '\n                    <div class="text-center py-8 text-gray-500">\n                        <i class="fas fa-check-circle text-4xl mb-3 opacity-50"></i>\n                        <p>No hay tareas eliminadas</p>\n                    </div>\n                ' : `\n                    <div class="space-y-3">\n                        ${e.map( ( ( e, t ) => `\n                            <div class="bg-red-50 rounded-lg p-3 border-l-4 border-red-500">\n                                <div class="flex justify-between items-start">\n                                    <div class="flex-1">\n                                        <div class="font-medium text-sm text-gray-800">\n                                            <i class="fas fa-trash text-red-600 mr-1"></i>\n                                            "${e.title}"\n                                        </div>\n                                        <div class="text-xs text-gray-500 mt-1">\n                                            Fecha: ${e.date} • Eliminada: ${e.formattedDeleteTime}\n                                        </div>\n                                        <div class="text-xs text-red-600 mt-1">\n                                            ID: ${e.id}\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        ` ) ).join( "" )}\n                    </div>\n                `}\n                <div class="mt-6 flex justify-end space-x-3">\n                    ${e.length > 0 ? '\n                        <button onclick="clearDeletedTasks()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">\n                            <i class="fas fa-eraser mr-2"></i>Limpiar Lista\n                        </button>\n                    ' : ""}\n                    <button onclick="closeAllModals()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">\n                        Cerrar\n                    </button>\n                </div>\n            </div>\n        </div>\n    `, document.body.appendChild( t ) } function clearDeletedTasks() { confirm( "¿Estás seguro de que quieres limpiar la lista de tareas eliminadas?" ) && ( localStorage.removeItem( "deletedTasks" ), showNotification( "Lista de tareas eliminadas limpiada", "success" ), closeAllModals() ) } function clearDayTasks( e ) { const t = tasks[ e ] || []; if ( 0 === t.length ) return void showNotification( "No hay tareas para eliminar en este día", "info" ); const a = new Date( e + "T12:00:00" ), n = a.toLocaleDateString( "es-ES", { weekday: "long", day: "numeric", month: "long" } ); if ( !confirm( `¿Seguro que quieres eliminar todas las ${t.length} tareas del ${n}?` ) ) return; currentUser && isOnline && ( t.forEach( ( t => { enqueueSync( "delete", e, { id: t.id } ), clearTaskNotifications( t.id ) } ) ), setTimeout( ( () => { syncQueue.size > 0 && processSyncQueue() } ), 100 ) ), delete tasks[ e ], delete dailyTaskLogs[ e ], saveTasks(), saveTaskLogs(), renderCalendar(), updateProgress(), updatePanelDateHeader( e, a.getDate(), [] ), updatePanelProgress( [] ); const s = document.getElementById( "panelTaskList" ); s && ( s.innerHTML = '\n      <div class="text-center py-8 text-gray-500">\n        <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n        <p>No hay tareas para este día</p>\n        <p class="text-sm mt-2">¡Todas las tareas del día fueron eliminadas!</p>\n      </div>\n    ' ), closeDailyTaskPanel(), showNotification( `${t.length} tareas eliminadas del ${n}`, "success" ) } function createTaskElement( e, t ) { const a = PRIORITY_LEVELS[ e.priority ] || PRIORITY_LEVELS[ 3 ], n = TASK_STATES[ e.state ] || TASK_STATES.pending; return `\n        <div class="task-item-wrapper relative group/task">\n            <div class="text-xs p-1 rounded ${n.class} truncate task-item cursor-move pr-8 border-l-4" \n                 data-task-id="${e.id}"\n                 data-date="${t}"\n                 draggable="true"\n                 style="border-left-color: ${a.color}"\n                 title="${e.title}${e.time ? " - " + e.time : ""} | ${n.label} | ${a.label}">\n                <i class="fas ${n.icon} mr-1 opacity-75"></i>\n                ${e.title}\n                ${e.time ? `<span class="text-xs opacity-75 ml-1">${e.time}</span>` : ""}\n            </div>\n            <div class="absolute right-0 top-0 h-full flex items-center opacity-0 group-hover/task:opacity-100 transition-opacity duration-200 bg-gradient-to-l from-white via-white to-transparent pl-2">\n                <button onclick="event.stopPropagation(); quickEditTaskAdvanced('${t}', '${e.id}')"\n                        class="text-blue-500 hover:text-blue-700 text-xs p-1 rounded hover:bg-blue-100"\n                        title="Editar tarea completa">\n                    <i class="fas fa-edit"></i>\n                </button>\n                <button onclick="event.stopPropagation(); quickDeleteTask('${t}', '${e.id}')"\n                        class="text-red-500 hover:text-red-700 text-xs p-1 rounded hover:bg-red-100 ml-1"\n                        title="Eliminar tarea permanentemente">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </div>\n        </div>\n    ` } function updatePanelProgress( e ) { const t = document.getElementById( "panelProgressBar" ), a = document.getElementById( "panelProgressText" ); if ( !t || !a ) return; const n = e.filter( ( e => "completed" === e.state ) ).length, s = e.filter( ( e => "inProgress" === e.state ) ).length, i = e.filter( ( e => "paused" === e.state ) ).length, o = e.filter( ( e => "pending" === e.state ) ).length, r = 0 === e.length ? 0 : Math.round( n / e.length * 100 ); t.style.width = `${r}%`, a.innerHTML = `\n        ${r}% | \n        <span class="text-green-600">${n} ✓</span> \n        <span class="text-blue-600">${s} ▶</span> \n        <span class="text-orange-600">${i} ⏸</span>\n        <span class="text-gray-600">${o} ⏸</span>\n    ` } function deleteTaskFromPanel( e, t ) { const a = tasks[ e ]?.find( ( e => e.id === t ) ); if ( a && confirm( `¿Eliminar la tarea "${a.title}"?` ) && ( deleteTaskWithUndoImproved( e, t ), selectedDateForPanel === e ) ) { showDailyTaskPanel( e, new Date( e + "T12:00:00" ).getDate() ) } } function showAdvancedEditModal( e, t ) { const a = tasks[ e ]?.find( ( e => e.id === t ) ); if ( !a ) return void showNotification( "Tarea no encontrada", "error" ); if ( isDatePast( e ) ) return void showNotification( "No puedes editar tareas de fechas pasadas", "error" ); closeAllModals(); const n = document.createElement( "div" ); n.id = "advancedEditModal", n.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4", n.innerHTML = `\n        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">\n            <div class="flex justify-between items-center mb-4">\n                <h3 class="text-lg font-semibold text-gray-800">\n                    <i class="fas fa-edit text-blue-500 mr-2"></i>Editar Tarea\n                </h3>\n                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <form id="advancedEditTaskForm" class="space-y-4">\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Título <span class="text-red-500">*</span></label>\n                    <input type="text" id="advancedEditTaskTitle" value="${a.title || ""}" required \n                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>\n                    <textarea id="advancedEditTaskDescription" rows="3" \n                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${a.description || ""}</textarea>\n                </div>\n                <div class="grid grid-cols-2 gap-4">\n                    <div>\n                        <label class="block text-sm font-medium text-gray-700 mb-2">Hora <span class="text-red-500">*</span></label>\n                        <input type="time" id="advancedEditTaskTime" value="${a.time || ""}" required\n                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                    </div>\n                    <div>\n                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridad <span class="text-red-500">*</span></label>\n                        <select id="advancedEditTaskPriority" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                            <option value="" disabled>Selecciona una prioridad</option>\n                            <option value="1" ${1 === a.priority ? "selected" : ""}>🔴 Muy Importante</option>\n                            <option value="2" ${2 === a.priority ? "selected" : ""}>🟠 Importante</option>\n                            <option value="3" ${3 === a.priority ? "selected" : ""}>🔵 Moderado</option>\n                            <option value="4" ${4 === a.priority ? "selected" : ""}>⚫ No Prioritario</option>\n                        </select>\n                    </div>\n                </div>\n                <div class="bg-blue-50 p-3 rounded-lg">\n                    <p class="text-sm text-blue-700">\n                        <i class="fas fa-info-circle mr-1"></i>\n                        Estado actual: <strong>${TASK_STATES[ a.state ].label}</strong>\n                        <br>\n                        <span class="text-xs">Usa los controles en el panel principal para cambiar el estado.</span>\n                    </p>\n                </div>\n                <div class="flex space-x-3 pt-4 border-t">\n                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">\n                        <i class="fas fa-save mr-2"></i>Guardar Cambios\n                    </button>\n                    <button type="button" onclick="closeAllModals()" \n                            class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">\n                        Cancelar\n                    </button>\n                </div>\n            </form>\n        </div>\n    `, document.body.appendChild( n ), document.getElementById( "advancedEditTaskForm" ).addEventListener( "submit", ( a => { a.preventDefault(), updateAdvancedTaskFromPanelImproved( e, t ) } ) ) } function canMoveTask( e ) { return e.priority > 2 } function changeTaskStateDirect( e, t, a ) { const n = tasks[ e ]?.find( ( e => e.id === t ) ); if ( !n ) return; const s = n.state || "pending"; if ( s === a ) return; if ( "completed" === s && "completed" !== a && !confirm( "¿Estás seguro de que quieres cambiar una tarea completada?" ) ) { const e = document.querySelector( `select[onchange*="${t}"]` ); return void ( e && ( e.value = s ) ) } n.state = a, n.completed = "completed" === n.state; let i = "stateChanged"; if ( "inProgress" === s && "paused" === a ? i = "paused" : "paused" === s && "inProgress" === a && ( i = "resumed" ), addToChangeLog( i, n.title, e, s, a, t ), "completed" === n.state && clearTaskNotifications( t ), saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "upsert", e, n ), selectedDateForPanel === e ) { showDailyTaskPanel( e, new Date( e + "T12:00:00" ).getDate() ) } showNotification( `Tarea cambiada a: ${TASK_STATES[ n.state ].label}`, "success" ) } function updateAdvancedTaskFromPanelImproved( e, t ) { const a = document.getElementById( "advancedEditTaskTitle" ).value.trim(), n = document.getElementById( "advancedEditTaskDescription" ).value.trim(), s = document.getElementById( "advancedEditTaskTime" ).value, i = parseInt( document.getElementById( "advancedEditTaskPriority" ).value ); if ( !a || !s || !i ) return void showNotification( "Por favor completa todos los campos obligatorios", "error" ); if ( !tasks[ e ] ) return void showNotification( "Error: No se encontró la fecha de la tarea", "error" ); const o = tasks[ e ].findIndex( ( e => e.id === t ) ); if ( -1 === o ) return void showNotification( "Error: No se encontró la tarea", "error" ); tasks[ e ][ o ]; const r = { ...tasks[ e ][ o ], title: a, description: n, time: s, priority: i }; if ( tasks[ e ][ o ] = r, addToChangeLog( "edited", a, e, null, null, t ), saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "upsert", e, r ), closeAllModals(), showNotification( "Tarea actualizada exitosamente", "success" ), selectedDateForPanel === e ) { showDailyTaskPanel( e, new Date( e + "T12:00:00" ).getDate() ) } } function quickEditTaskAdvanced( e, t ) { const a = tasks[ e ]?.find( ( e => e.id === t ) ); if ( !a ) return void showNotification( "Tarea no encontrada", "error" ); if ( isDatePast( e ) ) return void showNotification( "No puedes editar tareas de fechas pasadas", "error" ); closeAllModals(); const n = document.createElement( "div" ); n.id = "quickEditModal", n.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4", n.innerHTML = `\n        <div class="bg-white rounded-lg p-4 max-w-sm w-full">\n            <h4 class="font-medium mb-3"><i class="fas fa-edit text-blue-500 mr-2"></i>Edición Rápida</h4>\n            <form id="quickEditForm" class="space-y-3">\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Título <span class="text-red-500">*</span></label>\n                    <input type="text" id="quickEditTitle" value="${a.title}" required\n                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>\n                    <textarea id="quickEditDescription" rows="3" \n                              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">${a.description || ""}</textarea>\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Hora <span class="text-red-500">*</span></label>\n                    <input type="time" id="quickEditTime" value="${a.time || ""}" required\n                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Prioridad <span class="text-red-500">*</span></label>\n                    <select id="quickEditPriority" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                        <option value="" disabled>Selecciona una prioridad</option>\n                        <option value="1" ${1 === a.priority ? "selected" : ""}>🔴 Muy Importante</option>\n                        <option value="2" ${2 === a.priority ? "selected" : ""}>🟠 Importante</option>\n                        <option value="3" ${3 === a.priority ? "selected" : ""}>🔵 Moderado</option>\n                        <option value="4" ${4 === a.priority ? "selected" : ""}>⚫ No Prioritario</option>\n                    </select>\n                </div>\n                <div class="flex space-x-2">\n                    <button type="submit" class="flex-1 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-700 transition">\n                        <i class="fas fa-save mr-2"></i>Guardar\n                    </button>\n                    <button type="button" onclick="closeAllModals()" \n                            class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition">\n                        Cancelar\n                    </button>\n                </div>\n            </form>\n        </div>\n    `, document.body.appendChild( n ), document.getElementById( "quickEditForm" ).addEventListener( "submit", ( a => { a.preventDefault(), saveQuickEditImproved( e, t ) } ) ) } function saveQuickEditImproved( e, t ) { const a = tasks[ e ]?.find( ( e => e.id === t ) ); if ( !a ) return void showNotification( "Error: No se encontró la tarea", "error" ); const n = document.getElementById( "quickEditTitle" ).value.trim(), s = document.getElementById( "quickEditDescription" ).value.trim(), i = document.getElementById( "quickEditTime" ).value, o = parseInt( document.getElementById( "quickEditPriority" ).value ); if ( n && i && o ) { if ( a.title = n, a.description = s, a.time = i, a.priority = o, saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "upsert", e, a ), closeAllModals(), showNotification( "Tarea actualizada exitosamente", "success" ), selectedDateForPanel === e ) { showDailyTaskPanel( e, new Date( e + "T12:00:00" ).getDate() ) } } else showNotification( "Por favor completa todos los campos obligatorios", "error" ) } function addQuickTaskToSelectedDay() { selectedDateForPanel && ( isDatePast( selectedDateForPanel ) ? showNotification( "No puedes agregar tareas a fechas anteriores", "error" ) : showQuickAddTask( selectedDateForPanel ) ) } function closeDailyTaskPanel() { const e = document.getElementById( "dailyTaskPanel" ); e && ( e.classList.add( "hidden" ), selectedDateForPanel = null ) } function quickDeleteTask( e, t ) { const a = tasks[ e ]?.find( ( e => e.id === t ) ); a && confirm( `¿Eliminar la tarea "${a.title}"?` ) && deleteTaskWithUndoImproved( e, t ) } function showQuickAddTask( e ) { if ( isDatePast( e ) ) return void showNotification( "No puedes agregar tareas a fechas anteriores", "error" ); closeAllModals(); const t = document.createElement( "div" ); t.id = "quickAddTaskModal", t.className = "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4", t.innerHTML = '\n        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">\n            <div class="flex justify-between items-center mb-4">\n                <h3 class="text-lg font-semibold text-gray-800">\n                    <i class="fas fa-plus text-blue-500 mr-2"></i>Agregar Nueva Tarea\n                </h3>\n                <button onclick="closeAllModals()" class="text-gray-500 hover:text-gray-700 transition">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <form id="quickAddTaskForm" class="space-y-4">\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Título <span class="text-red-500">*</span></label>\n                    <input type="text" id="quickAddTaskTitle" required \n                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                </div>\n                <div>\n                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>\n                    <textarea id="quickAddTaskDescription" rows="3" \n                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>\n                </div>\n                <div class="grid grid-cols-2 gap-4">\n                    <div>\n                        <label class="block text-sm font-medium text-gray-700 mb-2">Hora <span class="text-red-500">*</span></label>\n                        <input type="time" id="quickAddTaskTime" required\n                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                    </div>\n                    <div>\n                        <label class="block text-sm font-medium text-gray-700 mb-2">Prioridad <span class="text-red-500">*</span></label>\n                        <select id="quickAddTaskPriority" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">\n                            <option value="" disabled selected>Selecciona una prioridad</option>\n                            <option value="1">🔴 Muy Importante</option>\n                            <option value="2">🟠 Importante</option>\n                            <option value="3">🔵 Moderado</option>\n                            <option value="4">⚫ No Prioritario</option>\n                        </select>\n                    </div>\n                </div>\n                <div class="flex space-x-3 pt-4 border-t">\n                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition">\n                        <i class="fas fa-save mr-2"></i>Agregar Tarea\n                    </button>\n                    <button type="button" onclick="closeAllModals()" \n                            class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition">\n                        Cancelar\n                    </button>\n                </div>\n            </form>\n        </div>\n    ', document.body.appendChild( t ); const a = new Date; document.getElementById( "quickAddTaskTime" ).value = a.toTimeString().slice( 0, 5 ), document.getElementById( "quickAddTaskForm" ).addEventListener( "submit", ( t => { t.preventDefault(); const a = document.getElementById( "quickAddTaskTitle" ).value.trim(), n = document.getElementById( "quickAddTaskDescription" ).value.trim(), s = document.getElementById( "quickAddTaskTime" ).value, i = parseInt( document.getElementById( "quickAddTaskPriority" ).value ); if ( !a || !s || !i ) return void showNotification( "Por favor completa todos los campos obligatorios", "error" ); const o = { id: `${e}-${Date.now()}`, title: a, description: n, time: s, priority: i, state: "pending", completed: !1 }; if ( addTaskToDate( e, o ), saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "upsert", e, o ), closeAllModals(), showNotification( "Tarea agregada exitosamente", "success" ), selectedDateForPanel === e ) { const t = new Date( e + "T12:00:00" ).getDate(); showDailyTaskPanel( e, t ) } } ) ) } function closeAllModals() { [ "advancedEditModal", "quickEditModal", "quickAddTaskModal", "editTaskModal", "taskModal" ].forEach( ( e => { const t = document.getElementById( e ); t && t.remove() } ) ), document.querySelectorAll( ".fixed.inset-0.bg-black.bg-opacity-50" ).forEach( ( e => { e.remove() } ) ) } function setupTaskTooltips() { let e = createTaskTooltip(); document.addEventListener( "mouseover", ( function ( t ) { if ( t.target.classList.contains( "task-item" ) ) { const a = t.target.dataset.taskId, n = t.target.dataset.date, s = tasks[ n ]?.find( ( e => e.id === a ) ); s && showTooltip( e, t.target, s ) } } ) ), document.addEventListener( "mouseout", ( function ( t ) { t.target.classList.contains( "task-item" ) && e.classList.add( "opacity-0" ) } ) ) } function createTaskTooltip() { const e = document.createElement( "div" ); return e.id = "task-tooltip", e.className = "fixed bg-gray-800 text-white text-xs rounded px-2 py-1 z-50 pointer-events-none opacity-0 transition-opacity duration-200 max-w-xs", document.body.appendChild( e ), e } function showTooltip( e, t, a ) { const n = t.getBoundingClientRect(); e.innerHTML = `\n        <div class="font-semibold">${a.title}</div>\n        ${a.description ? `<div class="text-gray-300">${a.description}</div>` : ""}\n        ${a.time ? `<div class="text-blue-300"><i class="far fa-clock mr-1"></i>${a.time}</div>` : ""}\n        <div class="text-gray-400 text-xs mt-1">\n            ${a.completed ? "✓ Completada" : "Pendiente"} • Arrastra para mover\n        </div>\n    `, e.style.left = Math.min( n.left, window.innerWidth - e.offsetWidth - 10 ) + "px", e.style.top = n.top - e.offsetHeight - 5 + "px", e.classList.remove( "opacity-0" ) } function setupDragAndDrop() { const e = document.getElementById( "calendar" ); e && ( e.addEventListener( "dragstart", handleDragStart ), e.addEventListener( "dragend", handleDragEnd ), e.addEventListener( "dragover", handleDragOver ), e.addEventListener( "dragleave", handleDragLeave ), e.addEventListener( "drop", handleDrop ) ) } function handleDragStart( e ) { e.target.classList.contains( "task-item" ) && ( e.stopPropagation(), draggedTask = e.target.dataset.taskId, draggedFromDate = e.target.dataset.date, e.target.style.opacity = "0.5" ) } function handleDragEnd( e ) { e.target.classList.contains( "task-item" ) && ( e.target.style.opacity = "1", draggedTask = null, draggedFromDate = null ) } function handleDragOver( e ) { e.preventDefault(); const t = e.target.closest( ".calendar-day" ); t && t.classList.add( "bg-yellow-100" ) } function handleDragLeave( e ) { const t = e.target.closest( ".calendar-day" ); t && t.classList.remove( "bg-yellow-100" ) } function handleDrop( e ) { e.preventDefault(); const t = e.target.closest( ".calendar-day" ); if ( t && draggedTask && draggedFromDate ) { const e = t.dataset.date; if ( isDatePast( e ) ) return showNotification( "No puedes mover tareas a fechas anteriores", "error" ), void document.querySelectorAll( ".bg-yellow-100" ).forEach( ( e => { e.classList.remove( "bg-yellow-100" ) } ) ); const a = tasks[ draggedFromDate ]?.find( ( e => e.id === draggedTask ) ); if ( a && !canMoveTask( a ) ) { return showNotification( `Las tareas "${( PRIORITY_LEVELS[ a.priority ] || PRIORITY_LEVELS[ 3 ] ).label}" no se pueden mover. Solo se pueden editar o eliminar.`, "error" ), void document.querySelectorAll( ".bg-yellow-100" ).forEach( ( e => { e.classList.remove( "bg-yellow-100" ) } ) ) } e !== draggedFromDate && ( moveTask( draggedFromDate, e, draggedTask ), showNotification( "Tarea movida exitosamente", "success" ) ) } document.querySelectorAll( ".bg-yellow-100" ).forEach( ( e => { e.classList.remove( "bg-yellow-100" ) } ) ) } function handleDragStart( e ) { if ( e.target.classList.contains( "task-item" ) ) { e.stopPropagation(), draggedTask = e.target.dataset.taskId, draggedFromDate = e.target.dataset.date; const t = tasks[ draggedFromDate ]?.find( ( e => e.id === draggedTask ) ); if ( t && !canMoveTask( t ) ) { e.target.style.opacity = "0.3", e.target.style.cursor = "not-allowed"; const t = document.createElement( "div" ); t.className = "fixed bg-red-600 text-white text-xs px-2 py-1 rounded z-50 pointer-events-none", t.textContent = "Esta tarea no se puede mover"; const a = e.target.getBoundingClientRect(); t.style.left = a.left + "px", t.style.top = a.top - 30 + "px", document.body.appendChild( t ), setTimeout( ( () => t.remove() ), 2e3 ) } else e.target.style.opacity = "0.5" } } function moveTask( e, t, a ) { const n = tasks[ e ], s = n?.findIndex( ( e => e.id === a ) ); if ( -1 !== s ) { const i = n.splice( s, 1 )[ 0 ], o = i.title; 0 === n.length && delete tasks[ e ], tasks[ t ] || ( tasks[ t ] = [] ), i.id = `${t}-${Date.now()}`, tasks[ t ].push( i ), addToChangeLog( "moved", o, t, e, t ), saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "delete", e, { id: a } ), enqueueSync( "upsert", t, i ) } } function deleteTaskWithUndoImproved( e, t ) { const a = tasks[ e ], n = a?.findIndex( ( e => e.id === t ) ); if ( -1 !== n ) { const s = a[ n ]; lastDeletedTask = { ...s }, lastDeletedDate = e, currentUser && isOnline && ( enqueueSync( "delete", e, { id: t } ), setTimeout( ( () => { syncQueue.size > 0 && processSyncQueue() } ), 100 ) ), addToChangeLog( "deleted", s.title, e, null, null, t ), clearTaskNotifications( t ), tasks[ e ] = tasks[ e ].filter( ( e => e.id !== t ) ), 0 === tasks[ e ].length && delete tasks[ e ], saveTasks(), saveTaskLogs(), renderCalendar(), updateProgress(), showUndoNotification() } } function saveTaskLogs() { try { localStorage.setItem( "dailyTaskLogs", JSON.stringify( dailyTaskLogs ) ) } catch ( e ) { } } function loadTaskLogs() { try { const e = localStorage.getItem( "dailyTaskLogs" ); dailyTaskLogs = e ? JSON.parse( e ) : {} } catch ( e ) { dailyTaskLogs = {} } } function showUndoNotification() { const e = document.createElement( "div" ); e.className = "fixed bottom-4 left-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-3", e.innerHTML = '\n        <span>Tarea eliminada</span>\n        <button onclick="undoDelete()" class="bg-blue-500 px-3 py-1 rounded text-sm hover:bg-blue-600 transition">\n            Deshacer\n        </button>\n        <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-white">\n            <i class="fas fa-times"></i>\n        </button>\n    ', document.body.appendChild( e ), setTimeout( ( () => e.remove() ), 5e3 ) } function undoDelete() { lastDeletedTask && lastDeletedDate && ( tasks[ lastDeletedDate ] || ( tasks[ lastDeletedDate ] = [] ), tasks[ lastDeletedDate ].push( lastDeletedTask ), enqueueSync( "upsert", lastDeletedDate, lastDeletedTask ), saveTasks(), renderCalendar(), updateProgress(), lastDeletedTask = null, lastDeletedDate = null, showNotification( "Tarea restaurada exitosamente", "success" ), document.querySelector( ".fixed.bottom-4.left-4" )?.remove() ) } function changeMonth( e ) { currentDate.setMonth( currentDate.getMonth() + e ), renderCalendar(), updateProgress() } function clearWeek() { if ( !confirm( "¿Estás seguro de que quieres limpiar todas las tareas de esta semana?" ) ) return; const e = new Date, t = new Date( e ); t.setDate( e.getDate() - e.getDay() ); const a = new Date( t ); a.setDate( t.getDate() + 6 ); const n = []; for ( let e = 0; e < 7; e++ ) { const a = new Date( t ); a.setDate( t.getDate() + e ); const s = a.toISOString().split( "T" )[ 0 ]; tasks[ s ] && ( tasks[ s ].forEach( ( e => { n.push( { dateStr: s, taskId: e.id } ), clearTaskNotifications( e.id ) } ) ), delete tasks[ s ] ) } if ( n.forEach( ( ( { dateStr: e, taskId: t } ) => { enqueueSync( "delete", e, { id: t } ) } ) ), saveTasks(), renderCalendar(), updateProgress(), showNotification( "Semana limpiada exitosamente" ), selectedDateForPanel ) { const e = new Date( selectedDateForPanel + "T00:00:00" ); if ( e >= t && e <= a ) { const e = document.getElementById( "panelTaskList" ); e && ( e.innerHTML = '\n          <div class="text-center py-8 text-gray-500">\n            <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n            <p>No hay tareas para este día</p>\n            <p class="text-sm mt-2">¡Todas las tareas de la semana fueron eliminadas!</p>\n          </div>\n        ' ), updatePanelProgress( [] ), closeDailyTaskPanel() } } } function clearMonth() { if ( !confirm( "¿Estás seguro de que quieres limpiar todas las tareas de este mes?" ) ) return; const e = currentDate.getFullYear(), t = currentDate.getMonth(), a = []; if ( Object.keys( tasks ).forEach( ( n => { const s = new Date( n + "T12:00:00" ); s.getFullYear() === e && s.getMonth() === t && ( tasks[ n ].forEach( ( e => { a.push( { dateStr: n, taskId: e.id } ), clearTaskNotifications( e.id ) } ) ), delete tasks[ n ] ) } ) ), a.forEach( ( ( { dateStr: e, taskId: t } ) => { enqueueSync( "delete", e, { id: t } ) } ) ), saveTasks(), renderCalendar(), updateProgress(), showNotification( "Mes limpiado exitosamente" ), selectedDateForPanel ) { const a = new Date( selectedDateForPanel + "T12:00:00" ); if ( a.getFullYear() === e && a.getMonth() === t ) { const e = document.getElementById( "panelTaskList" ); e && ( e.innerHTML = '\n          <div class="text-center py-8 text-gray-500">\n            <i class="fas fa-calendar-plus text-4xl mb-3 opacity-50"></i>\n            <p>No hay tareas para este día</p>\n            <p class="text-sm mt-2">¡Todas las tareas del mes fueron eliminadas!</p>\n          </div>\n        ' ), updatePanelProgress( [] ), closeDailyTaskPanel() } } } function updateProgress() { const e = getTodayString(), t = tasks[ e ] || [], a = t.filter( ( e => "completed" === e.state ) ).length, n = t.filter( ( e => "inProgress" === e.state ) ).length, s = t.filter( ( e => "paused" === e.state ) ).length, i = t.filter( ( e => "pending" === e.state ) ).length, o = 0 === t.length ? 0 : Math.round( a / t.length * 100 ), r = document.getElementById( "progressBar" ), d = document.getElementById( "progressText" ); r && ( r.style.width = `${o}%` ), d && ( d.innerHTML = `\n            ${o}% | \n            <span class="text-green-600">${a} ✓</span> \n            <span class="text-blue-600">${n} ▶</span> \n            <span class="text-orange-600">${s} ⏸</span>\n            <span class="text-gray-600">${i} ⏸</span>\n        ` ) } function exportToExcel() { if ( "undefined" == typeof XLSX ) return void showNotification( "Error: XLSX library not loaded", "error" ); const e = XLSX.utils.book_new(), t = [ [ "Fecha", "Título", "Descripción", "Hora", "Completada" ] ]; Object.entries( tasks ).forEach( ( ( [ e, a ] ) => { a.forEach( ( a => { t.push( [ e, a.title, a.description || "", a.time || "", a.completed ? "Sí" : "No" ] ) } ) ) } ) ); const a = XLSX.utils.aoa_to_sheet( t ); XLSX.utils.book_append_sheet( e, a, "Tareas" ), XLSX.writeFile( e, `tareas_${getTodayString()}.xlsx` ), showNotification( "Excel exportado exitosamente" ) } function toggleNotifications() { "Notification" in window ? "granted" === Notification.permission ? ( notificationsEnabled = !notificationsEnabled, savePermissions(), updateNotificationButton(), notificationsEnabled ? ( "vibrate" in navigator && navigator.vibrate( getVibrationPattern( "success" ) ), startNotificationService(), showNotification( "Notificaciones activadas", "success" ) ) : ( stopNotificationService(), showNotification( "Notificaciones desactivadas", "info" ) ) ) : "default" === Notification.permission ? requestNotificationPermissionWithVibration() : showNotification( "Los permisos fueron denegados. Actívalos en configuración del navegador.", "error" ) : showNotification( "Este navegador no soporta notificaciones", "error" ) } function requestNotificationPermissionWithVibration() { return "Notification" in window ? ( "vibrate" in navigator && navigator.vibrate( [ 100, 50, 100 ] ), Notification.requestPermission().then( ( e => ( notificationsEnabled = "granted" === e, savePermissions(), updateNotificationButton(), "granted" === e ? ( startNotificationService(), "vibrate" in navigator && navigator.vibrate( getVibrationPattern( "success" ) ), showNotification( "Notificaciones activadas correctamente", "success" ), setTimeout( ( () => { showDesktopNotificationPWA( "¡Notificaciones activadas!", "Recibirás recordatorios de tus tareas", "welcome", !1, "success" ) } ), 1e3 ) ) : showNotification( "Permisos de notificación denegados", "error" ), e ) ) ) ) : ( showNotification( "Este navegador no soporta notificaciones", "error" ), Promise.resolve( "denied" ) ) } function startNotificationService() { notificationInterval && ( clearInterval( notificationInterval ), notificationInterval = null ), notificationsEnabled && "granted" === Notification.permission && ( setTimeout( ( () => { try { checkDailyTasksImproved() } catch ( e ) { } } ), 1e3 ), notificationInterval = setInterval( ( () => { try { notificationsEnabled && "granted" === Notification.permission ? checkDailyTasksImproved() : stopNotificationService() } catch ( e ) { } } ), 3e4 ), setInterval( ( () => { notificationsEnabled && "granted" === Notification.permission && checkDailyTasksImproved( !0 ) } ), 3e5 ) ) } function stopNotificationService() { notificationInterval && ( clearInterval( notificationInterval ), notificationInterval = null ) } function updateNotificationButton() { const e = document.getElementById( "notificationsBtn" ); if ( !e ) return; const t = "granted" === Notification.permission, a = "text-white px-3 py-2 rounded-lg transition duration-300 text-xs md:text-sm font-normal md:font-bold"; notificationsEnabled && t ? ( e.className = `bg-green-500 hover:bg-green-600 ${a}`, e.innerHTML = '<i class="fas fa-bell mr-2"></i>Notificaciones ON', e.title = "Notificaciones activadas - Click para desactivar" ) : t ? ( e.className = `bg-gray-500 hover:bg-gray-600 ${a}`, e.innerHTML = '<i class="fas fa-bell-slash mr-2"></i>Notificaciones OFF', e.title = "Notificaciones desactivadas - Click para activar" ) : ( e.className = `bg-yellow-500 hover:bg-yellow-600 ${a}`, e.innerHTML = '<i class="fas fa-bell mr-2"></i>Permitir Notificaciones', e.title = "Click para solicitar permisos de notificación" ) } function checkDailyTasksImproved( e = !1 ) { if ( !notificationsEnabled || "granted" !== Notification.permission ) return; const t = new Date, a = getTodayString(), n = t.getHours(), s = t.getMinutes(), i = tasks[ a ] || [], o = i.filter( ( e => "pending" === e.state ) ), r = i.filter( ( e => "inProgress" === e.state ) ), d = `${a}-reset`; !sentNotifications.has( d ) && 0 === n && s <= 1 && ( notificationStatus.morning = !1, notificationStatus.midday = !1, notificationStatus.evening = !1, notificationStatus.taskReminders.clear(), sentNotifications.clear(), sentNotifications.add( d ) ), i.forEach( ( e => { if ( !e.time || "completed" === e.state ) return; const [ t, i ] = e.time.split( ":" ).map( Number ), o = 60 * t + i, r = 60 * n + s, d = `${e.id}-15min`; if ( !notificationStatus.taskReminders.has( d ) && r >= o - 15 && r <= o - 13 && "pending" === e.state ) { const t = PRIORITY_LEVELS[ e.priority ] || PRIORITY_LEVELS[ 3 ]; showDesktopNotificationPWA( `⏰ ${e.title}`, `${t.label} en 15 minutos (${e.time})`, d, !1, "task-reminder" ), notificationStatus.taskReminders.add( d ) } const l = `${e.id}-start`; if ( !notificationStatus.taskReminders.has( l ) && r >= o && r <= o + 2 && "pending" === e.state ) { e.state = "inProgress", e.completed = !1, addToChangeLog( "autoStarted", e.title, a, "pending", "inProgress", e.id ), saveTasks(), renderCalendar(), updateProgress(), enqueueSync( "upsert", a, e ); const t = PRIORITY_LEVELS[ e.priority ] || PRIORITY_LEVELS[ 3 ]; showDesktopNotificationPWA( `🚀 ${e.title}`, `Iniciada automáticamente - ${t.label}`, l, !0, "task-start" ), showInAppNotification( "Tarea Iniciada", `${e.title} cambió a "En Proceso"`, "task" ), notificationStatus.taskReminders.add( l ), selectedDateForPanel === a && showDailyTaskPanel( a, new Date( a + "T12:00:00" ).getDate() ) } const c = `${e.id}-late`; !notificationStatus.taskReminders.has( c ) && r >= o + 30 && "completed" !== e.state && ( showDesktopNotificationPWA( `⚠️ ${e.title}`, "inProgress" === e.state ? "Aún en proceso" : "No iniciada - Retrasada", c, !1, "task-late" ), notificationStatus.taskReminders.add( c ) ) } ) ); const l = o.length, c = r.length, u = l + c; if ( !notificationStatus.morning && 9 === n && s <= 30 && u > 0 ) { let e = ""; l > 0 && ( e += `${l} pendiente${l > 1 ? "s" : ""}` ), c > 0 && ( e && ( e += " y " ), e += `${c} en proceso` ), showDesktopNotificationPWA( "Buenos días", `Tienes ${e} para hoy`, "morning", !1, "morning" ), notificationStatus.morning = !0 } !notificationStatus.midday && 12 === n && s <= 30 && l > 0 && ( showDesktopNotificationPWA( "Mediodía", `${l} tarea${l > 1 ? "s" : ""} pendiente${l > 1 ? "s" : ""}`, "midday", !1, "midday" ), notificationStatus.midday = !0 ), !notificationStatus.evening && 18 === n && s <= 30 && u > 0 && ( showDesktopNotificationPWA( "Final del día", `${u} tarea${u > 1 ? "s" : ""} sin completar`, "evening", !1, "evening" ), notificationStatus.evening = !0 ) } function clearTaskNotifications( e ) { [ `${e}-15min`, `${e}-start`, `${e}-late` ].forEach( ( e => { notificationStatus.taskReminders.delete( e ), sentNotifications.delete( e ) } ) ) } function showNotification( e, t = "success" ) { const a = document.createElement( "div" ), n = { success: "bg-green-500 text-white fa-check-circle", error: "bg-red-500 text-white fa-exclamation-circle", info: "bg-blue-500 text-white fa-info-circle" }, { className: s, icon: i } = t in n ? { className: n[ t ].split( " " ).slice( 0, -1 ).join( " " ), icon: n[ t ].split( " " ).pop() } : { className: "bg-blue-500 text-white", icon: "fa-info-circle" }; a.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${s}`, a.innerHTML = `\n        <div class="flex items-center space-x-2">\n            <i class="fas ${i}"></i>\n            <span>${e}</span>\n        </div>\n    `, document.body.appendChild( a ), setTimeout( ( () => a.classList.remove( "translate-x-full" ) ), 100 ), setTimeout( ( () => { a.classList.add( "translate-x-full" ), setTimeout( ( () => a.remove() ), 300 ) } ), 3e3 ) } function saveTasks() { try { localStorage.setItem( "tasks", JSON.stringify( tasks ) ), localStorage.setItem( "dailyTaskLogs", JSON.stringify( dailyTaskLogs ) ) } catch ( e ) { showNotification( "Error al guardar tareas", "error" ) } } function clearAll() { const e = Object.values( tasks ).reduce( ( ( e, t ) => e + t.length ), 0 ); if ( 0 === e ) return void showNotification( "No hay tareas para eliminar", "info" ); if ( !confirm( `¿Estás seguro de que quieres eliminar TODAS las tareas del calendario? (${e} tareas)` ) ) return; if ( !confirm( "⚠️ ESTA ACCIÓN NO SE PUEDE DESHACER. ¿Continuar?" ) ) return; const t = []; Object.entries( tasks ).forEach( ( ( [ e, a ] ) => { a.forEach( ( a => { t.push( { dateStr: e, taskId: a.id } ), clearTaskNotifications( a.id ) } ) ) } ) ), tasks = {}, saveTasks(), renderCalendar(), updateProgress(), closeDailyTaskPanel(), notificationStatus.taskReminders.clear(), notificationStatus.morning = !1, notificationStatus.midday = !1, notificationStatus.evening = !1, sentNotifications.clear(), t.forEach( ( ( { dateStr: e, taskId: t } ) => { enqueueSync( "delete", e, { id: t } ) } ) ), showNotification( `${e} tareas eliminadas del calendario`, "success" ) } window.addEventListener( "appinstalled", ( () => { const e = document.getElementById( "install-button" ); e && ( e.style.display = "none", e.classList.add( "hidden" ) ), installButtonShown = !1, deferredPrompt = null, showNotification( "Aplicación instalada correctamente", "success" ) } ) ), "complete" !== document.readyState && "interactive" !== document.readyState || setupEventListeners(), setInterval( ( () => { currentUser && isOnline && !isSyncing && ( 0 === syncQueue.size ? syncFromFirebase() : processSyncQueue() ) } ), 6e5 ), window.addEventListener( "beforeunload", ( () => { syncQueue.size > 0 && currentUser && isOnline && navigator.sendBeacon && navigator.sendBeacon( "/sync-beacon", JSON.stringify( { uid: currentUser.uid, operations: Array.from( syncQueue.values() ) } ) ) } ) ), document.addEventListener( "visibilitychange", ( () => { !document.hidden && syncQueue.size > 0 && currentUser && isOnline && setTimeout( ( () => processSyncQueue() ), 1e3 ) } ) ), document.addEventListener( "DOMContentLoaded", ( function () { isOnline = navigator.onLine, setupNetworkListeners(), loadTasks(), loadPermissions(), renderCalendar(), updateProgress(), setupEventListeners(), setupDragAndDrop(), setupTaskTooltips(), setupDateInput(), initNotifications(), isOnline ? initFirebase() : ( currentUser = { isOffline: !0 }, updateUI(), hideLoadingScreen() ), setTimeout( ( () => { if ( handleServiceWorkerMessages(), initializeTodayPanel(), isPWAInstalled() ) { configurePWAFeatures(); const e = document.getElementById( "install-button" ); e && ( e.style.display = "none", e.classList.add( "hidden" ) ) } } ), 100 ) } ) );
